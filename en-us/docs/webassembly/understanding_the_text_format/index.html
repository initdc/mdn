<!DOCTYPE html><html lang="en-US" prefix="og: https://ogp.me/ns#"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon-48x48.97046865.png"><link rel="apple-touch-icon" href="/apple-touch-icon.0ea0fa02.png"><meta name="theme-color" content="#ffffff"><link rel="manifest" href="/manifest.56b1cedc.json"><link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="MDN Web Docs"><script>Array.prototype.flat&&Array.prototype.includes||document.write('<script src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.flat%2Ces6"><\/script>')</script><title>Understanding WebAssembly text format - WebAssembly | MDN</title><link rel="preload" as="font" type="font/woff2" crossorigin="" href="/static/media/ZillaSlab-Bold.subset.0beac26b.woff2"><link rel="alternate" title="Understanding WebAssembly text format" href="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format" hreflang="en"><link rel="alternate" title="ÁêÜËß£ WebAssembly ÊñáÊú¨Ê†ºÂºè" href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/Understanding_the_text_format" hreflang="zh"><link rel="alternate" title="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ WebAssembly" href="https://developer.mozilla.org/ru/docs/WebAssembly/Understanding_the_text_format" hreflang="ru"><link rel="alternate" title="Entendendo o formato textual do WebAssembly" href="https://developer.mozilla.org/pt-BR/docs/WebAssembly/Understanding_the_text_format" hreflang="pt"><link rel="alternate" title="Understanding WebAssembly text format" href="https://developer.mozilla.org/ko/docs/WebAssembly/Understanding_the_text_format" hreflang="ko"><link rel="alternate" title="WebAssembly „ÉÜ„Ç≠„Çπ„ÉàÂΩ¢Âºè„ÅÆÁêÜËß£" href="https://developer.mozilla.org/ja/docs/WebAssembly/Understanding_the_text_format" hreflang="ja"><meta name="description" content="This finishes our high-level tour of the major components of the WebAssembly text format and how they get reflected in the WebAssembly JS API."><meta property="og:url" content="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format"><meta property="og:title" content="Understanding WebAssembly text format - WebAssembly | MDN"><meta property="og:description" content="This finishes our high-level tour of the major components of the WebAssembly text format and how they get reflected in the WebAssembly JS API."><meta property="og:locale" content="en-US"><meta property="og:image" content="https://developer.mozilla.org/mdn-social-share.0ca9dbda.png"><meta property="twitter:card" content="summary_large_image"><meta name="robots" content="index, follow"><link rel="canonical" href="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format"><style media="print">.breadcrumbs-container,.document-toc-container,.language-menu,.language-toggle,.on-github,.page-footer,.page-header-main,nav.sidebar,ul.prev-next{display:none!important}.main-page-content,.main-page-content pre{padding:2px}.main-page-content pre{border-left-width:2px}</style><link href="/static/css/main.55b68e13.chunk.css" rel="stylesheet"><script src="/static/js/runtime-main.4bb4c356.js" defer=""></script><script src="/static/js/4.a756dea3.chunk.js" defer=""></script><script src="/static/js/main.d4d565e0.chunk.js" defer=""></script></head><body><div id="root"><ul id="nav-access" class="a11y-nav"><li><a id="skip-main" href="#content">Skip to main content</a></li><li><a id="skip-search" href="#main-q">Skip to search</a></li><li><a id="skip-select-language" href="#select-language">Skip to select language</a></li></ul><div class="page-wrapper document-page"><header class="page-header"><a href="/en-US/" class="logo" aria-label="MDN Web Docs"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 451.74 135"><path d="M7.14 8.35v111.06h111.05V8.35zm103.71 56c-.48.92-1 1.79-1.46 2.71a3.44 3.44 0 01-3.54 2 2.4 2.4 0 00-1.55.5c-1.37.9-2.76 1.79-4.18 2.63a7.33 7.33 0 01-6.35.34 29.71 29.71 0 00-10.63-2 11.7 11.7 0 00-9.46 4.31 14.84 14.84 0 00-2.13 4.29c-1.24 3.07-2.3 21.38-2.3 26.05 0 0-17.62-3.42-34.15-20.34l4.31-11.32h-13.5l9.76-10.35h-16.8l9.77-10.34H12.69L30.45 34a40.9 40.9 0 0119.77-10.83c7.1-1.22 8.93-.53 13.31.77l2.43.73.85.25 3.1.95a12.56 12.56 0 006.21.09 11.37 11.37 0 018.25 1 8.24 8.24 0 014.1 6.22 7.29 7.29 0 003.61 5.49 59.45 59.45 0 009.32 4.11c2.27.86 4.54 1.84 6.79 2.72a6.81 6.81 0 012.86 2.06 4.81 4.81 0 011.1 2.73c.14 2 .37 4 .47 6a15.24 15.24 0 01-1.77 8.03zM320.12 39.62a5.42 5.42 0 00-4.53 2.13 7.36 7.36 0 00-1.7 4.43v2.36a6.28 6.28 0 001.7 4.46 5.63 5.63 0 004.3 1.82 5.12 5.12 0 004.57-2.27A9.7 9.7 0 00326 47a8.11 8.11 0 00-1.67-5.52 5.36 5.36 0 00-4.21-1.86zM387.38 39.53a5.52 5.52 0 00-4.7 2.15 8.8 8.8 0 00-1.63 5.49 9.23 9.23 0 001.58 5.45 5.38 5.38 0 004.7 2.25 5.61 5.61 0 004.74-2.2 8.91 8.91 0 001.68-5.59 8.24 8.24 0 00-1.75-5.52 5.76 5.76 0 00-4.62-2.03zM299.47 41.35a4.34 4.34 0 00-4-1.92 4.55 4.55 0 00-3.89 1.73 8.37 8.37 0 00-1.58 4.17h10.48a6.3 6.3 0 00-1.01-3.98zM357.74 30.75H352v23.31h5.72q5.47 0 8.35-3t2.93-8.65q0-5.43-2.88-8.55t-8.38-3.11z"></path><path d="M121.55 8.35v70.8h323V8.35zm42.21 22.45h-4V54h3.68v3.73h-11.25V54h3.31V36.79h-.19l-9.63 19.12h-2.12l-10-19.4h-.19V54h3.45v3.73h-11.15V54h3.68V30.8h-4v-3.73H133l11.66 22.56h.19l11.18-22.56h7.7zm29.12 22.67q-4.11 4.28-11.38 4.28h-14.06v-3.69h3.73V30.75h-3.73v-3.68h13.83q7.59 0 11.66 4.29a15.4 15.4 0 014 11 15.33 15.33 0 01-4.05 11.11zm38.89-22.67h-3.68v27h-2.6L208.08 35h-.19v19h4.67v3.73h-12.22V54h3.49V30.8h-4v-3.73h7.08l16.9 22.09h.19V30.8h-4.58v-3.73h12.32zm43.8 27h-3.31l-7.83-23.18h-.19l-7.55 23.18h-3.35l-8.78-27h-2.65v-3.73H253v3.73h-3.87L255 50.71h.23l6.61-19.91H259v-3.73h11v3.73h-2.78l6.61 20.1h.23l5.43-20.1h-4.15v-3.73h11v3.73h-2.54zm26.71-1.51a9.66 9.66 0 01-6.42 2 10.2 10.2 0 01-7.41-2.74c-1.89-1.82-2.83-4.47-2.83-7.93a12.37 12.37 0 012.64-8.12 9 9 0 017.32-3.21 8.62 8.62 0 016.75 2.69 9.65 9.65 0 012.45 6.52 13.67 13.67 0 01-.28 2.69H290q.29 6.71 6.18 6.7a5.2 5.2 0 003.71-1.18 5.82 5.82 0 001.67-2.83l3.45.71a7.21 7.21 0 01-2.73 4.65zm25.77-1.63c-1.51 2.4-3.92 3.61-7.22 3.61s-5.84-1.29-7.22-3.87c0 .25-.1.82-.21 1.7s-.19 1.44-.22 1.7H309c.16-1 .31-2 .47-3.07a21.42 21.42 0 00.24-3.16v-23h-3.4v-3.3h7.55V40.9a9.76 9.76 0 012.67-3.28 7.33 7.33 0 014.74-1.4 8.48 8.48 0 016.5 2.78q2.55 2.74 2.55 7.74a14.6 14.6 0 01-2.27 7.87zm41.39-1.14q-4.11 4.28-11.37 4.28H344v-3.74h3.73V30.75H344v-3.68h13.83q7.59 0 11.66 4.29a15.41 15.41 0 014.06 11 15.34 15.34 0 01-4.11 11.11zm25.65 1.68a10.53 10.53 0 01-7.9 3.07 10 10 0 01-7.63-3 10.93 10.93 0 01-2.8-7.83 12.13 12.13 0 012.69-7.93q2.69-3.3 8-3.3t8 3.28a12 12 0 012.64 7.76 10.86 10.86 0 01-3 7.9zm22.61.57c-1.4 1.66-3.63 2.5-6.68 2.5a9.58 9.58 0 01-7.15-2.76q-2.72-2.76-2.71-7.91a12.25 12.25 0 012.69-8 9.17 9.17 0 017.5-3.28 15 15 0 013.82.48 10.37 10.37 0 013.5 1.65l.85 5.47-3.35.38-.76-3.54a8.07 8.07 0 00-4.11-1 4.9 4.9 0 00-4.39 2.15 9.93 9.93 0 00-1.41 5.55 8.9 8.9 0 001.5 5.38 5.23 5.23 0 004.44 2c2.92 0 4.67-1.7 5.23-5.1l3.5.71a10.34 10.34 0 01-2.47 5.27zm20.48.75a11.68 11.68 0 01-6.63 1.75 15.52 15.52 0 01-8.26-2.08L424 51l3.26.33-.1 2.74a7 7 0 002.06.66 12.63 12.63 0 002.19.19 8.68 8.68 0 003.66-.75 2.5 2.5 0 001.63-2.36 2.25 2.25 0 00-1.32-2.2 12.65 12.65 0 00-3.28-1 47.39 47.39 0 01-3.9-.82 7.5 7.5 0 01-3.25-1.7 4.67 4.67 0 01-1.33-3.66c0-2.36.88-4 2.62-4.91a12 12 0 015.6-1.37 15 15 0 014.08.55 16.65 16.65 0 013.47 1.39l.47 5.1-3.3.37-.48-3.3a9.5 9.5 0 00-4.06-.9 5.62 5.62 0 00-2.87.66 2.33 2.33 0 00-1.15 2.25 2.13 2.13 0 001.3 2.07 11.91 11.91 0 003.21.92 36.69 36.69 0 013.82.83 7.46 7.46 0 013.21 1.74 4.9 4.9 0 011.3 3.73 5.56 5.56 0 01-2.66 4.91z"></path><path d="M181.17 30.75h-5.71v23.31h5.71q5.47 0 8.36-3t2.88-8.61q0-5.43-2.88-8.55t-8.36-3.15zM121.63 119.32V81.74h114.91v37.58zM153.22 109h-2v-6.85a4.8 4.8 0 00-1.58-4 5.57 5.57 0 00-3.55-1.26 5 5 0 00-4.92 3.26 4.19 4.19 0 00-1.88-2.46 5.82 5.82 0 00-3-.8 4.89 4.89 0 00-4.56 2.56v-2.21h-6.28v3.26h2v8.5h-2v3.23h9.11V109h-2.86v-5.25a4.4 4.4 0 01.69-2.56 2.47 2.47 0 012.21-1q2.57 0 2.56 3.63v8.41h6.29V109h-2v-5.25a4.47 4.47 0 01.67-2.56 2.42 2.42 0 012.19-1q2.63 0 2.63 3.63v8.41h6.28zm9.88-12.07q-4 0-6 2.36a8.41 8.41 0 00-2 5.66 7.25 7.25 0 002.17 5.62 8 8 0 005.65 2 8.54 8.54 0 005.94-2.11 7.27 7.27 0 002.34-5.67 8.21 8.21 0 00-2-5.51q-2.07-2.34-6.1-2.34zm-.1 12.35a3 3 0 01-2.63-1.33 5.68 5.68 0 01-.9-3.26 5 5 0 011-3.28 3.23 3.23 0 012.61-1.18 3.5 3.5 0 012.59 1.08 4.56 4.56 0 011.07 3.31 5.21 5.21 0 01-1 3.41 3.33 3.33 0 01-2.74 1.25zm25-2.3l-3.39-.29-.7 2.32H179l8.32-9.54-.32-2.23h-13.19l-.53 5.25 3.16.34.67-2.36h4.65l-8.25 9.53.44 2.26h13.13zm7.62-9.74h-4.46v5.39h4.46zm0 9.61h-4.46v5.39h4.46zm13.54-17.49h-4.23l-6.48 22.88h4.22zm8.68 0h-4.23l-6.45 22.88h4.19zm15 22.51l-.07-2.26a1.22 1.22 0 01-.56.1c-.69 0-1-.39-1-1.16v-6.49a4.39 4.39 0 00-1.8-3.84 7 7 0 00-4.16-1.28 14.55 14.55 0 00-3.16.3 24.14 24.14 0 00-3.29 1.06l-.56 3.46 3.39.4.5-1.69a2.78 2.78 0 011.08-.37 11.3 11.3 0 011.25-.07c1.19 0 1.89.37 2.09 1.1a8.55 8.55 0 01.3 2.26v.5a8.91 8.91 0 00-1.18-.11h-1.21a12.64 12.64 0 00-4.81.88 3.53 3.53 0 00-2.18 3.64 3.66 3.66 0 001.48 3.33 5.63 5.63 0 003.11 1 4.67 4.67 0 003-.91 6.78 6.78 0 001.8-2 3 3 0 003.33 3 5.54 5.54 0 002.66-.85zm-9.25-2.32a1.69 1.69 0 01-1.36-.52 1.81 1.81 0 01-.43-1.21 1.67 1.67 0 01.86-1.68 4.63 4.63 0 012-.42 7.69 7.69 0 011.07.07l1.06.13a3.58 3.58 0 01-1.08 2.74 3.24 3.24 0 01-2.11.89z"></path></svg></a><button type="button" class="ghost main-menu-toggle" aria-haspopup="true" aria-label="Show Menu"></button><div class="page-header-main "><nav class="main-nav" aria-label="Main menu"><ul class="main-menu nojs"><li class="top-level-entry-container"><button id="technologies-button" type="button" class="top-level-entry" aria-haspopup="menu" aria-expanded="false">Technologies</button><ul class="technologies " role="menu" aria-labelledby="technologies-button"><li role="none"><a tabindex="-1" href="/en-US/docs/Web" role="menuitem">Technologies Overview</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/HTML" role="menuitem">HTML</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/CSS" role="menuitem">CSS</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/JavaScript" role="menuitem">JavaScript</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/Guide/Graphics" role="menuitem">Graphics</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/HTTP" role="menuitem">HTTP</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/API" role="menuitem">APIs</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Mozilla/Add-ons/WebExtensions" role="menuitem">Browser Extensions</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/MathML" role="menuitem">MathML</a></li></ul></li><li class="top-level-entry-container"><button id="references-guides-button" type="button" class="top-level-entry" aria-haspopup="menu" aria-expanded="false">References &amp; Guides</button><ul class="references-guides " role="menu" aria-labelledby="references-guides-button"><li role="none"><a tabindex="-1" href="/en-US/docs/Learn" role="menuitem">Learn web development</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/Tutorials" role="menuitem">Tutorials</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/Reference" role="menuitem">References</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/Guide" role="menuitem">Developer Guides</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web/Accessibility" role="menuitem">Accessibility</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Games" role="menuitem">Game development</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/Web" role="menuitem">...more docs</a></li></ul></li><li class="top-level-entry-container"><button id="feedback-button" type="button" class="top-level-entry" aria-haspopup="menu" aria-expanded="false">Feedback</button><ul class="feedback " role="menu" aria-labelledby="feedback-button"><li role="none"><a tabindex="-1" href="/en-US/docs/MDN/Contribute/Feedback" role="menuitem">Send Feedback</a></li><li role="none"><a tabindex="-1" href="/en-US/docs/MDN/Contribute" role="menuitem">Contribute to MDN</a></li><li role="none"><a tabindex="-1" target="_blank" rel="noopener noreferrer" href="https://github.com/mdn/content/issues/new" role="menuitem">Report a content issue<!-- --> üåê</a></li><li role="none"><a tabindex="-1" target="_blank" rel="noopener noreferrer" href="https://github.com/mdn/yari/issues/new" role="menuitem">Report a platform issue<!-- --> üåê</a></li></ul></li></ul></nav><div class="header-search"><form action="/en-US/search" class="search-form search-widget" role="search"><label for="main-q" class="visually-hidden">Search MDN</label><input type="search" name="q" id="main-q" class="search-input-field" placeholder="Site search... (Press &quot;/&quot; to focus)" pattern="(.|\s)*\S(.|\s)*" required="" value=""><input type="submit" class="ghost search-button" value="" aria-label="Search"></form></div><div class="auth-container"></div></div></header><div class="breadcrumb-locale-container"><nav class="breadcrumbs-container" aria-label="Breadcrumb navigation"><ol typeof="BreadcrumbList" vocab="https://schema.org/" aria-label="breadcrumbs"><li property="itemListElement" typeof="ListItem"><a class="breadcrumb-penultimate" property="item" typeof="WebPage" href="/en-US/docs/WebAssembly"><span property="name">WebAssembly</span></a><meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem"><a class="breadcrumb-current-page" property="item" typeof="WebPage" href="/en-US/docs/WebAssembly/Understanding_the_text_format"><span property="name">Understanding WebAssembly text format</span></a><meta property="position" content="2"></li></ol></nav><ul class="language-toggle single-option"><li><a href="#select-language" class="language-icon"><span class="show-desktop">Change language</span></a></li></ul></div><aside class="document-toc-container"><section class="document-toc"><header><h2>Table of contents</h2><button type="button" class="ghost toc-trigger-mobile" aria-controls="toc-entries" aria-expanded="false">Table of contents</button></header><ul id="toc-entries"><li><a href="#s-expressions">S-expressions</a></li><li><a href="#signatures_and_parameters">Signatures and parameters</a></li><li><a href="#getting_and_setting_locals_and_parameters">Getting and setting locals and parameters</a></li><li><a href="#stack_machines">Stack machines</a></li><li><a href="#our_first_function_body">Our first function body</a></li><li><a href="#exploring_fundamentals">Exploring fundamentals</a></li><li><a href="#bulk_memory_operations">Bulk memory operations</a></li><li><a href="#types">Types</a></li><li><a href="#multi-value_webassembly">Multi-value WebAssembly</a></li><li><a href="#webassembly_threads">WebAssembly threads</a></li><li><a href="#summary">Summary</a></li><li><a href="#see_also">See also</a></li></ul></section></aside><main id="content" class="main-content" role="main"><article class="main-page-content" lang="en-US"><h1>Understanding WebAssembly text format</h1><div><p>To enable WebAssembly to be read and edited by humans, there is a textual representation of the wasm binary format. This is an intermediate form designed to be exposed in text editors, browser developer tools, etc. This article explains how that text format works, in terms of the raw syntax, and how it is related to the underlying bytecode it represents ‚Äî and the wrapper objects representing wasm in JavaScript.</p>
<div class="notecard note" id="sect1">
  <p><strong>Note:</strong> This is potentially overkill if you are a web developer who just wants to load a wasm module into a page and use it in your code (see <a href="/en-US/docs/WebAssembly/Using_the_JavaScript_API">Using the WebAssembly JavaScript API</a>), but it is more useful if for example, you want to write wasm modules to optimize the performance of your JavaScript library, or build your own WebAssembly compiler.</p>
</div></div><h2 id="s-expressions"><a href="#s-expressions" title="Permalink to S-expressions">S-expressions</a></h2><div><p>In both the binary and textual formats, the fundamental unit of code in WebAssembly is a module. In the text format, a module is represented as one big S-expression. S-expressions are a very old and very simple textual format for representing trees, and thus we can think of a module as a tree of nodes that describe the module's structure and its code. Unlike the Abstract Syntax Tree of a programming language, though, WebAssembly's tree is pretty flat, mostly consisting of lists of instructions.</p>
<p>First, let's see what an S-expression looks like. Each node in the tree goes inside a pair of parentheses ‚Äî <code>( ... )</code>. The first label inside the parenthesis tells you what type of node it is, and after that there is a space-separated list of either attributes or child nodes. So that means the WebAssembly S-expression:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>represents a tree with the root node "module" and two child nodes, a "memory" node with the attribute "1" and a "func" node. We'll see shortly what these nodes actually mean.</p></div><h3 id="the_simplest_module"><a href="#the_simplest_module" title="Permalink to The simplest module">The simplest module</a></h3><div><p>Let's start with the simplest, shortest possible wasm module.</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">)</span>
</code></pre></div>
<p>This module is totally empty, but is still a valid module.</p>
<p>If we convert our module to binary now (see <a href="/en-US/docs/WebAssembly/Text_format_to_wasm">Converting WebAssembly text format to wasm</a>), we'll see just the 8 byte module header described in the <a href="https://webassembly.github.io/spec/core/binary/index.html#high-level-structure" class="external" rel=" noopener">binary format</a>:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token number">0000000</span>: <span class="token number">0061</span> 736d              ; WASM_BINARY_MAGIC
<span class="token number">0000004</span>: <span class="token number">0100</span> <span class="token number">0000</span>              ; WASM_BINARY_VERSION
</code></pre></div></div><h3 id="adding_functionality_to_your_module"><a href="#adding_functionality_to_your_module" title="Permalink to Adding functionality to your module">Adding functionality to your module</a></h3><div><p>Ok, that's not very interesting, let's add some executable code to this module.</p>
<p>All code in a webassembly module is grouped into functions, which have the following pseudocode structure:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span> <span class="token keyword">func</span> &lt;signature&gt; &lt;locals&gt; &lt;body&gt; <span class="token punctuation">)</span>
</code></pre></div>
<ul>
  <li>The <strong>signature</strong> declares what the function takes (parameters) and returns (return values).</li>
  <li>The <strong>locals</strong> are like vars in JavaScript, but with explicit types declared.</li>
  <li>The <strong>body</strong> is just a linear list of low-level instructions.</li>
</ul>
<p>So this is similar to functions in other languages, even if it looks different because it is an S-expression.</p></div><h2 id="signatures_and_parameters"><a href="#signatures_and_parameters" title="Permalink to Signatures and parameters">Signatures and parameters</a></h2><div><p>The signature is a sequence of parameter type declarations followed by a list of return type declarations. It is worth noting here that:</p>
<ul>
  <li>The absence of a <code>(result)</code> means the function doesn't return anything.</li>
  <li>In the current iteration, there can be at most 1 return type, but <a href="https://github.com/WebAssembly/spec/blob/master/proposals/multi-value/Overview.md" class="external" rel=" noopener">later this will be relaxed</a> to any number.</li>
</ul>
<p>
  Each parameter has a type explicitly declared; wasm <a href="#number_types">Number types</a>, <a href="#reference_types">Reference types</a>, <a href="#vector_types">Vector types</a>.
  The number types are:
</p>
<ul>
  <li><code>i32</code>: 32-bit integer</li>
  <li><code>i64</code>: 64-bit integer</li>
  <li><code>f32</code>: 32-bit float</li>
  <li><code>f64</code>: 64-bit float</li>
</ul>
<p>A single parameter is written <code>(param i32)</code> and the return type is written <code>(result i32)</code>, hence a binary function that takes two 32-bit integers and returns a 64-bit float would be written like this:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> ...<span class="token punctuation">)</span>
</code></pre></div>
<p>After the signature, locals are listed with their type, for example <code>(local i32)</code>. Parameters are basically just locals that are initialized with the value of the corresponding argument passed by the caller.</p></div><h2 id="getting_and_setting_locals_and_parameters"><a href="#getting_and_setting_locals_and_parameters" title="Permalink to Getting and setting locals and parameters">Getting and setting locals and parameters</a></h2><div><p>Locals/parameters can be read and written by the body of the function with the <code>local.get</code> and <code>local.set</code> instructions.</p>
<p>The <code>local.get</code>/<code>local.set</code> commands refer to the item to be got/set by its numeric index: parameters are referred to first, in order of their declaration, followed by locals in order of their declaration. So given the following function:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token keyword">f64</span><span class="token punctuation">)</span>
  <span class="token keyword">local</span>.get <span class="token number">0</span>
  <span class="token keyword">local</span>.get <span class="token number">1</span>
  <span class="token keyword">local</span>.get <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div>
<p>The instruction <code>local.get 0</code> would get the i32 parameter, <code>local.get 1</code> would get the f32 parameter, and <code>local.get 2</code> would get the f64 local.</p>
<p>There is another issue here ‚Äî using numeric indices to refer to items can be confusing and annoying, so the text format allows you to name parameters, locals, and most other items by including a name prefixed by a dollar symbol (<code>$</code>) just before the type declaration.</p>
<p>Thus, you could rewrite our previous signature like so:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p1</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p2</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$loc</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> ‚Ä¶<span class="token punctuation">)</span>
</code></pre></div>
<p>And then could write <code>local.get $p1</code> instead of <code>local.get 0</code>, etc. (Note that when this text gets converted to binary, though, the binary will contain only the integer.)</p></div><h2 id="stack_machines"><a href="#stack_machines" title="Permalink to Stack machines">Stack machines</a></h2><div><p>Before we can write a function body, we have to talk about one more thing: <strong>stack machines</strong>. Although the browser compiles it to something more efficient, wasm execution is defined in terms of a stack machine where the basic idea is that every type of instruction pushes and/or pops a certain number of <code>i32</code>/<code>i64</code>/<code>f32</code>/<code>f64</code> values to/from a stack.</p>
<p>For example, <code>local.get</code> is defined to push the value of the local it read onto the stack, and <code>i32.add</code> pops two <code>i32</code> values (it implicitly grabs the previous two values pushed onto the stack), computes their sum (modulo 2^32) and pushes the resulting i32 value.</p>
<p>When a function is called, it starts with an empty stack which is gradually filled up and emptied as the body's instructions are executed. So for example, after executing the following function:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
  <span class="token keyword">local</span>.get <span class="token variable">$p</span>
  <span class="token keyword">local</span>.get <span class="token variable">$p</span>
  <span class="token keyword">i32<span class="token punctuation">.</span>add</span><span class="token punctuation">)</span>
</code></pre></div>
<p>The stack contains exactly one <code>i32</code> value ‚Äî the result of the expression (<code>$p + $p</code>), which is handled by <code>i32.add</code>. The return value of a function is just the final value left on the stack.</p>
<p>The WebAssembly validation rules ensure the stack matches exactly: if you declare a <code>(result f32)</code>, then the stack must contain exactly one <code>f32</code> at the end. If there is no result type, the stack must be empty.</p></div><h2 id="our_first_function_body"><a href="#our_first_function_body" title="Permalink to Our first function body">Our first function body</a></h2><div><p>As mentioned before, the function body is a list of instructions that are followed as the function is called. Putting this together with what we have already learned, we can finally define a module containing our own simple function:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$lhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$rhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span>.get <span class="token variable">$lhs</span>
    <span class="token keyword">local</span>.get <span class="token variable">$rhs</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>add</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>This function gets two parameters, adds them together, and returns the result.</p>
<p>There are a lot more things that can be put inside function bodies, but we will start off simple for now, and you'll see a lot more examples as you go along. For a full list of the available opcodes, consult the <a href="https://webassembly.github.io/spec/core/exec/index.html" class="external" rel=" noopener">webassembly.org Semantics reference</a>.</p></div><h3 id="calling_the_function"><a href="#calling_the_function" title="Permalink to Calling the function">Calling the function</a></h3><div><p>Our function won't do very much on its own ‚Äî now we need to call it. How do we do that? Like in an ES module, wasm functions must be explicitly exported by an <code>export</code> statement inside the module.</p>
<p>Like locals, functions are identified by an index by default, but for convenience, they can be named. Let's start by doing this ‚Äî first, we'll add a name preceded by a dollar sign, just after the <code>func</code> keyword:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$add</span> ‚Ä¶<span class="token punctuation">)</span>
</code></pre></div>
<p>Now we need to add an export declaration ‚Äî this looks like so:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$add</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>Here, <code>add</code> is the name the function will be identified by in JavaScript whereas <code>$add</code> picks out which WebAssembly function inside the Module is being exported.</p>
<p>So our final module (for now) looks like this:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$add</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$lhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$rhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span>.get <span class="token variable">$lhs</span>
    <span class="token keyword">local</span>.get <span class="token variable">$rhs</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>add</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$add</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>If you want to follow along with the example, save the above our module into a file called <code>add.wat</code>, then convert it into a binary file called <code>add.wasm</code> using wabt (see <a href="/en-US/docs/WebAssembly/Text_format_to_wasm">Converting WebAssembly text format to wasm</a> for details).</p>
<p>Next, we'll load our binary into a typed array called <code>addCode</code> (as described in <a href="/en-US/docs/WebAssembly/Loading_and_running">Fetching WebAssembly Bytecode</a>), compile and instantiate it, and execute our <code>add</code> function in JavaScript (we can now find <code>add()</code> in the <a href="/en-US/docs/WebAssembly/JavaScript_interface/Instance/exports"><code>exports</code></a> property of the instance):</p>
<div class="code-example"><pre class="brush: js notranslate"><code>WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"add.wasm"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "3"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="notecard note" id="sect2">
  <p><strong>Note:</strong> You can find this example in GitHub as <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/add.html" class="external" rel=" noopener">add.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/add.html" class="external" rel=" noopener">see it live also</a>). Also see <a href="/en-US/docs/WebAssembly/JavaScript_interface/instantiateStreaming"><code>WebAssembly.instantiateStreaming()</code></a> for more details about the instantiate function.</p>
</div></div><h2 id="exploring_fundamentals"><a href="#exploring_fundamentals" title="Permalink to Exploring fundamentals">Exploring fundamentals</a></h2><div><p>Now we've covered the real basics, let's move on to look at some more advanced features.</p></div><h3 id="calling_functions_from_other_functions_in_the_same_module"><a href="#calling_functions_from_other_functions_in_the_same_module" title="Permalink to Calling functions from other functions in the same module">Calling functions from other functions in the same module</a></h3><div><p>The <code>call</code> instruction calls a single function, given its index or name. For example, the following module contains two functions ‚Äî one just returns the value 42, the other returns the result of calling the first plus one:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$getAnswer</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"getAnswerPlus1"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">call</span> <span class="token variable">$getAnswer</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>add</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<div class="notecard note" id="sect3">
  <p><strong>Note:</strong> <code>i32.const</code> just defines a 32-bit integer and pushes it onto the stack. You could swap out the <code>i32</code> for any of the other available types, and change the value of the const to whatever you like (here we've set the value to <code>42</code>).</p>
</div>
<p>In this example you'll notice an <code>(export "getAnswerPlus1")</code> section, declared just after the <code>func</code> statement in the second function ‚Äî this is a shorthand way of declaring that we want to export this function, and defining the name we want to export it as.</p>
<p>This is functionally equivalent to including a separate function statement outside the function, elsewhere in the module in the same manner as we did before, e.g.:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"getAnswerPlus1"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$functionName</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>The JavaScript code to call our above module looks like so:</p>
<div class="code-example"><pre class="brush: js notranslate"><code>WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"call.wasm"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">getAnswerPlus1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "43"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><h3 id="importing_functions_from_javascript"><a href="#importing_functions_from_javascript" title="Permalink to Importing functions from JavaScript">Importing functions from JavaScript</a></h3><div><p>We have already seen JavaScript calling WebAssembly functions, but what about WebAssembly calling JavaScript functions? WebAssembly doesn't actually have any built-in knowledge of JavaScript, but it does have a general way to import functions that can accept either JavaScript or wasm functions. Let's look at an example:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"console"</span> <span class="token string">"log"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$log</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"logIt"</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">13</span>
    <span class="token keyword">call</span> <span class="token variable">$log</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>WebAssembly has a two-level namespace so the import statement here is saying that we're asking to import the <code>log</code> function from the <code>console</code> module. You can also see that the exported <code>logIt</code> function calls the imported function using the <code>call</code> instruction we introduced above.</p>
<p>Imported functions are just like normal functions: they have a signature that WebAssembly validation checks statically, and they are given an index and can be named and called.</p>
<p>JavaScript functions have no notion of signature, so any JavaScript function can be passed, regardless of the import's declared signature. Once a module declares an import, the caller of <a href="/en-US/docs/WebAssembly/JavaScript_interface/instantiate"><code>WebAssembly.instantiate()</code></a> must pass in an import object that has the corresponding properties.</p>
<p>For the above, we need an object (let's call it <code>importObject</code>) such that <code>importObject.console.log</code> is a JavaScript function.</p>
<p>This would look like the following:</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">const</span> importObject <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">console</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"logger.wasm"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">logIt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="notecard note" id="sect4">
  <p><strong>Note:</strong> You can find this example on GitHub as <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/logger.html" class="external" rel=" noopener">logger.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/logger.html" class="external" rel=" noopener">see it live also</a>).</p>
</div></div><h3 id="declaring_globals_in_webassembly"><a href="#declaring_globals_in_webassembly" title="Permalink to Declaring globals in WebAssembly">Declaring globals in WebAssembly</a></h3><div><p>WebAssembly has the ability to create global variable instances, accessible from both JavaScript and importable/exportable across one or more <a href="/en-US/docs/WebAssembly/JavaScript_interface/Module"><code>WebAssembly.Module</code></a> instances. This is very useful, as it allows dynamic linking of multiple modules.</p>
<p>In WebAssembly text format, it looks something like this (see <a href="https://github.com/mdn/webassembly-examples/blob/master/js-api-examples/global.wat" class="external" rel=" noopener">global.wat</a> in our GitHub repo; also see <a href="https://mdn.github.io/webassembly-examples/js-api-examples/global.html" class="external" rel=" noopener">global.html</a> for a live JavaScript example):</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
   <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$g</span> <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"global"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"getGlobal"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$g</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"incGlobal"</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">global</span>.set <span class="token variable">$g</span>
            <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$g</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>This looks similar to what we've seen before, except that we specify a global value using the keyword <code>global</code>, and we also specify the keyword <code>mut</code> along with the value's datatype if we want it to be mutable.</p>
<p>To create an equivalent value using JavaScript, you'd use the <a href="/en-US/docs/WebAssembly/JavaScript_interface/Global"><code>WebAssembly.Global()</code></a> constructor:</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">const</span> global <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Global</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">"i32"</span><span class="token punctuation">,</span> <span class="token literal-property property">mutable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><h3 id="webassembly_memory"><a href="#webassembly_memory" title="Permalink to WebAssembly Memory">WebAssembly Memory</a></h3><div><p>The above example is a pretty terrible logging function: it only prints a single integer! What if we wanted to log a text string? To deal with strings and other more complex data types, WebAssembly provides <strong>memory</strong> (although we also have <a href="#reference_types">Reference types</a> in newer implementation of WebAssembly). According to WebAssembly, memory is just a large array of bytes that can grow over time. WebAssembly contains instructions like <code>i32.load</code> and <code>i32.store</code> for reading and writing from <a href="https://webassembly.github.io/spec/core/exec/index.html#linear-memory" class="external" rel=" noopener">linear memory</a>.</p>
<p>From JavaScript's point of view, it's as though memory is all inside one big (resizable) <a href="/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code>ArrayBuffer</code></a>. That's literally all that asm.js has to play with (except that it isn't resizable; see the asm.js <a href="http://asmjs.org/spec/latest/#programming-model" class="external" rel=" noopener">Programming model</a>).</p>
<p>So a string is just a sequence of bytes somewhere inside this linear memory. Let's assume that we've written a suitable string of bytes to memory; how do we pass that string out to JavaScript?</p>
<p>The key is that JavaScript can create WebAssembly linear memory instances via the <a href="/en-US/docs/WebAssembly/JavaScript_interface/Memory"><code>WebAssembly.Memory()</code></a> interface, and access an existing memory instance (currently you can only have one per module instance) using the associated instance methods. Memory instances have a <a href="/en-US/docs/WebAssembly/JavaScript_interface/Memory/buffer"><code>buffer</code></a> getter, which returns an <code>ArrayBuffer</code> that points at the whole linear memory.</p>
<p>Memory instances can also grow, for example via the <a href="/en-US/docs/WebAssembly/JavaScript_interface/Memory/grow"><code>Memory.grow()</code></a> method in JavaScript. When growth occurs, since <code>ArrayBuffer</code>s can't change size, the current <code>ArrayBuffer</code> is detached and a new <code>ArrayBuffer</code> is created to point to the newer, bigger memory. This means all we need to do to pass a string to JavaScript is to pass out the offset of the string in linear memory along with some way to indicate the length.</p>
<p>While there are many ways to encode a string's length in the string itself (for example, C strings); for simplicity here we just pass both offset and length as parameters:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"console"</span> <span class="token string">"log"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$log</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>On the JavaScript side, we can use the <a href="/en-US/docs/Web/API/TextDecoder">TextDecoder API</a> to easily decode our bytes into a JavaScript string. (We specify <code>utf8</code> here, but many other encodings are supported.)</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">consoleLogString</span><span class="token punctuation">(</span><span class="token parameter">offset<span class="token punctuation">,</span> length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>memory<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> string <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The last missing piece of the puzzle is where <code>consoleLogString</code> gets access to the WebAssembly <code>memory</code>. WebAssembly gives us a lot of flexibility here: we can either create a <a href="/en-US/docs/WebAssembly/JavaScript_interface/Memory"><code>Memory</code></a> object in JavaScript and have the WebAssembly module import the memory, or we can have the WebAssembly module create the memory and export it to JavaScript.</p>
<p>For simplicity, let's create it in JavaScript then import it into WebAssembly. Our <code>import</code> statement is written as follows:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"mem"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>The <code>1</code> indicates that the imported memory must have at least 1 page of memory (WebAssembly defines a page to be 64KB.)</p>
<p>So let's see a complete module that prints the string "Hi". In a normal compiled C program, you'd call a function to allocate some memory for the string, but since we're just writing our own assembly here and we own the entire linear memory, we can just write the string contents into global memory using a <code>data</code> section. Data sections allow a string of bytes to be written at a given offset at instantiation time and are similar to the <code>.data</code> sections in native executable formats.</p>
<p>Our final wasm module looks like this:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"console"</span> <span class="token string">"log"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$log</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"mem"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">"Hi"</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"writeHi"</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span>  <span class="token comment">;; pass offset 0 to log</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span>  <span class="token comment">;; pass length 2 to log</span>
    <span class="token keyword">call</span> <span class="token variable">$log</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<div class="notecard note" id="sect5">
  <p><strong>Note:</strong> Above, note the double semicolon syntax (<code>;;</code>) for allowing comments in WebAssembly files.</p>
</div>
<p>Now from JavaScript we can create a Memory with 1 page and pass it in. This results in "Hi" being printed to the console:</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">const</span> memory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> importObject <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">console</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">log</span><span class="token operator">:</span> consoleLogString <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">js</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">mem</span><span class="token operator">:</span> memory <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"logger2.wasm"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importObject<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">writeHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="notecard note" id="sect6">
  <p><strong>Note:</strong> You can find the full source on GitHub as <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/logger2.html" class="external" rel=" noopener">logger2.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/logger2.html" class="external" rel=" noopener">also see it live</a>).</p>
</div></div><h3 id="webassembly_tables"><a href="#webassembly_tables" title="Permalink to WebAssembly tables">WebAssembly tables</a></h3><div><p>To finish this tour of the WebAssembly text format, let's look at the most intricate, and often confusing, part of WebAssembly: <strong>tables</strong>. Tables are basically resizable arrays of references that can be accessed by index from WebAssembly code.</p>
<p>To see why tables are needed, we need to first observe that the <code>call</code> instruction we saw earlier (see <a href="#calling_functions_from_other_functions_in_the_same_module">Calling functions from other functions in the same module</a>) takes a static function index and thus can only ever call one function ‚Äî but what if the callee is a runtime value?</p>
<ul>
  <li>In JavaScript, we see this all the time: functions are first-class values.</li>
  <li>In C/C++, we see this with function pointers.</li>
  <li>In C++, we see this with virtual functions.</li>
</ul>
<p>WebAssembly needed a type of call instruction to achieve this, so we gave it <code>call_indirect</code>, which takes a dynamic function operand. The problem is that the only types we have to give operands in WebAssembly are (currently) <code>i32</code>/<code>i64</code>/<code>f32</code>/<code>f64</code>.</p>
<p>WebAssembly could add an <code>anyfunc</code> type ("any" because the type could hold functions of any signature), but unfortunately this <code>anyfunc</code> type couldn't be stored in linear memory for security reasons. Linear memory exposes the raw contents of stored values as bytes and this would allow wasm content to arbitrarily observe and corrupt raw function addresses, which is something that cannot be allowed on the web.</p>
<p>The solution was to store function references in a table and pass around table indices instead, which are just i32 values. <code>call_indirect</code>'s operand can therefore be an i32 index value.</p>
<h4 id="defining_a_table_in_wasm">Defining a table in wasm</h4>
<p>So how do we place wasm functions in our table? Just like <code>data</code> sections can be used to initialize regions of linear memory with bytes, <code>elem</code> sections can be used to initialize regions of tables with functions:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token number">2</span> funcref<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">elem</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token variable">$f1</span> <span class="token variable">$f2</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$f1</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$f2</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">13</span><span class="token punctuation">)</span>
  ...
<span class="token punctuation">)</span>
</code></pre></div>
<ul>
  <li>In <code>(table 2 funcref)</code>, the 2 is the initial size of the table (meaning it will store two references) and <code>funcref</code> declares that the element type of these references are function reference.</li>
  <li>The functions (<code>func</code>) sections are just like any other declared wasm functions. These are the functions we are going to refer to in our table (for example's sake, each one just returns a constant value). Note that the order the sections are declared in doesn't matter here ‚Äî you can declare your functions anywhere and still refer to them in your <code>elem</code> section.</li>
  <li>The <code>elem</code> section can list any subset of the functions in a module, in any order, allowing duplicates. This is a list of the functions that are to be referenced by the table, in the order they are to be referenced.</li>
  <li>The <code>(i32.const 0)</code> value inside the <code>elem</code> section is an offset ‚Äî this needs to be declared at the start of the section, and specifies at what index in the table function references start to be populated. Here we've specified 0, and a size of 2 (see above), so we can fill in two references at indexes 0 and 1. If we wanted to start writing our references at offset 1, we'd have to write <code>(i32.const 1)</code>, and the table size would have to be 3.</li>
</ul>
<div class="notecard note" id="sect7">
  <p><strong>Note:</strong> Uninitialized elements are given a default throw-on-call value.</p>
</div>
<p>In JavaScript, the equivalent calls to create such a table instance would look something like this:</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// table section</span>
  <span class="token keyword">const</span> tbl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Table</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token string">"anyfunc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// function sections:</span>
  <span class="token keyword">const</span> f1 <span class="token operator">=</span> <span class="token operator">...</span> <span class="token comment">/* some imported WebAssembly function */</span>
  <span class="token keyword">const</span> f2 <span class="token operator">=</span> <span class="token operator">...</span> <span class="token comment">/* some imported WebAssembly function */</span>

  <span class="token comment">// elem section</span>
  tbl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tbl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<h4 id="using_the_table">Using the table</h4>
<p>Moving on, now we've defined the table we need to use it somehow. Let's use this section of code to do so:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; if this was f32, type checking would fail</span>
<span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"callByIndex"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$i</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
  <span class="token keyword">local</span>.get <span class="token variable">$i</span>
  <span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<ul>
  <li>The <code>(type $return_i32 (func (result i32)))</code> block specifies a type, with a reference name. This type is used when performing type checking of the table function reference calls later on. Here we are saying that the references need to be functions that return an <code>i32</code> as a result.</li>
  <li>Next, we define a function that will be exported with the name <code>callByIndex</code>. This will take one <code>i32</code> as a parameter, which is given the argument name <code>$i</code>.</li>
  <li>Inside the function, we add one value to the stack ‚Äî whatever value is passed in as the parameter <code>$i</code>.</li>
  <li>Finally, we use <code>call_indirect</code> to call a function from the table ‚Äî it implicitly pops the value of <code>$i</code> off the stack. The net result of this is that the <code>callByIndex</code> function invokes the <code>$i</code>'th function in the table.</li>
</ul>
<p>You could also declare the <code>call_indirect</code> parameter explicitly during the command call instead of before it, like this:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>In a higher level, more expressive language like JavaScript, you could imagine doing the same thing with an array (or probably more likely, object) containing functions. The pseudocode would look something like <code>tbl[i]()</code>.</p>
<p>So, back to the typechecking. Since WebAssembly is type checked, and the <code>funcref</code> can be potentially any function signature, we have to supply the presumed signature of the callee at the callsite, hence we include the <code>$return_i32</code> type, to tell the program a function returning an <code>i32</code> is expected. If the callee doesn't have a matching signature (say an <code>f32</code> is returned instead), a <a href="/en-US/docs/WebAssembly/JavaScript_interface/RuntimeError"><code>WebAssembly.RuntimeError</code></a> is thrown.</p>
<p>So what links the <code>call_indirect</code> to the table we are calling? The answer is that there is only one table allowed right now per module instance, and that is what <code>call_indirect</code> is implicitly calling. In the future, when multiple tables are allowed, we would also need to specify a table identifier of some kind, along the lines of</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token keyword">call_indirect</span> <span class="token variable">$my_spicy_table</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$i32_to_void</span><span class="token punctuation">)</span>
</code></pre></div>
<p>The full module all together looks like this, and can be found in our <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/wasm-table.wat" class="external" rel=" noopener">wasm-table.wat</a> example file:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token number">2</span> funcref<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$f1</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$f2</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">13</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">elem</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token variable">$f1</span> <span class="token variable">$f2</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"callByIndex"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$i</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span>.get <span class="token variable">$i</span>
    <span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>We load it into a webpage using the following JavaScript:</p>
<div class="code-example"><pre class="brush: js notranslate"><code>WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"wasm-table.wasm"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">callByIndex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 42</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">callByIndex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 13</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">callByIndex</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns an error, because there is no index position 2 in the table</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="notecard note" id="sect8">
  <p><strong>Note:</strong> You can find this example on GitHub as <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/wasm-table.html" class="external" rel=" noopener">wasm-table.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/wasm-table.html" class="external" rel=" noopener">see it live also</a>).</p>
</div>
<div class="notecard note" id="sect9">
  <p><strong>Note:</strong> Just like Memory, Tables can also be created from JavaScript (see <a href="/en-US/docs/WebAssembly/JavaScript_interface/Table"><code>WebAssembly.Table()</code></a>) as well as imported to/from another wasm module.</p>
</div></div><h3 id="mutating_tables_and_dynamic_linking"><a href="#mutating_tables_and_dynamic_linking" title="Permalink to Mutating tables and dynamic linking">Mutating tables and dynamic linking</a></h3><div><p>Because JavaScript has full access to function references, the Table object can be mutated from JavaScript using the <a href="/en-US/docs/WebAssembly/JavaScript_interface/Table/grow"><code>grow()</code></a>, <a href="/en-US/docs/WebAssembly/JavaScript_interface/Table/get"><code>get()</code></a> and <a href="/en-US/docs/WebAssembly/JavaScript_interface/Table/set"><code>set()</code></a> methods. And WebAssembly code is itself able to manipulate tables using instructions added as part of <a href="#reference_types">Reference types</a>, such as <code>table.get</code> and <code>table.set</code>.</p>
<p>Because tables are mutable, they can be used to implement sophisticated load-time and run-time <a href="https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md" class="external" rel=" noopener">dynamic linking schemes</a>. When a program is dynamically linked, multiple instances share the same memory and table. This is symmetric to a native application where multiple compiled <code>.dll</code>s share a single process's address space.</p>
<p>To see this in action, we'll create a single import object containing a Memory object and a Table object, and pass this same import object to multiple <a href="/en-US/docs/WebAssembly/JavaScript_interface/instantiate"><code>instantiate()</code></a> calls.</p>
<p>Our <code>.wat</code> examples look like so:</p>
<p><code>shared0.wat</code>:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"memory"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"table"</span> <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token number">1</span> funcref<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">elem</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token variable">$shared0func</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$shared0func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>load</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p><code>shared1.wat</code>:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"memory"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"table"</span> <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token number">1</span> funcref<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$void_to_i32</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"doIt"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>store</span>  <span class="token comment">;; store 42 at address 0</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span>
   <span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$void_to_i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>These work as follows:</p>
<ol>
  <li>The function <code>shared0func</code> is defined in <code>shared0.wat</code>, and stored in our imported table.</li>
  <li>This function creates a constant containing the value <code>0</code>, and then uses the <code>i32.load</code> command to load the value contained in the provided memory index. The index provided is <code>0</code> ‚Äî again, it implicitly pops the previous value off the stack. So <code>shared0func</code> loads and returns the value stored at memory index <code>0</code>.</li>
  <li>In <code>shared1.wat</code>, we export a function called <code>doIt</code> ‚Äî this function creates two constants containing the values <code>0</code> and <code>42</code>, then calls <code>i32.store</code> to store a provided value at a provided index of the imported memory. Again, it implicitly pops these values off the stack, so the result is that it stores the value <code>42</code> in memory index <code>0</code>,</li>
  <li>In the last part of the function, we create a constant with value <code>0</code>, then call the function at this index 0 of the table, which is <code>shared0func</code>, stored there earlier by the <code>elem</code> block in <code>shared0.wat</code>.</li>
  <li>When called, <code>shared0func</code> loads the <code>42</code> we stored in memory using the <code>i32.store</code> command in <code>shared1.wat</code>.</li>
</ol>
<div class="notecard note" id="sect10">
  <p><strong>Note:</strong> The above expressions again pop values from the stack implicitly, but you could declare these explicitly inside the command calls instead, for example:</p>
  <div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$void_to_i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
</div>
<p>After converting to assembly, we then use <code>shared0.wasm</code> and <code>shared1.wasm</code> in JavaScript via the following code:</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">const</span> importObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">js</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">memory</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">table</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Table</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token string">"anyfunc"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"shared0.wasm"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importObj<span class="token punctuation">)</span><span class="token punctuation">,</span>
  WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"shared1.wasm"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importObj<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">doIt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prints 42</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Each of the modules that is being compiled can import the same memory and table objects and thus share the same linear memory and table "address space".</p>
<div class="notecard note" id="sect11">
  <p><strong>Note:</strong> You can find this example on GitHub as <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/shared-address-space.html" class="external" rel=" noopener">shared-address-space.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/shared-address-space.html" class="external" rel=" noopener">see it live also</a>).</p>
</div></div><h2 id="bulk_memory_operations"><a href="#bulk_memory_operations" title="Permalink to Bulk memory operations">Bulk memory operations</a></h2><div><p>Bulk memory operations are a newer addition to the language (for example, in <a href="/en-US/docs/Mozilla/Firefox/Releases/79">Firefox 79</a>) ‚Äî seven new built-in operations are provided for bulk memory operations such as copying and initializing, to allow WebAssembly to model native functions such as <code>memcpy</code> and <code>memmove</code> in a more efficient, performant way.</p>
<p>The new operations are:</p>
<ul>
  <li><code>data.drop</code>: Discard the data in an data segment.</li>
  <li><code>elem.drop</code>: Discard the data in an element segment.</li>
  <li><code>memory.copy</code>: Copy from one region of linear memory to another.</li>
  <li><code>memory.fill</code>: Fill a region of linear memory with a given byte value.</li>
  <li><code>memory.init</code>: Copy a region from a data segment.</li>
  <li><code>table.copy</code>: Copy from one region of a table to another.</li>
  <li><code>table.init</code>: Copy a region from an element segment.</li>
</ul>
<div class="notecard note" id="sect12">
  <p><strong>Note:</strong> You can find more information in the <a href="https://github.com/WebAssembly/bulk-memory-operations/blob/master/proposals/bulk-memory-operations/Overview.md" class="external" rel=" noopener">Bulk Memory Operations and Conditional Segment Initialization</a> proposal.</p>
</div></div><h2 id="types"><a href="#types" title="Permalink to Types">Types</a></h2><div></div><h3 id="number_types"><a href="#number_types" title="Permalink to Number types">Number types</a></h3><div><p>Web assembly currently has four available <em>number types</em>:</p>
<ul>
  <li><code>i32</code>: 32-bit integer</li>
  <li><code>i64</code>: 64-bit integer</li>
  <li><code>f32</code>: 32-bit float</li>
  <li><code>f64</code>: 64-bit float</li>
</ul></div><h3 id="vector_types"><a href="#vector_types" title="Permalink to Vector types">Vector types</a></h3><div><ul>
  <li><code>v128</code>: 128 bit vector of packed integer, floating-point data, or a single 128 bit type.</li>
</ul></div><h3 id="reference_types"><a href="#reference_types" title="Permalink to Reference types">Reference types</a></h3><div><p>The <a href="https://github.com/WebAssembly/reference-types/blob/master/proposals/reference-types/Overview.md" class="external" rel=" noopener">reference types proposal</a> (supported in <a href="/en-US/docs/Mozilla/Firefox/Releases/79">Firefox 79</a>) provides two main features:</p>
<ul>
  <li>A new type, <code>externref</code>, which can hold <em>any</em> JavaScript value, for example strings, DOM references, objects, etc. <code>externref</code> is opaque from the point of view of WebAssembly ‚Äî a wasm module can't access and manipulate these values and instead can only receive them and pass them back out. But this is very useful for allowing wasm modules to call JavaScript functions, DOM APIs, etc., and generally to pave the way for easier interoperability with the host environment. <code>externref</code> can be used for value types and table elements.</li>
  <li>A number of new instructions that allow wasm modules to directly manipulate <a href="#webassembly_tables">WebAssembly tables</a>, rather than having to do it via the JavaScript API.</li>
</ul>
<div class="notecard note" id="sect13">
  <p><strong>Note:</strong> The <a href="https://rustwasm.github.io/docs/wasm-bindgen/" class="external" rel=" noopener">wasm-bindgen</a> documentation contains some useful information on how to take advantage of <code>externref</code> from Rust.</p>
</div></div><h2 id="multi-value_webassembly"><a href="#multi-value_webassembly" title="Permalink to Multi-value WebAssembly">Multi-value WebAssembly</a></h2><div><p>Another more recent addition to the language (for example, in <a href="/en-US/docs/Mozilla/Firefox/Releases/78">Firefox 78</a>) is WebAssembly multi-value, meaning that WebAssembly functions can now return multiple values, and instruction sequences can consume and produce multiple stack values.</p>
<p>At the time of writing (June 2020) this is at an early stage, and the only multi-value instructions available are calls to functions that themselves return multiple values. For example:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$get_two_numbers</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"add_two_numbers"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">call</span> <span class="token variable">$get_two_numbers</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>add</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>But this will pave the way for more useful instruction types, and other things besides. For a useful write-up of progress so far and how this works, see <a href="https://hacks.mozilla.org/2019/11/multi-value-all-the-wasm/" class="external" rel=" noopener">Multi-Value All The Wasm!</a> by Nick Fitzgerald.</p></div><h2 id="webassembly_threads"><a href="#webassembly_threads" title="Permalink to WebAssembly threads">WebAssembly threads</a></h2><div><p>WebAssembly Threads (supported in <a href="/en-US/docs/Mozilla/Firefox/Releases/79">Firefox 79</a> onwards) allow WebAssembly Memory objects to be shared across multiple WebAssembly instances running in separate Web Workers, in the same fashion as <a href="/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"><code>SharedArrayBuffer</code></a>s in JavaScript. This allows very fast communication between Workers, and significant performance gains in web applications.</p>
<p>The threads proposal has two parts, shared memories and atomic memory accesses.</p></div><h3 id="shared_memories"><a href="#shared_memories" title="Permalink to Shared memories">Shared memories</a></h3><div><p>As described above, you can create shared WebAssembly <a href="/en-US/docs/WebAssembly/JavaScript_interface/Memory"><code>Memory</code></a> objects, which can be transferred between Window and Worker contexts using <a href="/en-US/docs/Web/API/Window/postMessage"><code>postMessage()</code></a>, in the same fashion as a <a href="/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"><code>SharedArrayBuffer</code></a>.</p>
<p>Over on the JavaScript API side, the <a href="/en-US/docs/WebAssembly/JavaScript_interface/Memory/Memory"><code>WebAssembly.Memory()</code></a> constructor's initialization object now has a <code>shared</code> property, which when set to <code>true</code> will create a shared memory:</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">const</span> memory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maximum</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>the memory's <a href="/en-US/docs/WebAssembly/JavaScript_interface/Memory/buffer"><code>buffer</code></a> property will now return a <code>SharedArrayBuffer</code>, instead of the usual <code>ArrayBuffer</code>:</p>
<div class="code-example"><pre class="brush: js notranslate"><code>memory<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span> <span class="token comment">// returns SharedArrayBuffer</span>
</code></pre></div>
<p>Over in the text format, you can create a shared memory using the <code>shared</code> keyword, like this:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span> <span class="token number">2</span> shared<span class="token punctuation">)</span>
</code></pre></div>
<p>Unlike unshared memories, shared memories must specify a "maximum" size, in both the JavaScript API constructor and wasm text format.</p>
<div class="notecard note" id="sect14">
  <p><strong>Note:</strong> You can find a lot more details in the <a href="https://github.com/WebAssembly/threads/blob/master/proposals/threads/Overview.md" class="external" rel=" noopener">Threading proposal for WebAssembly</a>.</p>
</div></div><h3 id="atomic_memory_accesses"><a href="#atomic_memory_accesses" title="Permalink to Atomic memory accesses">Atomic memory accesses</a></h3><div><p>A number of new wasm instructions have been added that can be used to implement higher level features like mutexes, condition variables, etc. You can <a href="https://github.com/WebAssembly/threads/blob/master/proposals/threads/Overview.md#atomic-memory-accesses" class="external" rel=" noopener">find them listed here</a>. These instructions are allowed on non-shared memories as of Firefox 80.</p>
<div class="notecard note" id="sect15">
  <p><strong>Note:</strong> The <a href="https://emscripten.org/docs/porting/pthreads.html" class="external" rel=" noopener">Emscripten Pthreads support page</a> shows how to take advantage of this new functionality from Emscripten.</p>
</div></div><h2 id="summary"><a href="#summary" title="Permalink to Summary">Summary</a></h2><div><p>This finishes our high-level tour of the major components of the WebAssembly text format and how they get reflected in the WebAssembly JS API.</p></div><h2 id="see_also"><a href="#see_also" title="Permalink to See also">See also</a></h2><div><ul>
  <li>The main thing that wasn't included is a comprehensive list of all the instructions that can occur in function bodies. See the <a href="https://webassembly.github.io/spec/core/exec/index.html" class="external" rel=" noopener">WebAssembly semantics</a> for a treatment of each instruction.</li>
  <li>See also the <a href="https://github.com/WebAssembly/spec/blob/master/interpreter/README.md#s-expression-syntax" class="external" rel=" noopener">grammar of the text format</a> that is implemented by the spec interpreter.</li>
</ul></div></article><aside class="metadata"><div class="metadata-content-container"><div id="on-github" class="on-github"><h3>Found a problem with this page?</h3><ul><li><a href="https://github.com/mdn/content/edit/style/old/files/en-us/webassembly/understanding_the_text_format/index.md" title="You're going to need to sign in to GitHub first (Opens in a new tab)" target="_blank" rel="noopener noreferrer">Edit on <b>GitHub</b></a></li><li><a href="https://github.com/mdn/content/blob/style/old/files/en-us/webassembly/understanding_the_text_format/index.md" title="Folder: en-us/webassembly/understanding_the_text_format (Opens in a new tab)" target="_blank" rel="noopener noreferrer">Source on <b>GitHub</b></a></li><li><a href="https://github.com/mdn/content/issues/new?body=MDN+URL%3A+https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWebAssembly%2FUnderstanding_the_text_format%0A%0A%23%23%23%23+What+information+was+incorrect%2C+unhelpful%2C+or+incomplete%3F%0A%0A%0A%23%23%23%23+Specific+section+or+headline%3F%0A%0A%0A%23%23%23%23+What+did+you+expect+to+see%3F%0A%0A%0A%23%23%23%23+Did+you+test+this%3F+If+so%2C+how%3F%0A%0A%0A%3C%21--+Do+not+make+changes+below+this+line+--%3E%0A%3Cdetails%3E%0A%3Csummary%3EMDN+Content+page+report+details%3C%2Fsummary%3E%0A%0A*+Folder%3A+%60en-us%2Fwebassembly%2Funderstanding_the_text_format%60%0A*+MDN+URL%3A+https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWebAssembly%2FUnderstanding_the_text_format%0A*+GitHub+URL%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Fcontent%2Fblob%2Fstyle%2Fold%2Ffiles%2Fen-us%2Fwebassembly%2Funderstanding_the_text_format%2Findex.md%0A*+Last+commit%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Fcontent%2Fcommit%2Fd606f8dc936dcf766e1540f687eba8dc9dd9ed13%0A*+Document+last+modified%3A+2022-09-19T05%3A46%3A09.000Z%0A%0A%3C%2Fdetails%3E&amp;title=Issue+with+%22Understanding+WebAssembly+text+format%22%3A+%28short+summary+here+please%29&amp;labels=needs-triage%2CContent%3Awasm" title="This will take you to https://github.com/mdn/content to file a new issue" target="_blank" rel="noopener noreferrer">Report a problem with this content on <b>GitHub</b></a></li><li>Want to fix the problem yourself? See<!-- --> <a href="https://github.com/mdn/content/blob/main/README.md" target="_blank" rel="noopener noreferrer">our Contribution guide</a>.</li></ul></div><p class="last-modified-date"><b>Last modified:</b> <time datetime="2022-09-19T05:46:09.000Z">Sep 19, 2022</time>,<!-- --> <a href="/en-US/docs/WebAssembly/Understanding_the_text_format/contributors.txt">by MDN contributors</a></p><form class="language-menu"><fieldset id="select-language"><legend>Change your language</legend><label for="language-selector" class="visually-hidden">Select your preferred language</label> <select id="language-selector" name="language"><option selected="" value="en-US">English (US)</option><option value="ja">Êó•Êú¨Ë™û</option><option value="ko">ÌïúÍµ≠Ïñ¥</option><option value="pt-BR">Portugu√™s (do&nbsp;Brasil)</option><option value="ru">–†—É—Å—Å–∫–∏–π</option><option value="zh-CN">‰∏≠Êñá (ÁÆÄ‰Ωì)</option></select> <button type="submit" class="button minimal">Change language</button></fieldset></form></div></aside></main><nav id="sidebar-quicklinks" class="sidebar"><h4>Related Topics</h4><div>

<ol>
  <li data-default-state="open"><a href="/en-US/docs/WebAssembly"><strong>WebAssembly home page</strong></a>
  </li><li class="toggle">
    <details open="">
      <summary>Tutorials</summary>
      <ol>
        <li><a href="/en-US/docs/WebAssembly/Concepts">WebAssembly concepts</a></li>
        <li><a href="/en-US/docs/WebAssembly/C_to_wasm">Compiling from C/C++ to WebAssembly</a></li>
        <li><a href="/en-US/docs/WebAssembly/Rust_to_wasm">Compiling from Rust to WebAssembly</a></li>
        <li><a href="/en-US/docs/WebAssembly/Using_the_JavaScript_API">Using the WebAssembly JavaScript API</a></li>
        <li><a href="/en-US/docs/WebAssembly/Understanding_the_text_format">Understanding WebAssembly text format</a></li>
        <li><a href="/en-US/docs/WebAssembly/Text_format_to_wasm">Converting WebAssembly text format to wasm</a></li>
        <li><a href="/en-US/docs/WebAssembly/Loading_and_running">Loading and running WebAssembly code</a></li>
        <li><a href="/en-US/docs/WebAssembly/Caching_modules">Caching compiled WebAssembly modules</a></li>
        <li><a href="/en-US/docs/WebAssembly/Exported_functions">Exported WebAssembly functions</a></li>
      </ol>
    </details>
  </li>
  <li class="toggle">
    <details open="">
      <summary>Object reference</summary>
      <ol>
        <li><a href="/en-US/docs/WebAssembly/JavaScript_interface"><code>WebAssembly</code></a></li>
        <li><a href="/en-US/docs/WebAssembly/JavaScript_interface/Module"><code>WebAssembly.Module</code></a></li>
        <li><a href="/en-US/docs/WebAssembly/JavaScript_interface/Global"><code>WebAssembly.Global</code></a></li>
        <li><a href="/en-US/docs/WebAssembly/JavaScript_interface/Instance"><code>WebAssembly.Instance</code></a></li>
        <li><a href="/en-US/docs/WebAssembly/JavaScript_interface/Memory"><code>WebAssembly.Memory</code></a></li>
        <li><a href="/en-US/docs/WebAssembly/JavaScript_interface/Table"><code>WebAssembly.Table</code></a></li>
        <li><a href="/en-US/docs/WebAssembly/JavaScript_interface/CompileError"><code>WebAssembly.CompileError</code></a></li>
        <li><a href="/en-US/docs/WebAssembly/JavaScript_interface/LinkError"><code>WebAssembly.LinkError</code></a></li>
        <li><a href="/en-US/docs/WebAssembly/JavaScript_interface/RuntimeError"><code>WebAssembly.RuntimeError</code></a></li>
      </ol>
    </details>
  </li>
</ol>

</div></nav></div><footer id="nav-footer" class="page-footer"><div class="content-container"><div class="page-footer-logo"><a href="/en-US/" class="logo" aria-label="MDN Web Docs"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 451.74 135" fill="#fff"><path d="M7.14 8.35v111.06h111.05V8.35zm103.71 56c-.48.92-1 1.79-1.46 2.71a3.44 3.44 0 01-3.54 2 2.4 2.4 0 00-1.55.5c-1.37.9-2.76 1.79-4.18 2.63a7.33 7.33 0 01-6.35.34 29.71 29.71 0 00-10.63-2 11.7 11.7 0 00-9.46 4.31 14.84 14.84 0 00-2.13 4.29c-1.24 3.07-2.3 21.38-2.3 26.05 0 0-17.62-3.42-34.15-20.34l4.31-11.32h-13.5l9.76-10.35h-16.8l9.77-10.34H12.69L30.45 34a40.9 40.9 0 0119.77-10.83c7.1-1.22 8.93-.53 13.31.77l2.43.73.85.25 3.1.95a12.56 12.56 0 006.21.09 11.37 11.37 0 018.25 1 8.24 8.24 0 014.1 6.22 7.29 7.29 0 003.61 5.49 59.45 59.45 0 009.32 4.11c2.27.86 4.54 1.84 6.79 2.72a6.81 6.81 0 012.86 2.06 4.81 4.81 0 011.1 2.73c.14 2 .37 4 .47 6a15.24 15.24 0 01-1.77 8.03zM320.12 39.62a5.42 5.42 0 00-4.53 2.13 7.36 7.36 0 00-1.7 4.43v2.36a6.28 6.28 0 001.7 4.46 5.63 5.63 0 004.3 1.82 5.12 5.12 0 004.57-2.27A9.7 9.7 0 00326 47a8.11 8.11 0 00-1.67-5.52 5.36 5.36 0 00-4.21-1.86zM387.38 39.53a5.52 5.52 0 00-4.7 2.15 8.8 8.8 0 00-1.63 5.49 9.23 9.23 0 001.58 5.45 5.38 5.38 0 004.7 2.25 5.61 5.61 0 004.74-2.2 8.91 8.91 0 001.68-5.59 8.24 8.24 0 00-1.75-5.52 5.76 5.76 0 00-4.62-2.03zM299.47 41.35a4.34 4.34 0 00-4-1.92 4.55 4.55 0 00-3.89 1.73 8.37 8.37 0 00-1.58 4.17h10.48a6.3 6.3 0 00-1.01-3.98zM357.74 30.75H352v23.31h5.72q5.47 0 8.35-3t2.93-8.65q0-5.43-2.88-8.55t-8.38-3.11z"></path><path d="M121.55 8.35v70.8h323V8.35zm42.21 22.45h-4V54h3.68v3.73h-11.25V54h3.31V36.79h-.19l-9.63 19.12h-2.12l-10-19.4h-.19V54h3.45v3.73h-11.15V54h3.68V30.8h-4v-3.73H133l11.66 22.56h.19l11.18-22.56h7.7zm29.12 22.67q-4.11 4.28-11.38 4.28h-14.06v-3.69h3.73V30.75h-3.73v-3.68h13.83q7.59 0 11.66 4.29a15.4 15.4 0 014 11 15.33 15.33 0 01-4.05 11.11zm38.89-22.67h-3.68v27h-2.6L208.08 35h-.19v19h4.67v3.73h-12.22V54h3.49V30.8h-4v-3.73h7.08l16.9 22.09h.19V30.8h-4.58v-3.73h12.32zm43.8 27h-3.31l-7.83-23.18h-.19l-7.55 23.18h-3.35l-8.78-27h-2.65v-3.73H253v3.73h-3.87L255 50.71h.23l6.61-19.91H259v-3.73h11v3.73h-2.78l6.61 20.1h.23l5.43-20.1h-4.15v-3.73h11v3.73h-2.54zm26.71-1.51a9.66 9.66 0 01-6.42 2 10.2 10.2 0 01-7.41-2.74c-1.89-1.82-2.83-4.47-2.83-7.93a12.37 12.37 0 012.64-8.12 9 9 0 017.32-3.21 8.62 8.62 0 016.75 2.69 9.65 9.65 0 012.45 6.52 13.67 13.67 0 01-.28 2.69H290q.29 6.71 6.18 6.7a5.2 5.2 0 003.71-1.18 5.82 5.82 0 001.67-2.83l3.45.71a7.21 7.21 0 01-2.73 4.65zm25.77-1.63c-1.51 2.4-3.92 3.61-7.22 3.61s-5.84-1.29-7.22-3.87c0 .25-.1.82-.21 1.7s-.19 1.44-.22 1.7H309c.16-1 .31-2 .47-3.07a21.42 21.42 0 00.24-3.16v-23h-3.4v-3.3h7.55V40.9a9.76 9.76 0 012.67-3.28 7.33 7.33 0 014.74-1.4 8.48 8.48 0 016.5 2.78q2.55 2.74 2.55 7.74a14.6 14.6 0 01-2.27 7.87zm41.39-1.14q-4.11 4.28-11.37 4.28H344v-3.74h3.73V30.75H344v-3.68h13.83q7.59 0 11.66 4.29a15.41 15.41 0 014.06 11 15.34 15.34 0 01-4.11 11.11zm25.65 1.68a10.53 10.53 0 01-7.9 3.07 10 10 0 01-7.63-3 10.93 10.93 0 01-2.8-7.83 12.13 12.13 0 012.69-7.93q2.69-3.3 8-3.3t8 3.28a12 12 0 012.64 7.76 10.86 10.86 0 01-3 7.9zm22.61.57c-1.4 1.66-3.63 2.5-6.68 2.5a9.58 9.58 0 01-7.15-2.76q-2.72-2.76-2.71-7.91a12.25 12.25 0 012.69-8 9.17 9.17 0 017.5-3.28 15 15 0 013.82.48 10.37 10.37 0 013.5 1.65l.85 5.47-3.35.38-.76-3.54a8.07 8.07 0 00-4.11-1 4.9 4.9 0 00-4.39 2.15 9.93 9.93 0 00-1.41 5.55 8.9 8.9 0 001.5 5.38 5.23 5.23 0 004.44 2c2.92 0 4.67-1.7 5.23-5.1l3.5.71a10.34 10.34 0 01-2.47 5.27zm20.48.75a11.68 11.68 0 01-6.63 1.75 15.52 15.52 0 01-8.26-2.08L424 51l3.26.33-.1 2.74a7 7 0 002.06.66 12.63 12.63 0 002.19.19 8.68 8.68 0 003.66-.75 2.5 2.5 0 001.63-2.36 2.25 2.25 0 00-1.32-2.2 12.65 12.65 0 00-3.28-1 47.39 47.39 0 01-3.9-.82 7.5 7.5 0 01-3.25-1.7 4.67 4.67 0 01-1.33-3.66c0-2.36.88-4 2.62-4.91a12 12 0 015.6-1.37 15 15 0 014.08.55 16.65 16.65 0 013.47 1.39l.47 5.1-3.3.37-.48-3.3a9.5 9.5 0 00-4.06-.9 5.62 5.62 0 00-2.87.66 2.33 2.33 0 00-1.15 2.25 2.13 2.13 0 001.3 2.07 11.91 11.91 0 003.21.92 36.69 36.69 0 013.82.83 7.46 7.46 0 013.21 1.74 4.9 4.9 0 011.3 3.73 5.56 5.56 0 01-2.66 4.91z"></path><path d="M181.17 30.75h-5.71v23.31h5.71q5.47 0 8.36-3t2.88-8.61q0-5.43-2.88-8.55t-8.36-3.15zM121.63 119.32V81.74h114.91v37.58zM153.22 109h-2v-6.85a4.8 4.8 0 00-1.58-4 5.57 5.57 0 00-3.55-1.26 5 5 0 00-4.92 3.26 4.19 4.19 0 00-1.88-2.46 5.82 5.82 0 00-3-.8 4.89 4.89 0 00-4.56 2.56v-2.21h-6.28v3.26h2v8.5h-2v3.23h9.11V109h-2.86v-5.25a4.4 4.4 0 01.69-2.56 2.47 2.47 0 012.21-1q2.57 0 2.56 3.63v8.41h6.29V109h-2v-5.25a4.47 4.47 0 01.67-2.56 2.42 2.42 0 012.19-1q2.63 0 2.63 3.63v8.41h6.28zm9.88-12.07q-4 0-6 2.36a8.41 8.41 0 00-2 5.66 7.25 7.25 0 002.17 5.62 8 8 0 005.65 2 8.54 8.54 0 005.94-2.11 7.27 7.27 0 002.34-5.67 8.21 8.21 0 00-2-5.51q-2.07-2.34-6.1-2.34zm-.1 12.35a3 3 0 01-2.63-1.33 5.68 5.68 0 01-.9-3.26 5 5 0 011-3.28 3.23 3.23 0 012.61-1.18 3.5 3.5 0 012.59 1.08 4.56 4.56 0 011.07 3.31 5.21 5.21 0 01-1 3.41 3.33 3.33 0 01-2.74 1.25zm25-2.3l-3.39-.29-.7 2.32H179l8.32-9.54-.32-2.23h-13.19l-.53 5.25 3.16.34.67-2.36h4.65l-8.25 9.53.44 2.26h13.13zm7.62-9.74h-4.46v5.39h4.46zm0 9.61h-4.46v5.39h4.46zm13.54-17.49h-4.23l-6.48 22.88h4.22zm8.68 0h-4.23l-6.45 22.88h4.19zm15 22.51l-.07-2.26a1.22 1.22 0 01-.56.1c-.69 0-1-.39-1-1.16v-6.49a4.39 4.39 0 00-1.8-3.84 7 7 0 00-4.16-1.28 14.55 14.55 0 00-3.16.3 24.14 24.14 0 00-3.29 1.06l-.56 3.46 3.39.4.5-1.69a2.78 2.78 0 011.08-.37 11.3 11.3 0 011.25-.07c1.19 0 1.89.37 2.09 1.1a8.55 8.55 0 01.3 2.26v.5a8.91 8.91 0 00-1.18-.11h-1.21a12.64 12.64 0 00-4.81.88 3.53 3.53 0 00-2.18 3.64 3.66 3.66 0 001.48 3.33 5.63 5.63 0 003.11 1 4.67 4.67 0 003-.91 6.78 6.78 0 001.8-2 3 3 0 003.33 3 5.54 5.54 0 002.66-.85zm-9.25-2.32a1.69 1.69 0 01-1.36-.52 1.81 1.81 0 01-.43-1.21 1.67 1.67 0 01.86-1.68 4.63 4.63 0 012-.42 7.69 7.69 0 011.07.07l1.06.13a3.58 3.58 0 01-1.08 2.74 3.24 3.24 0 01-2.11.89z"></path></svg></a></div><ul class="link-list-mdn"><li><a href="/en-US/docs/Web">Web Technologies</a></li><li><a href="/en-US/docs/Learn">Learn Web Development</a></li><li><a href="/en-US/docs/MDN/About">About MDN</a></li><li><a href="/en-US/docs/MDN/Feedback">Feedback</a></li></ul><ul class="link-list-moz"><li><a href="https://www.mozilla.org/about/" target="_blank" rel="noopener noreferrer">About</a></li><li><a href="https://shop.spreadshirt.com/mdn-store/" target="_blank" rel="noopener noreferrer">MDN Web Docs Store</a></li><li><a href="https://www.mozilla.org/contact/" target="_blank" rel="noopener noreferrer">Contact Us</a></li><li><a href="https://www.mozilla.org/firefox/?utm_source=developer.mozilla.org&amp;utm_campaign=footer&amp;utm_medium=referral" target="_blank" rel="noopener noreferrer">Firefox</a></li></ul><div class="social social-mdn"><h4>MDN</h4><ul><li><a class="social-icon twitter" href="https://twitter.com/mozdevnet" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">MDN on Twitter</span></a></li><li><a class="social-icon github" href="https://github.com/mdn/" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">MDN on Github</span></a></li></ul></div><div class="social social-moz"><h4>Mozilla</h4><ul><li><a class="social-icon twitter" href="https://twitter.com/mozilla" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">Mozilla on Twitter</span></a></li><li><a class="social-icon instagram" href="https://www.instagram.com/mozillagram/" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">Mozilla on Instagram</span></a></li></ul></div><p id="license" class="footer-license">¬© 2005-<!-- -->2022<!-- --> Mozilla and individual contributors. Content is available under<!-- --> <a href="/docs/MDN/About#Copyrights_and_licenses">these licenses</a>.</p><ul class="footer-legal"><li><a href="https://www.mozilla.org/about/legal/terms/mozilla" target="_blank" rel="noopener noreferrer">Terms</a></li><li><a href="https://www.mozilla.org/privacy/websites/" target="_blank" rel="noopener noreferrer">Privacy</a></li><li><a href="https://www.mozilla.org/privacy/websites/#cookies" target="_blank" rel="noopener noreferrer">Cookies</a></li></ul></div></footer><div class="page-overlay hidden"></div></div><script type="application/json" id="hydration">{"doc":{"isMarkdown":true,"isTranslated":false,"isActive":true,"flaws":{},"title":"Understanding WebAssembly text format","mdn_url":"/en-US/docs/WebAssembly/Understanding_the_text_format","locale":"en-US","native":"English (US)","sidebarHTML":"\n\n<ol>\n  <li data-default-state=\"open\"><a href=\"/en-US/docs/WebAssembly\"><strong>WebAssembly home page</strong></a>\n  </li><li class=\"toggle\">\n    <details open=\"\">\n      <summary>Tutorials</summary>\n      <ol>\n        <li><a href=\"/en-US/docs/WebAssembly/Concepts\">WebAssembly concepts</a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/C_to_wasm\">Compiling from C/C++ to WebAssembly</a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/Rust_to_wasm\">Compiling from Rust to WebAssembly</a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/Using_the_JavaScript_API\">Using the WebAssembly JavaScript API</a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/Understanding_the_text_format\">Understanding WebAssembly text format</a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/Text_format_to_wasm\">Converting WebAssembly text format to wasm</a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/Loading_and_running\">Loading and running WebAssembly code</a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/Caching_modules\">Caching compiled WebAssembly modules</a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/Exported_functions\">Exported WebAssembly functions</a></li>\n      </ol>\n    </details>\n  </li>\n  <li class=\"toggle\">\n    <details open=\"\">\n      <summary>Object reference</summary>\n      <ol>\n        <li><a href=\"/en-US/docs/WebAssembly/JavaScript_interface\"><code>WebAssembly</code></a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Module\"><code>WebAssembly.Module</code></a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Global\"><code>WebAssembly.Global</code></a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Instance\"><code>WebAssembly.Instance</code></a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Memory\"><code>WebAssembly.Memory</code></a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Table\"><code>WebAssembly.Table</code></a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/JavaScript_interface/CompileError\"><code>WebAssembly.CompileError</code></a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/JavaScript_interface/LinkError\"><code>WebAssembly.LinkError</code></a></li>\n        <li><a href=\"/en-US/docs/WebAssembly/JavaScript_interface/RuntimeError\"><code>WebAssembly.RuntimeError</code></a></li>\n      </ol>\n    </details>\n  </li>\n</ol>\n\n","body":[{"type":"prose","value":{"id":null,"title":null,"isH3":false,"content":"<p>To enable WebAssembly to be read and edited by humans, there is a textual representation of the wasm binary format. This is an intermediate form designed to be exposed in text editors, browser developer tools, etc. This article explains how that text format works, in terms of the raw syntax, and how it is related to the underlying bytecode it represents ‚Äî and the wrapper objects representing wasm in JavaScript.</p>\n<div class=\"notecard note\" id=\"sect1\">\n  <p><strong>Note:</strong> This is potentially overkill if you are a web developer who just wants to load a wasm module into a page and use it in your code (see <a href=\"/en-US/docs/WebAssembly/Using_the_JavaScript_API\">Using the WebAssembly JavaScript API</a>), but it is more useful if for example, you want to write wasm modules to optimize the performance of your JavaScript library, or build your own WebAssembly compiler.</p>\n</div>"}},{"type":"prose","value":{"id":"s-expressions","title":"S-expressions","isH3":false,"content":"<p>In both the binary and textual formats, the fundamental unit of code in WebAssembly is a module. In the text format, a module is represented as one big S-expression. S-expressions are a very old and very simple textual format for representing trees, and thus we can think of a module as a tree of nodes that describe the module's structure and its code. Unlike the Abstract Syntax Tree of a programming language, though, WebAssembly's tree is pretty flat, mostly consisting of lists of instructions.</p>\n<p>First, let's see what an S-expression looks like. Each node in the tree goes inside a pair of parentheses ‚Äî <code>( ... )</code>. The first label inside the parenthesis tells you what type of node it is, and after that there is a space-separated list of either attributes or child nodes. So that means the WebAssembly S-expression:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>represents a tree with the root node \"module\" and two child nodes, a \"memory\" node with the attribute \"1\" and a \"func\" node. We'll see shortly what these nodes actually mean.</p>"}},{"type":"prose","value":{"id":"the_simplest_module","title":"The simplest module","isH3":true,"content":"<p>Let's start with the simplest, shortest possible wasm module.</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>This module is totally empty, but is still a valid module.</p>\n<p>If we convert our module to binary now (see <a href=\"/en-US/docs/WebAssembly/Text_format_to_wasm\">Converting WebAssembly text format to wasm</a>), we'll see just the 8 byte module header described in the <a href=\"https://webassembly.github.io/spec/core/binary/index.html#high-level-structure\" class=\"external\" rel=\" noopener\">binary format</a>:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token number\">0000000</span>: <span class=\"token number\">0061</span> 736d              ; WASM_BINARY_MAGIC\n<span class=\"token number\">0000004</span>: <span class=\"token number\">0100</span> <span class=\"token number\">0000</span>              ; WASM_BINARY_VERSION\n</code></pre></div>"}},{"type":"prose","value":{"id":"adding_functionality_to_your_module","title":"Adding functionality to your module","isH3":true,"content":"<p>Ok, that's not very interesting, let's add some executable code to this module.</p>\n<p>All code in a webassembly module is grouped into functions, which have the following pseudocode structure:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span> <span class=\"token keyword\">func</span> &lt;signature&gt; &lt;locals&gt; &lt;body&gt; <span class=\"token punctuation\">)</span>\n</code></pre></div>\n<ul>\n  <li>The <strong>signature</strong> declares what the function takes (parameters) and returns (return values).</li>\n  <li>The <strong>locals</strong> are like vars in JavaScript, but with explicit types declared.</li>\n  <li>The <strong>body</strong> is just a linear list of low-level instructions.</li>\n</ul>\n<p>So this is similar to functions in other languages, even if it looks different because it is an S-expression.</p>"}},{"type":"prose","value":{"id":"signatures_and_parameters","title":"Signatures and parameters","isH3":false,"content":"<p>The signature is a sequence of parameter type declarations followed by a list of return type declarations. It is worth noting here that:</p>\n<ul>\n  <li>The absence of a <code>(result)</code> means the function doesn't return anything.</li>\n  <li>In the current iteration, there can be at most 1 return type, but <a href=\"https://github.com/WebAssembly/spec/blob/master/proposals/multi-value/Overview.md\" class=\"external\" rel=\" noopener\">later this will be relaxed</a> to any number.</li>\n</ul>\n<p>\n  Each parameter has a type explicitly declared; wasm <a href=\"#number_types\">Number types</a>, <a href=\"#reference_types\">Reference types</a>, <a href=\"#vector_types\">Vector types</a>.\n  The number types are:\n</p>\n<ul>\n  <li><code>i32</code>: 32-bit integer</li>\n  <li><code>i64</code>: 64-bit integer</li>\n  <li><code>f32</code>: 32-bit float</li>\n  <li><code>f64</code>: 64-bit float</li>\n</ul>\n<p>A single parameter is written <code>(param i32)</code> and the return type is written <code>(result i32)</code>, hence a binary function that takes two 32-bit integers and returns a 64-bit float would be written like this:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">)</span> ...<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>After the signature, locals are listed with their type, for example <code>(local i32)</code>. Parameters are basically just locals that are initialized with the value of the corresponding argument passed by the caller.</p>"}},{"type":"prose","value":{"id":"getting_and_setting_locals_and_parameters","title":"Getting and setting locals and parameters","isH3":false,"content":"<p>Locals/parameters can be read and written by the body of the function with the <code>local.get</code> and <code>local.set</code> instructions.</p>\n<p>The <code>local.get</code>/<code>local.set</code> commands refer to the item to be got/set by its numeric index: parameters are referred to first, in order of their declaration, followed by locals in order of their declaration. So given the following function:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">f32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token number\">0</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token number\">1</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>The instruction <code>local.get 0</code> would get the i32 parameter, <code>local.get 1</code> would get the f32 parameter, and <code>local.get 2</code> would get the f64 local.</p>\n<p>There is another issue here ‚Äî using numeric indices to refer to items can be confusing and annoying, so the text format allows you to name parameters, locals, and most other items by including a name prefixed by a dollar symbol (<code>$</code>) just before the type declaration.</p>\n<p>Thus, you could rewrite our previous signature like so:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$p1</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$p2</span> <span class=\"token keyword\">f32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span> <span class=\"token variable\">$loc</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">)</span> ‚Ä¶<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>And then could write <code>local.get $p1</code> instead of <code>local.get 0</code>, etc. (Note that when this text gets converted to binary, though, the binary will contain only the integer.)</p>"}},{"type":"prose","value":{"id":"stack_machines","title":"Stack machines","isH3":false,"content":"<p>Before we can write a function body, we have to talk about one more thing: <strong>stack machines</strong>. Although the browser compiles it to something more efficient, wasm execution is defined in terms of a stack machine where the basic idea is that every type of instruction pushes and/or pops a certain number of <code>i32</code>/<code>i64</code>/<code>f32</code>/<code>f64</code> values to/from a stack.</p>\n<p>For example, <code>local.get</code> is defined to push the value of the local it read onto the stack, and <code>i32.add</code> pops two <code>i32</code> values (it implicitly grabs the previous two values pushed onto the stack), computes their sum (modulo 2^32) and pushes the resulting i32 value.</p>\n<p>When a function is called, it starts with an empty stack which is gradually filled up and emptied as the body's instructions are executed. So for example, after executing the following function:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$p</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$p</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$p</span>\n  <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>The stack contains exactly one <code>i32</code> value ‚Äî the result of the expression (<code>$p + $p</code>), which is handled by <code>i32.add</code>. The return value of a function is just the final value left on the stack.</p>\n<p>The WebAssembly validation rules ensure the stack matches exactly: if you declare a <code>(result f32)</code>, then the stack must contain exactly one <code>f32</code> at the end. If there is no result type, the stack must be empty.</p>"}},{"type":"prose","value":{"id":"our_first_function_body","title":"Our first function body","isH3":false,"content":"<p>As mentioned before, the function body is a list of instructions that are followed as the function is called. Putting this together with what we have already learned, we can finally define a module containing our own simple function:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$lhs</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$rhs</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$lhs</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$rhs</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>This function gets two parameters, adds them together, and returns the result.</p>\n<p>There are a lot more things that can be put inside function bodies, but we will start off simple for now, and you'll see a lot more examples as you go along. For a full list of the available opcodes, consult the <a href=\"https://webassembly.github.io/spec/core/exec/index.html\" class=\"external\" rel=\" noopener\">webassembly.org Semantics reference</a>.</p>"}},{"type":"prose","value":{"id":"calling_the_function","title":"Calling the function","isH3":true,"content":"<p>Our function won't do very much on its own ‚Äî now we need to call it. How do we do that? Like in an ES module, wasm functions must be explicitly exported by an <code>export</code> statement inside the module.</p>\n<p>Like locals, functions are identified by an index by default, but for convenience, they can be named. Let's start by doing this ‚Äî first, we'll add a name preceded by a dollar sign, just after the <code>func</code> keyword:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$add</span> ‚Ä¶<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>Now we need to add an export declaration ‚Äî this looks like so:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"add\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$add</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>Here, <code>add</code> is the name the function will be identified by in JavaScript whereas <code>$add</code> picks out which WebAssembly function inside the Module is being exported.</p>\n<p>So our final module (for now) looks like this:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$add</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$lhs</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$rhs</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$lhs</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$rhs</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"add\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$add</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>If you want to follow along with the example, save the above our module into a file called <code>add.wat</code>, then convert it into a binary file called <code>add.wasm</code> using wabt (see <a href=\"/en-US/docs/WebAssembly/Text_format_to_wasm\">Converting WebAssembly text format to wasm</a> for details).</p>\n<p>Next, we'll load our binary into a typed array called <code>addCode</code> (as described in <a href=\"/en-US/docs/WebAssembly/Loading_and_running\">Fetching WebAssembly Bytecode</a>), compile and instantiate it, and execute our <code>add</code> function in JavaScript (we can now find <code>add()</code> in the <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Instance/exports\"><code>exports</code></a> property of the instance):</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"add.wasm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"3\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect2\">\n  <p><strong>Note:</strong> You can find this example in GitHub as <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/add.html\" class=\"external\" rel=\" noopener\">add.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/add.html\" class=\"external\" rel=\" noopener\">see it live also</a>). Also see <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/instantiateStreaming\"><code>WebAssembly.instantiateStreaming()</code></a> for more details about the instantiate function.</p>\n</div>"}},{"type":"prose","value":{"id":"exploring_fundamentals","title":"Exploring fundamentals","isH3":false,"content":"<p>Now we've covered the real basics, let's move on to look at some more advanced features.</p>"}},{"type":"prose","value":{"id":"calling_functions_from_other_functions_in_the_same_module","title":"Calling functions from other functions in the same module","isH3":true,"content":"<p>The <code>call</code> instruction calls a single function, given its index or name. For example, the following module contains two functions ‚Äî one just returns the value 42, the other returns the result of calling the first plus one:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$getAnswer</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"getAnswerPlus1\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">call</span> <span class=\"token variable\">$getAnswer</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect3\">\n  <p><strong>Note:</strong> <code>i32.const</code> just defines a 32-bit integer and pushes it onto the stack. You could swap out the <code>i32</code> for any of the other available types, and change the value of the const to whatever you like (here we've set the value to <code>42</code>).</p>\n</div>\n<p>In this example you'll notice an <code>(export \"getAnswerPlus1\")</code> section, declared just after the <code>func</code> statement in the second function ‚Äî this is a shorthand way of declaring that we want to export this function, and defining the name we want to export it as.</p>\n<p>This is functionally equivalent to including a separate function statement outside the function, elsewhere in the module in the same manner as we did before, e.g.:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"getAnswerPlus1\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$functionName</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>The JavaScript code to call our above module looks like so:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"call.wasm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">getAnswerPlus1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"43\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>"}},{"type":"prose","value":{"id":"importing_functions_from_javascript","title":"Importing functions from JavaScript","isH3":true,"content":"<p>We have already seen JavaScript calling WebAssembly functions, but what about WebAssembly calling JavaScript functions? WebAssembly doesn't actually have any built-in knowledge of JavaScript, but it does have a general way to import functions that can accept either JavaScript or wasm functions. Let's look at an example:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"console\"</span> <span class=\"token string\">\"log\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$log</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"logIt\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">13</span>\n    <span class=\"token keyword\">call</span> <span class=\"token variable\">$log</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>WebAssembly has a two-level namespace so the import statement here is saying that we're asking to import the <code>log</code> function from the <code>console</code> module. You can also see that the exported <code>logIt</code> function calls the imported function using the <code>call</code> instruction we introduced above.</p>\n<p>Imported functions are just like normal functions: they have a signature that WebAssembly validation checks statically, and they are given an index and can be named and called.</p>\n<p>JavaScript functions have no notion of signature, so any JavaScript function can be passed, regardless of the import's declared signature. Once a module declares an import, the caller of <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/instantiate\"><code>WebAssembly.instantiate()</code></a> must pass in an import object that has the corresponding properties.</p>\n<p>For the above, we need an object (let's call it <code>importObject</code>) such that <code>importObject.console.log</code> is a JavaScript function.</p>\n<p>This would look like the following:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">const</span> importObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">console</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nWebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"logger.wasm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">logIt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect4\">\n  <p><strong>Note:</strong> You can find this example on GitHub as <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/logger.html\" class=\"external\" rel=\" noopener\">logger.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/logger.html\" class=\"external\" rel=\" noopener\">see it live also</a>).</p>\n</div>"}},{"type":"prose","value":{"id":"declaring_globals_in_webassembly","title":"Declaring globals in WebAssembly","isH3":true,"content":"<p>WebAssembly has the ability to create global variable instances, accessible from both JavaScript and importable/exportable across one or more <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Module\"><code>WebAssembly.Module</code></a> instances. This is very useful, as it allows dynamic linking of multiple modules.</p>\n<p>In WebAssembly text format, it looks something like this (see <a href=\"https://github.com/mdn/webassembly-examples/blob/master/js-api-examples/global.wat\" class=\"external\" rel=\" noopener\">global.wat</a> in our GitHub repo; also see <a href=\"https://mdn.github.io/webassembly-examples/js-api-examples/global.html\" class=\"external\" rel=\" noopener\">global.html</a> for a live JavaScript example):</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n   <span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span> <span class=\"token variable\">$g</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"global\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"getGlobal\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span>.get <span class=\"token variable\">$g</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"incGlobal\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span>.set <span class=\"token variable\">$g</span>\n            <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span>.get <span class=\"token variable\">$g</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>This looks similar to what we've seen before, except that we specify a global value using the keyword <code>global</code>, and we also specify the keyword <code>mut</code> along with the value's datatype if we want it to be mutable.</p>\n<p>To create an equivalent value using JavaScript, you'd use the <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Global\"><code>WebAssembly.Global()</code></a> constructor:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">const</span> global <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Global</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token string\">\"i32\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">mutable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>"}},{"type":"prose","value":{"id":"webassembly_memory","title":"WebAssembly Memory","isH3":true,"content":"<p>The above example is a pretty terrible logging function: it only prints a single integer! What if we wanted to log a text string? To deal with strings and other more complex data types, WebAssembly provides <strong>memory</strong> (although we also have <a href=\"#reference_types\">Reference types</a> in newer implementation of WebAssembly). According to WebAssembly, memory is just a large array of bytes that can grow over time. WebAssembly contains instructions like <code>i32.load</code> and <code>i32.store</code> for reading and writing from <a href=\"https://webassembly.github.io/spec/core/exec/index.html#linear-memory\" class=\"external\" rel=\" noopener\">linear memory</a>.</p>\n<p>From JavaScript's point of view, it's as though memory is all inside one big (resizable) <a href=\"/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\"><code>ArrayBuffer</code></a>. That's literally all that asm.js has to play with (except that it isn't resizable; see the asm.js <a href=\"http://asmjs.org/spec/latest/#programming-model\" class=\"external\" rel=\" noopener\">Programming model</a>).</p>\n<p>So a string is just a sequence of bytes somewhere inside this linear memory. Let's assume that we've written a suitable string of bytes to memory; how do we pass that string out to JavaScript?</p>\n<p>The key is that JavaScript can create WebAssembly linear memory instances via the <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Memory\"><code>WebAssembly.Memory()</code></a> interface, and access an existing memory instance (currently you can only have one per module instance) using the associated instance methods. Memory instances have a <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Memory/buffer\"><code>buffer</code></a> getter, which returns an <code>ArrayBuffer</code> that points at the whole linear memory.</p>\n<p>Memory instances can also grow, for example via the <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Memory/grow\"><code>Memory.grow()</code></a> method in JavaScript. When growth occurs, since <code>ArrayBuffer</code>s can't change size, the current <code>ArrayBuffer</code> is detached and a new <code>ArrayBuffer</code> is created to point to the newer, bigger memory. This means all we need to do to pass a string to JavaScript is to pass out the offset of the string in linear memory along with some way to indicate the length.</p>\n<p>While there are many ways to encode a string's length in the string itself (for example, C strings); for simplicity here we just pass both offset and length as parameters:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"console\"</span> <span class=\"token string\">\"log\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$log</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>On the JavaScript side, we can use the <a href=\"/en-US/docs/Web/API/TextDecoder\">TextDecoder API</a> to easily decode our bytes into a JavaScript string. (We specify <code>utf8</code> here, but many other encodings are supported.)</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">consoleLogString</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">offset<span class=\"token punctuation\">,</span> length</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> bytes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>memory<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> string <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextDecoder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"utf8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The last missing piece of the puzzle is where <code>consoleLogString</code> gets access to the WebAssembly <code>memory</code>. WebAssembly gives us a lot of flexibility here: we can either create a <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Memory\"><code>Memory</code></a> object in JavaScript and have the WebAssembly module import the memory, or we can have the WebAssembly module create the memory and export it to JavaScript.</p>\n<p>For simplicity, let's create it in JavaScript then import it into WebAssembly. Our <code>import</code> statement is written as follows:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"mem\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>The <code>1</code> indicates that the imported memory must have at least 1 page of memory (WebAssembly defines a page to be 64KB.)</p>\n<p>So let's see a complete module that prints the string \"Hi\". In a normal compiled C program, you'd call a function to allocate some memory for the string, but since we're just writing our own assembly here and we own the entire linear memory, we can just write the string contents into global memory using a <code>data</code> section. Data sections allow a string of bytes to be written at a given offset at instantiation time and are similar to the <code>.data</code> sections in native executable formats.</p>\n<p>Our final wasm module looks like this:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"console\"</span> <span class=\"token string\">\"log\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$log</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"mem\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">data</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"Hi\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"writeHi\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span>  <span class=\"token comment\">;; pass offset 0 to log</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">2</span>  <span class=\"token comment\">;; pass length 2 to log</span>\n    <span class=\"token keyword\">call</span> <span class=\"token variable\">$log</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect5\">\n  <p><strong>Note:</strong> Above, note the double semicolon syntax (<code>;;</code>) for allowing comments in WebAssembly files.</p>\n</div>\n<p>Now from JavaScript we can create a Memory with 1 page and pass it in. This results in \"Hi\" being printed to the console:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">const</span> memory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Memory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> importObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">console</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">log</span><span class=\"token operator\">:</span> consoleLogString <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">js</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">mem</span><span class=\"token operator\">:</span> memory <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nWebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"logger2.wasm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">writeHi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect6\">\n  <p><strong>Note:</strong> You can find the full source on GitHub as <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/logger2.html\" class=\"external\" rel=\" noopener\">logger2.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/logger2.html\" class=\"external\" rel=\" noopener\">also see it live</a>).</p>\n</div>"}},{"type":"prose","value":{"id":"webassembly_tables","title":"WebAssembly tables","isH3":true,"content":"<p>To finish this tour of the WebAssembly text format, let's look at the most intricate, and often confusing, part of WebAssembly: <strong>tables</strong>. Tables are basically resizable arrays of references that can be accessed by index from WebAssembly code.</p>\n<p>To see why tables are needed, we need to first observe that the <code>call</code> instruction we saw earlier (see <a href=\"#calling_functions_from_other_functions_in_the_same_module\">Calling functions from other functions in the same module</a>) takes a static function index and thus can only ever call one function ‚Äî but what if the callee is a runtime value?</p>\n<ul>\n  <li>In JavaScript, we see this all the time: functions are first-class values.</li>\n  <li>In C/C++, we see this with function pointers.</li>\n  <li>In C++, we see this with virtual functions.</li>\n</ul>\n<p>WebAssembly needed a type of call instruction to achieve this, so we gave it <code>call_indirect</code>, which takes a dynamic function operand. The problem is that the only types we have to give operands in WebAssembly are (currently) <code>i32</code>/<code>i64</code>/<code>f32</code>/<code>f64</code>.</p>\n<p>WebAssembly could add an <code>anyfunc</code> type (\"any\" because the type could hold functions of any signature), but unfortunately this <code>anyfunc</code> type couldn't be stored in linear memory for security reasons. Linear memory exposes the raw contents of stored values as bytes and this would allow wasm content to arbitrarily observe and corrupt raw function addresses, which is something that cannot be allowed on the web.</p>\n<p>The solution was to store function references in a table and pass around table indices instead, which are just i32 values. <code>call_indirect</code>'s operand can therefore be an i32 index value.</p>\n<h4 id=\"defining_a_table_in_wasm\">Defining a table in wasm</h4>\n<p>So how do we place wasm functions in our table? Just like <code>data</code> sections can be used to initialize regions of linear memory with bytes, <code>elem</code> sections can be used to initialize regions of tables with functions:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">table</span> <span class=\"token number\">2</span> funcref<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">elem</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$f1</span> <span class=\"token variable\">$f2</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$f1</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$f2</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">13</span><span class=\"token punctuation\">)</span>\n  ...\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<ul>\n  <li>In <code>(table 2 funcref)</code>, the 2 is the initial size of the table (meaning it will store two references) and <code>funcref</code> declares that the element type of these references are function reference.</li>\n  <li>The functions (<code>func</code>) sections are just like any other declared wasm functions. These are the functions we are going to refer to in our table (for example's sake, each one just returns a constant value). Note that the order the sections are declared in doesn't matter here ‚Äî you can declare your functions anywhere and still refer to them in your <code>elem</code> section.</li>\n  <li>The <code>elem</code> section can list any subset of the functions in a module, in any order, allowing duplicates. This is a list of the functions that are to be referenced by the table, in the order they are to be referenced.</li>\n  <li>The <code>(i32.const 0)</code> value inside the <code>elem</code> section is an offset ‚Äî this needs to be declared at the start of the section, and specifies at what index in the table function references start to be populated. Here we've specified 0, and a size of 2 (see above), so we can fill in two references at indexes 0 and 1. If we wanted to start writing our references at offset 1, we'd have to write <code>(i32.const 1)</code>, and the table size would have to be 3.</li>\n</ul>\n<div class=\"notecard note\" id=\"sect7\">\n  <p><strong>Note:</strong> Uninitialized elements are given a default throw-on-call value.</p>\n</div>\n<p>In JavaScript, the equivalent calls to create such a table instance would look something like this:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// table section</span>\n  <span class=\"token keyword\">const</span> tbl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Table</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">element</span><span class=\"token operator\">:</span> <span class=\"token string\">\"anyfunc\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// function sections:</span>\n  <span class=\"token keyword\">const</span> f1 <span class=\"token operator\">=</span> <span class=\"token operator\">...</span> <span class=\"token comment\">/* some imported WebAssembly function */</span>\n  <span class=\"token keyword\">const</span> f2 <span class=\"token operator\">=</span> <span class=\"token operator\">...</span> <span class=\"token comment\">/* some imported WebAssembly function */</span>\n\n  <span class=\"token comment\">// elem section</span>\n  tbl<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> f1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  tbl<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> f2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h4 id=\"using_the_table\">Using the table</h4>\n<p>Moving on, now we've defined the table we need to use it somehow. Let's use this section of code to do so:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">;; if this was f32, type checking would fail</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"callByIndex\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$i</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$i</span>\n  <span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<ul>\n  <li>The <code>(type $return_i32 (func (result i32)))</code> block specifies a type, with a reference name. This type is used when performing type checking of the table function reference calls later on. Here we are saying that the references need to be functions that return an <code>i32</code> as a result.</li>\n  <li>Next, we define a function that will be exported with the name <code>callByIndex</code>. This will take one <code>i32</code> as a parameter, which is given the argument name <code>$i</code>.</li>\n  <li>Inside the function, we add one value to the stack ‚Äî whatever value is passed in as the parameter <code>$i</code>.</li>\n  <li>Finally, we use <code>call_indirect</code> to call a function from the table ‚Äî it implicitly pops the value of <code>$i</code> off the stack. The net result of this is that the <code>callByIndex</code> function invokes the <code>$i</code>'th function in the table.</li>\n</ul>\n<p>You could also declare the <code>call_indirect</code> parameter explicitly during the command call instead of before it, like this:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span>.get <span class=\"token variable\">$i</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>In a higher level, more expressive language like JavaScript, you could imagine doing the same thing with an array (or probably more likely, object) containing functions. The pseudocode would look something like <code>tbl[i]()</code>.</p>\n<p>So, back to the typechecking. Since WebAssembly is type checked, and the <code>funcref</code> can be potentially any function signature, we have to supply the presumed signature of the callee at the callsite, hence we include the <code>$return_i32</code> type, to tell the program a function returning an <code>i32</code> is expected. If the callee doesn't have a matching signature (say an <code>f32</code> is returned instead), a <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/RuntimeError\"><code>WebAssembly.RuntimeError</code></a> is thrown.</p>\n<p>So what links the <code>call_indirect</code> to the table we are calling? The answer is that there is only one table allowed right now per module instance, and that is what <code>call_indirect</code> is implicitly calling. In the future, when multiple tables are allowed, we would also need to specify a table identifier of some kind, along the lines of</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token keyword\">call_indirect</span> <span class=\"token variable\">$my_spicy_table</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$i32_to_void</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>The full module all together looks like this, and can be found in our <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/wasm-table.wat\" class=\"external\" rel=\" noopener\">wasm-table.wat</a> example file:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">table</span> <span class=\"token number\">2</span> funcref<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$f1</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$f2</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">13</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">elem</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$f1</span> <span class=\"token variable\">$f2</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"callByIndex\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$i</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$i</span>\n    <span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>We load it into a webpage using the following JavaScript:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"wasm-table.wasm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">callByIndex</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns 42</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">callByIndex</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns 13</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">callByIndex</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns an error, because there is no index position 2 in the table</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect8\">\n  <p><strong>Note:</strong> You can find this example on GitHub as <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/wasm-table.html\" class=\"external\" rel=\" noopener\">wasm-table.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/wasm-table.html\" class=\"external\" rel=\" noopener\">see it live also</a>).</p>\n</div>\n<div class=\"notecard note\" id=\"sect9\">\n  <p><strong>Note:</strong> Just like Memory, Tables can also be created from JavaScript (see <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Table\"><code>WebAssembly.Table()</code></a>) as well as imported to/from another wasm module.</p>\n</div>"}},{"type":"prose","value":{"id":"mutating_tables_and_dynamic_linking","title":"Mutating tables and dynamic linking","isH3":true,"content":"<p>Because JavaScript has full access to function references, the Table object can be mutated from JavaScript using the <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Table/grow\"><code>grow()</code></a>, <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Table/get\"><code>get()</code></a> and <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Table/set\"><code>set()</code></a> methods. And WebAssembly code is itself able to manipulate tables using instructions added as part of <a href=\"#reference_types\">Reference types</a>, such as <code>table.get</code> and <code>table.set</code>.</p>\n<p>Because tables are mutable, they can be used to implement sophisticated load-time and run-time <a href=\"https://github.com/WebAssembly/tool-conventions/blob/main/DynamicLinking.md\" class=\"external\" rel=\" noopener\">dynamic linking schemes</a>. When a program is dynamically linked, multiple instances share the same memory and table. This is symmetric to a native application where multiple compiled <code>.dll</code>s share a single process's address space.</p>\n<p>To see this in action, we'll create a single import object containing a Memory object and a Table object, and pass this same import object to multiple <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/instantiate\"><code>instantiate()</code></a> calls.</p>\n<p>Our <code>.wat</code> examples look like so:</p>\n<p><code>shared0.wat</code>:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"memory\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"table\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">table</span> <span class=\"token number\">1</span> funcref<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">elem</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$shared0func</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$shared0func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>load</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p><code>shared1.wat</code>:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"memory\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"table\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">table</span> <span class=\"token number\">1</span> funcref<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$void_to_i32</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"doIt\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>store</span>  <span class=\"token comment\">;; store 42 at address 0</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span>\n   <span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$void_to_i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>These work as follows:</p>\n<ol>\n  <li>The function <code>shared0func</code> is defined in <code>shared0.wat</code>, and stored in our imported table.</li>\n  <li>This function creates a constant containing the value <code>0</code>, and then uses the <code>i32.load</code> command to load the value contained in the provided memory index. The index provided is <code>0</code> ‚Äî again, it implicitly pops the previous value off the stack. So <code>shared0func</code> loads and returns the value stored at memory index <code>0</code>.</li>\n  <li>In <code>shared1.wat</code>, we export a function called <code>doIt</code> ‚Äî this function creates two constants containing the values <code>0</code> and <code>42</code>, then calls <code>i32.store</code> to store a provided value at a provided index of the imported memory. Again, it implicitly pops these values off the stack, so the result is that it stores the value <code>42</code> in memory index <code>0</code>,</li>\n  <li>In the last part of the function, we create a constant with value <code>0</code>, then call the function at this index 0 of the table, which is <code>shared0func</code>, stored there earlier by the <code>elem</code> block in <code>shared0.wat</code>.</li>\n  <li>When called, <code>shared0func</code> loads the <code>42</code> we stored in memory using the <code>i32.store</code> command in <code>shared1.wat</code>.</li>\n</ol>\n<div class=\"notecard note\" id=\"sect10\">\n  <p><strong>Note:</strong> The above expressions again pop values from the stack implicitly, but you could declare these explicitly inside the command calls instead, for example:</p>\n  <div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>store</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$void_to_i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n</div>\n<p>After converting to assembly, we then use <code>shared0.wasm</code> and <code>shared1.wasm</code> in JavaScript via the following code:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">const</span> importObj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">js</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">memory</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Memory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">table</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Table</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">element</span><span class=\"token operator\">:</span> <span class=\"token string\">\"anyfunc\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"shared0.wasm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"shared1.wasm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">results</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">doIt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// prints 42</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>Each of the modules that is being compiled can import the same memory and table objects and thus share the same linear memory and table \"address space\".</p>\n<div class=\"notecard note\" id=\"sect11\">\n  <p><strong>Note:</strong> You can find this example on GitHub as <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/shared-address-space.html\" class=\"external\" rel=\" noopener\">shared-address-space.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/shared-address-space.html\" class=\"external\" rel=\" noopener\">see it live also</a>).</p>\n</div>"}},{"type":"prose","value":{"id":"bulk_memory_operations","title":"Bulk memory operations","isH3":false,"content":"<p>Bulk memory operations are a newer addition to the language (for example, in <a href=\"/en-US/docs/Mozilla/Firefox/Releases/79\">Firefox 79</a>) ‚Äî seven new built-in operations are provided for bulk memory operations such as copying and initializing, to allow WebAssembly to model native functions such as <code>memcpy</code> and <code>memmove</code> in a more efficient, performant way.</p>\n<p>The new operations are:</p>\n<ul>\n  <li><code>data.drop</code>: Discard the data in an data segment.</li>\n  <li><code>elem.drop</code>: Discard the data in an element segment.</li>\n  <li><code>memory.copy</code>: Copy from one region of linear memory to another.</li>\n  <li><code>memory.fill</code>: Fill a region of linear memory with a given byte value.</li>\n  <li><code>memory.init</code>: Copy a region from a data segment.</li>\n  <li><code>table.copy</code>: Copy from one region of a table to another.</li>\n  <li><code>table.init</code>: Copy a region from an element segment.</li>\n</ul>\n<div class=\"notecard note\" id=\"sect12\">\n  <p><strong>Note:</strong> You can find more information in the <a href=\"https://github.com/WebAssembly/bulk-memory-operations/blob/master/proposals/bulk-memory-operations/Overview.md\" class=\"external\" rel=\" noopener\">Bulk Memory Operations and Conditional Segment Initialization</a> proposal.</p>\n</div>"}},{"type":"prose","value":{"id":"types","title":"Types","isH3":false,"content":""}},{"type":"prose","value":{"id":"number_types","title":"Number types","isH3":true,"content":"<p>Web assembly currently has four available <em>number types</em>:</p>\n<ul>\n  <li><code>i32</code>: 32-bit integer</li>\n  <li><code>i64</code>: 64-bit integer</li>\n  <li><code>f32</code>: 32-bit float</li>\n  <li><code>f64</code>: 64-bit float</li>\n</ul>"}},{"type":"prose","value":{"id":"vector_types","title":"Vector types","isH3":true,"content":"<ul>\n  <li><code>v128</code>: 128 bit vector of packed integer, floating-point data, or a single 128 bit type.</li>\n</ul>"}},{"type":"prose","value":{"id":"reference_types","title":"Reference types","isH3":true,"content":"<p>The <a href=\"https://github.com/WebAssembly/reference-types/blob/master/proposals/reference-types/Overview.md\" class=\"external\" rel=\" noopener\">reference types proposal</a> (supported in <a href=\"/en-US/docs/Mozilla/Firefox/Releases/79\">Firefox 79</a>) provides two main features:</p>\n<ul>\n  <li>A new type, <code>externref</code>, which can hold <em>any</em> JavaScript value, for example strings, DOM references, objects, etc. <code>externref</code> is opaque from the point of view of WebAssembly ‚Äî a wasm module can't access and manipulate these values and instead can only receive them and pass them back out. But this is very useful for allowing wasm modules to call JavaScript functions, DOM APIs, etc., and generally to pave the way for easier interoperability with the host environment. <code>externref</code> can be used for value types and table elements.</li>\n  <li>A number of new instructions that allow wasm modules to directly manipulate <a href=\"#webassembly_tables\">WebAssembly tables</a>, rather than having to do it via the JavaScript API.</li>\n</ul>\n<div class=\"notecard note\" id=\"sect13\">\n  <p><strong>Note:</strong> The <a href=\"https://rustwasm.github.io/docs/wasm-bindgen/\" class=\"external\" rel=\" noopener\">wasm-bindgen</a> documentation contains some useful information on how to take advantage of <code>externref</code> from Rust.</p>\n</div>"}},{"type":"prose","value":{"id":"multi-value_webassembly","title":"Multi-value WebAssembly","isH3":false,"content":"<p>Another more recent addition to the language (for example, in <a href=\"/en-US/docs/Mozilla/Firefox/Releases/78\">Firefox 78</a>) is WebAssembly multi-value, meaning that WebAssembly functions can now return multiple values, and instruction sequences can consume and produce multiple stack values.</p>\n<p>At the time of writing (June 2020) this is at an early stage, and the only multi-value instructions available are calls to functions that themselves return multiple values. For example:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$get_two_numbers</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">2</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"add_two_numbers\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">call</span> <span class=\"token variable\">$get_two_numbers</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>But this will pave the way for more useful instruction types, and other things besides. For a useful write-up of progress so far and how this works, see <a href=\"https://hacks.mozilla.org/2019/11/multi-value-all-the-wasm/\" class=\"external\" rel=\" noopener\">Multi-Value All The Wasm!</a> by Nick Fitzgerald.</p>"}},{"type":"prose","value":{"id":"webassembly_threads","title":"WebAssembly threads","isH3":false,"content":"<p>WebAssembly Threads (supported in <a href=\"/en-US/docs/Mozilla/Firefox/Releases/79\">Firefox 79</a> onwards) allow WebAssembly Memory objects to be shared across multiple WebAssembly instances running in separate Web Workers, in the same fashion as <a href=\"/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer\"><code>SharedArrayBuffer</code></a>s in JavaScript. This allows very fast communication between Workers, and significant performance gains in web applications.</p>\n<p>The threads proposal has two parts, shared memories and atomic memory accesses.</p>"}},{"type":"prose","value":{"id":"shared_memories","title":"Shared memories","isH3":true,"content":"<p>As described above, you can create shared WebAssembly <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Memory\"><code>Memory</code></a> objects, which can be transferred between Window and Worker contexts using <a href=\"/en-US/docs/Web/API/Window/postMessage\"><code>postMessage()</code></a>, in the same fashion as a <a href=\"/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer\"><code>SharedArrayBuffer</code></a>.</p>\n<p>Over on the JavaScript API side, the <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Memory/Memory\"><code>WebAssembly.Memory()</code></a> constructor's initialization object now has a <code>shared</code> property, which when set to <code>true</code> will create a shared memory:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">const</span> memory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Memory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">maximum</span><span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">shared</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>the memory's <a href=\"/en-US/docs/WebAssembly/JavaScript_interface/Memory/buffer\"><code>buffer</code></a> property will now return a <code>SharedArrayBuffer</code>, instead of the usual <code>ArrayBuffer</code>:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>memory<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns SharedArrayBuffer</span>\n</code></pre></div>\n<p>Over in the text format, you can create a shared memory using the <code>shared</code> keyword, like this:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span> <span class=\"token number\">2</span> shared<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>Unlike unshared memories, shared memories must specify a \"maximum\" size, in both the JavaScript API constructor and wasm text format.</p>\n<div class=\"notecard note\" id=\"sect14\">\n  <p><strong>Note:</strong> You can find a lot more details in the <a href=\"https://github.com/WebAssembly/threads/blob/master/proposals/threads/Overview.md\" class=\"external\" rel=\" noopener\">Threading proposal for WebAssembly</a>.</p>\n</div>"}},{"type":"prose","value":{"id":"atomic_memory_accesses","title":"Atomic memory accesses","isH3":true,"content":"<p>A number of new wasm instructions have been added that can be used to implement higher level features like mutexes, condition variables, etc. You can <a href=\"https://github.com/WebAssembly/threads/blob/master/proposals/threads/Overview.md#atomic-memory-accesses\" class=\"external\" rel=\" noopener\">find them listed here</a>. These instructions are allowed on non-shared memories as of Firefox 80.</p>\n<div class=\"notecard note\" id=\"sect15\">\n  <p><strong>Note:</strong> The <a href=\"https://emscripten.org/docs/porting/pthreads.html\" class=\"external\" rel=\" noopener\">Emscripten Pthreads support page</a> shows how to take advantage of this new functionality from Emscripten.</p>\n</div>"}},{"type":"prose","value":{"id":"summary","title":"Summary","isH3":false,"content":"<p>This finishes our high-level tour of the major components of the WebAssembly text format and how they get reflected in the WebAssembly JS API.</p>"}},{"type":"prose","value":{"id":"see_also","title":"See also","isH3":false,"content":"<ul>\n  <li>The main thing that wasn't included is a comprehensive list of all the instructions that can occur in function bodies. See the <a href=\"https://webassembly.github.io/spec/core/exec/index.html\" class=\"external\" rel=\" noopener\">WebAssembly semantics</a> for a treatment of each instruction.</li>\n  <li>See also the <a href=\"https://github.com/WebAssembly/spec/blob/master/interpreter/README.md#s-expression-syntax\" class=\"external\" rel=\" noopener\">grammar of the text format</a> that is implemented by the spec interpreter.</li>\n</ul>"}}],"toc":[{"text":"S-expressions","id":"s-expressions"},{"text":"Signatures and parameters","id":"signatures_and_parameters"},{"text":"Getting and setting locals and parameters","id":"getting_and_setting_locals_and_parameters"},{"text":"Stack machines","id":"stack_machines"},{"text":"Our first function body","id":"our_first_function_body"},{"text":"Exploring fundamentals","id":"exploring_fundamentals"},{"text":"Bulk memory operations","id":"bulk_memory_operations"},{"text":"Types","id":"types"},{"text":"Multi-value WebAssembly","id":"multi-value_webassembly"},{"text":"WebAssembly threads","id":"webassembly_threads"},{"text":"Summary","id":"summary"},{"text":"See also","id":"see_also"}],"summary":"This finishes our high-level tour of the major components of the WebAssembly text format and how they get reflected in the WebAssembly JS API.","popularity":0.0022,"modified":"2022-09-19T05:46:09.000Z","other_translations":[{"title":"WebAssembly „ÉÜ„Ç≠„Çπ„ÉàÂΩ¢Âºè„ÅÆÁêÜËß£","locale":"ja","native":"Êó•Êú¨Ë™û"},{"title":"Understanding WebAssembly text format","locale":"ko","native":"ÌïúÍµ≠Ïñ¥"},{"title":"Entendendo o formato textual do WebAssembly","locale":"pt-BR","native":"Portugu√™s (do¬†Brasil)"},{"title":"–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ WebAssembly","locale":"ru","native":"–†—É—Å—Å–∫–∏–π"},{"title":"ÁêÜËß£ WebAssembly ÊñáÊú¨Ê†ºÂºè","locale":"zh-CN","native":"‰∏≠Êñá (ÁÆÄ‰Ωì)"}],"source":{"folder":"en-us/webassembly/understanding_the_text_format","github_url":"https://github.com/mdn/content/blob/style/old/files/en-us/webassembly/understanding_the_text_format/index.md","last_commit_url":"https://github.com/mdn/content/commit/d606f8dc936dcf766e1540f687eba8dc9dd9ed13","filename":"index.md"},"parents":[{"uri":"/en-US/docs/WebAssembly","title":"WebAssembly"},{"uri":"/en-US/docs/WebAssembly/Understanding_the_text_format","title":"Understanding WebAssembly text format"}],"pageTitle":"Understanding WebAssembly text format - WebAssembly | MDN","noIndexing":false}}</script></body></html>