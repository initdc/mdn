{"doc":{"isMarkdown":true,"isTranslated":true,"isActive":true,"flaws":{},"title":"Base64 的编码与解码","mdn_url":"/zh-CN/docs/Glossary/Base64","locale":"zh-CN","native":"中文 (简体)","sidebarHTML":"","body":[{"type":"prose","value":{"id":null,"title":null,"isH3":false,"content":"<p><strong>Base64</strong> 是一组相似的<a href=\"https://en.wikipedia.org/wiki/Binary-to-text_encoding\" class=\"external\" rel=\" noopener\">二进制到文本</a>（binary-to-text）的编码规则，使得二进制数据在解释成 radix-64 的表现形式后能够用 ASCII 字符串的格式表示出来。<em>Base64</em> 这个词出自一种 <a href=\"https://en.wikipedia.org/wiki/MIME#Content-Transfer-Encoding\" class=\"external\" rel=\" noopener\">MIME 数据传输编码</a>。</p>\n<p>Base64 编码普遍应用于需要通过被设计为处理文本数据的媒介上储存和传输二进制数据而需要编码该二进制数据的场景。这样是为了保证数据的完整并且不用在传输过程中修改这些数据。Base64 也被一些应用（包括使用 <a href=\"https://en.wikipedia.org/wiki/MIME\" class=\"external\" rel=\" noopener\">MIME</a> 的电子邮件）和在 <a href=\"/zh-CN/docs/Web/XML\">XML</a> 中储存复杂数据时使用。</p>\n<p>在 JavaScript 中，有两个函数被分别用来处理解码和编码 <em>base64</em> 字符串：</p>\n<ul>\n  <li><a href=\"/zh-CN/docs/Web/API/atob\" title=\"atob()\"><code>atob()</code></a></li>\n  <li><a href=\"/zh-CN/docs/Web/API/btoa\" title=\"btoa()\"><code>btoa()</code></a></li>\n</ul>\n<p><code>atob()</code> 函数能够解码通过 base-64 编码的字符串数据。相反地，<code>btoa()</code> 函数能够从二进制数据“字符串”创建一个 base-64 编码的 ASCII 字符串。</p>\n<p><code>atob()</code> 和 <code>btoa()</code> 均使用字符串。如果你想使用 <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\"><code>ArrayBuffers</code></a>，请参阅后文。</p>\n<h4 id=\"编码尺寸增加\">编码尺寸增加</h4>\n<p>每一个 Base64 字符实际上代表着 6 比特位。因此，3 字节（一字节是 8 比特，3 字节也就是 24 比特）的字符串/二进制文件可以转换成 4 个 Base64 字符 (4x6 = 24 比特)。</p>\n<p>这意味着 Base64 格式的字符串或文件的尺寸约是原始尺寸的 133%（增加了大约 33%）。如果编码的数据很少，增加的比例可能会更高。例如：字符串<code>\"a\"</code>的<code>length === 1</code>进行 Base64 编码后是<code>\"YQ==\"</code>的<code>length === 4</code>，尺寸增加了 300%。</p>"}},{"type":"prose","value":{"id":"文档","title":"文档","isH3":false,"content":"<dl>\n  <dt id=\"data_uris\"><a href=\"/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Data_URLs\"><code>data</code> URIs</a></dt>\n  <dd>\n    <p><code>data</code> URIs, 定义于 <a href=\"https://tools.ietf.org/html/rfc2397\" class=\"external\" rel=\" noopener\">RFC 2397</a>，用于在文档内嵌入小的文件。</p>\n  </dd>\n  <dt id=\"base64\"><a href=\"https://en.wikipedia.org/wiki/Base64\" class=\"external\" rel=\" noopener\">Base64</a></dt>\n  <dd>\n    <p>维基百科上关于 Base64 的文章。</p>\n  </dd>\n  <dt id=\"atob\"><a href=\"/zh-CN/docs/Web/API/atob\" title=\"atob()\"><code>atob()</code></a></dt>\n  <dd>\n    <p>解码一个 Base64 字符串。</p>\n  </dd>\n  <dt id=\"btoa\"><a href=\"/zh-CN/docs/Web/API/btoa\" title=\"btoa()\"><code>btoa()</code></a></dt>\n  <dd>\n    <p>从一个字符串或者二进制数据编码一个 Base64 字符串。</p>\n  </dd>\n  <dt id=\"unicode_问题\"><a href=\"#the_.22unicode_problem.22\">\"Unicode 问题\"</a></dt>\n  <dd>\n    <p>在大多数浏览器里里，在一个 Unicode 字符串上调用 btoa() 会造成一个<code>Character Out Of Range</code> 异常。这一段写了一些解决方案。</p>\n  </dd>\n  <dt id=\"urischeme\"><a href=\"/zh-CN/docs/URIScheme\" class=\"page-not-created\" title=\"This is a link to an unwritten page\">URIScheme</a></dt>\n  <dd>\n    <p>Mozilla 支持的 URI schemes 列表。</p>\n  </dd>\n  <dt id=\"stringview\"><a href=\"/zh-CN/docs/Web/JavaScript/Typed_arrays/StringView\" class=\"page-not-created\" title=\"This is a link to an unwritten page\"><code>StringView</code></a></dt>\n  <dd>\n    <p>这篇文章发布了一个我们做的库，目的在于：</p>\n    <ul>\n      <li>为字符串创建一个类 C 接口 (i.e. array of characters codes — <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/TypedArray\"><code>ArrayBufferView</code></a> in JavaScript) ，基于 JavaScript <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\"><code>ArrayBuffer</code></a> 接口。</li>\n      <li>为类字符串对象 (目前为止为：<code>stringView</code>s) 创建一系列方法，它们<strong>严格按照数字数组</strong>工作，而不是不可变的字符串。</li>\n      <li>可用于其它 Unicode 编码，和默认的 <code>DOMStrings</code> 不同。</li>\n    </ul>\n  </dd>\n</dl>"}},{"type":"prose","value":{"id":"工具","title":"工具","isH3":false,"content":"<ul>\n  <li><a href=\"#solution_.232_.e2.80.93_rewriting_atob_and_btoa_using_typedarrays_and_utf-8\">Rewriting <code>atob()</code> and <code>btoa()</code> using <code>TypedArray</code>s and UTF-8</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Typed_arrays/StringView\" class=\"page-not-created\" title=\"This is a link to an unwritten page\"><code>StringView</code> – a C-like representation of strings based on typed arrays</a></li>\n</ul>"}},{"type":"prose","value":{"id":"相关文章","title":"相关文章","isH3":false,"content":"<ul>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\"><code>ArrayBuffer</code></a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Typed_arrays\">Typed arrays</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/TypedArray\">ArrayBufferView</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array\"><code>Uint8Array</code></a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Typed_arrays/StringView\" class=\"page-not-created\" title=\"This is a link to an unwritten page\"><code>StringView</code> – a C-like representation of strings based on typed arrays</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String\"><code>DOMString</code></a></li>\n  <li><a href=\"/zh-CN/docs/Glossary/URI\"><code>URI</code></a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/encodeURI\"><code>encodeURI()</code></a></li>\n</ul>"}},{"type":"prose","value":{"id":"unicode_问题_2","title":"Unicode 问题","isH3":false,"content":"<p>由于 <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String\"><code>DOMString</code></a> 是 16 位编码的字符串，所以如果有字符超出了 8 位 ASCII 编码的字符范围时，在大多数的浏览器中对 Unicode 字符串调用 <code>window.btoa</code> 将会造成一个 <code>Character Out Of Range</code> 的异常。有很多种方法可以解决这个问题：</p>\n<ul>\n  <li><a href=\"#solution_1_–_javascript's_utf-16_>_base64\">the first method</a> consists in encoding JavaScript's native UTF-16 strings directly into base64 (fast, portable, clean)</li>\n  <li><a href=\"#solution_2_–_javascript's_utf-16_>_utf-8_>_base64\">the second method</a> consists in converting JavaScript's native UTF-16 strings to UTF-8 and then encode the latter into base64 (relatively fast, portable, clean)</li>\n  <li><a href=\"#solution_3_–_javascript's_utf-16_>_binary_string_>_base64\">the third method</a> consists in encoding JavaScript's native UTF-16 strings directly into base64 via binary strings (very fast, relatively portable, very compact)</li>\n  <li><a href=\"#solution_4_–_escaping_the_string_before_encoding_it\">the fourth method</a> consists in escaping the whole string (with UTF-8, see <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent\"><code>encodeURIComponent</code></a>) and then encode it (portable, non-standard)</li>\n  <li><a href=\"#solution_5_–_rewrite_the_doms_atob_and_btoa_using_javascripts_typedarrays_and_utf-8\">the fifth method</a> is similar to the second method, but uses third party libraries</li>\n</ul>"}},{"type":"prose","value":{"id":"solution_1_–_javascripts_utf-16__base64","title":"Solution #1 – JavaScript's UTF-16 =&gt; base64","isH3":true,"content":"<p>A very fast and widely useable way to solve the unicode problem is by encoding JavaScript native UTF-16 strings directly into base64. Please visit the URL <code>data:text/plain;charset=utf-16;base64,OCY5JjomOyY8Jj4mPyY=</code> for a demonstration (copy the data uri, open a new tab, paste the data URI into the address bar, then press enter to go to the page). This method is particularly efficient because it does not require any type of conversion, except mapping a string into an array. The following code is also useful to get an <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\">ArrayBuffer</a> from a <em>Base64</em> string and/or viceversa (<a href=\"#appendix_to_solution_1_decode_a_base64_string_to_uint8array_or_arraybuffer\">see below</a>).</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token string\">\"use strict\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/*\\\n|*|\n|*|  Base64 / binary data / UTF-8 strings utilities (#1)\n|*|\n|*|  https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding\n|*|\n|*|  Author: madmurphy\n|*|\n\\*/</span>\n\n<span class=\"token comment\">/* Array of bytes to base64 string decoding */</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">b64ToUint6</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">nChr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">return</span> nChr <span class=\"token operator\">&gt;</span> <span class=\"token number\">64</span> <span class=\"token operator\">&amp;&amp;</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">91</span> <span class=\"token operator\">?</span>\n      nChr <span class=\"token operator\">-</span> <span class=\"token number\">65</span>\n    <span class=\"token operator\">:</span> nChr <span class=\"token operator\">&gt;</span> <span class=\"token number\">96</span> <span class=\"token operator\">&amp;&amp;</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">123</span> <span class=\"token operator\">?</span>\n      nChr <span class=\"token operator\">-</span> <span class=\"token number\">71</span>\n    <span class=\"token operator\">:</span> nChr <span class=\"token operator\">&gt;</span> <span class=\"token number\">47</span> <span class=\"token operator\">&amp;&amp;</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">58</span> <span class=\"token operator\">?</span>\n      nChr <span class=\"token operator\">+</span> <span class=\"token number\">4</span>\n    <span class=\"token operator\">:</span> nChr <span class=\"token operator\">===</span> <span class=\"token number\">43</span> <span class=\"token operator\">?</span>\n      <span class=\"token number\">62</span>\n    <span class=\"token operator\">:</span> nChr <span class=\"token operator\">===</span> <span class=\"token number\">47</span> <span class=\"token operator\">?</span>\n      <span class=\"token number\">63</span>\n    <span class=\"token operator\">:</span>\n      <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">base64DecToArr</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">sBase64<span class=\"token punctuation\">,</span> nBlockSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">var</span>\n    sB64Enc <span class=\"token operator\">=</span> sBase64<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">[^A-Za-z0-9\\+\\/]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> nInLen <span class=\"token operator\">=</span> sB64Enc<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\n    nOutLen <span class=\"token operator\">=</span> nBlockSize <span class=\"token operator\">?</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>nInLen <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> nBlockSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> nBlockSize <span class=\"token operator\">:</span> nInLen <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> aBytes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>nOutLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> nMod3<span class=\"token punctuation\">,</span> nMod4<span class=\"token punctuation\">,</span> nUint24 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> nOutIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> nInIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> nInIdx <span class=\"token operator\">&lt;</span> nInLen<span class=\"token punctuation\">;</span> nInIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nMod4 <span class=\"token operator\">=</span> nInIdx <span class=\"token operator\">&amp;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n    nUint24 <span class=\"token operator\">|=</span> <span class=\"token function\">b64ToUint6</span><span class=\"token punctuation\">(</span>sB64Enc<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span>nInIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">18</span> <span class=\"token operator\">-</span> <span class=\"token number\">6</span> <span class=\"token operator\">*</span> nMod4<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nMod4 <span class=\"token operator\">===</span> <span class=\"token number\">3</span> <span class=\"token operator\">||</span> nInLen <span class=\"token operator\">-</span> nInIdx <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>nMod3 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> nMod3 <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span> <span class=\"token operator\">&amp;&amp;</span> nOutIdx <span class=\"token operator\">&lt;</span> nOutLen<span class=\"token punctuation\">;</span> nMod3<span class=\"token operator\">++</span><span class=\"token punctuation\">,</span> nOutIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        aBytes<span class=\"token punctuation\">[</span>nOutIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> nUint24 <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">&gt;&gt;&gt;</span> nMod3 <span class=\"token operator\">&amp;</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      nUint24 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> aBytes<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/* Base64 string to array encoding */</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">uint6ToB64</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">nUint6</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">return</span> nUint6 <span class=\"token operator\">&lt;</span> <span class=\"token number\">26</span> <span class=\"token operator\">?</span>\n      nUint6 <span class=\"token operator\">+</span> <span class=\"token number\">65</span>\n    <span class=\"token operator\">:</span> nUint6 <span class=\"token operator\">&lt;</span> <span class=\"token number\">52</span> <span class=\"token operator\">?</span>\n      nUint6 <span class=\"token operator\">+</span> <span class=\"token number\">71</span>\n    <span class=\"token operator\">:</span> nUint6 <span class=\"token operator\">&lt;</span> <span class=\"token number\">62</span> <span class=\"token operator\">?</span>\n      nUint6 <span class=\"token operator\">-</span> <span class=\"token number\">4</span>\n    <span class=\"token operator\">:</span> nUint6 <span class=\"token operator\">===</span> <span class=\"token number\">62</span> <span class=\"token operator\">?</span>\n      <span class=\"token number\">43</span>\n    <span class=\"token operator\">:</span> nUint6 <span class=\"token operator\">===</span> <span class=\"token number\">63</span> <span class=\"token operator\">?</span>\n      <span class=\"token number\">47</span>\n    <span class=\"token operator\">:</span>\n      <span class=\"token number\">65</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">base64EncArr</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">aBytes</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">var</span> eqLen <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">%</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> sB64Enc <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> nMod3<span class=\"token punctuation\">,</span> nLen <span class=\"token operator\">=</span> aBytes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> nUint24 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> nIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> nIdx <span class=\"token operator\">&lt;</span> nLen<span class=\"token punctuation\">;</span> nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nMod3 <span class=\"token operator\">=</span> nIdx <span class=\"token operator\">%</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/* Uncomment the following line in order to split the output in lines 76-character long: */</span>\n    <span class=\"token comment\">/*\n    if (nIdx &gt; 0 &amp;&amp; (nIdx * 4 / 3) % 76 === 0) { sB64Enc += \"\\r\\n\"; }\n    */</span>\n    nUint24 <span class=\"token operator\">|=</span> aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">&gt;&gt;&gt;</span> nMod3 <span class=\"token operator\">&amp;</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nMod3 <span class=\"token operator\">===</span> <span class=\"token number\">2</span> <span class=\"token operator\">||</span> aBytes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> nIdx <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      sB64Enc <span class=\"token operator\">+=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">(</span><span class=\"token function\">uint6ToB64</span><span class=\"token punctuation\">(</span>nUint24 <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">18</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">uint6ToB64</span><span class=\"token punctuation\">(</span>nUint24 <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">12</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">uint6ToB64</span><span class=\"token punctuation\">(</span>nUint24 <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">6</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">uint6ToB64</span><span class=\"token punctuation\">(</span>nUint24 <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      nUint24 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span>  eqLen <span class=\"token operator\">===</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span>\n      <span class=\"token literal-property property\">sB64Enc</span>\n    <span class=\"token operator\">:</span>\n      sB64Enc<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> sB64Enc<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> eqLen<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>eqLen <span class=\"token operator\">===</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"=\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"==\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h4 id=\"tests\">Tests</h4>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">var</span> myString <span class=\"token operator\">=</span> <span class=\"token string\">\"☸☹☺☻☼☾☿\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* Part 1: Encode `myString` to base64 using native UTF-16 */</span>\n\n<span class=\"token keyword\">var</span> aUTF16CodeUnits <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint16Array</span><span class=\"token punctuation\">(</span>myString<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Array</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>aUTF16CodeUnits<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">,</span> arr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> arr<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> myString<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> sUTF16Base64 <span class=\"token operator\">=</span> <span class=\"token function\">base64EncArr</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>aUTF16CodeUnits<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* Show output */</span>\n\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>sUTF16Base64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"OCY5JjomOyY8Jj4mPyY=\"</span>\n\n<span class=\"token comment\">/* Part 2: Decode `sUTF16Base64` to UTF-16 */</span>\n\n<span class=\"token keyword\">var</span> sDecodedString <span class=\"token operator\">=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint16Array</span><span class=\"token punctuation\">(</span><span class=\"token function\">base64DecToArr</span><span class=\"token punctuation\">(</span>sUTF16Base64<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* Show output */</span>\n\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>sDecodedString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"☸☹☺☻☼☾☿\"</span>\n</code></pre></div>\n<p>The produced string is fully portable, although represented as UTF-16. If you prefer UTF-8, see <a href=\"#solution_2_–_javascript's_utf-16_>_utf-8_>_base64\">the next solution</a>.</p>\n<h4 id=\"appendix_to_solution_1_decode_a_base64_string_to_uint8array_or_arraybuffer\">Appendix to <a href=\"#solution_1_–_javascript's_utf-16_>_base64\">Solution #1</a>: Decode a <em>Base64</em> string to <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array\">Uint8Array</a> or <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\">ArrayBuffer</a></h4>\n<p>The functions above let us also create <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array\">uint8Arrays</a> or <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\">arrayBuffers</a> from <em>base64</em>-encoded strings:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">var</span> myArray <span class=\"token operator\">=</span> <span class=\"token function\">base64DecToArr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"QmFzZSA2NCDigJQgTW96aWxsYSBEZXZlbG9wZXIgTmV0d29yaw==\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"Base 64 \\u2014 Mozilla Developer Network\" (as UTF-8)</span>\n\n<span class=\"token keyword\">var</span> myBuffer <span class=\"token operator\">=</span> <span class=\"token function\">base64DecToArr</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"QmFzZSA2NCDigJQgTW96aWxsYSBEZXZlbG9wZXIgTmV0d29yaw==\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"Base 64 \\u2014 Mozilla Developer Network\" (as UTF-8)</span>\n\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>myBuffer<span class=\"token punctuation\">.</span>byteLength<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect1\">\n  <p><strong>备注：</strong> The function <code>base64DecToArr(sBase64[, nBlockSize])</code> returns an <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array\"><code>uint8Array</code></a> of bytes. If your aim is to build a buffer of 16-bit / 32-bit / 64-bit raw data, use the <code>nBlockSize</code> argument, which is the number of bytes which the <code>uint8Array.buffer.bytesLength</code> property must result to be a multiple of (<code>1</code> or omitted for ASCII, binary content, <a href=\"/zh-CN/docs/Web/API/btoa\">binary strings</a>, UTF-8-encoded strings; <code>2</code> for UTF-16 strings; <code>4</code> for UTF-32 strings).</p>\n</div>\n<p>For a more complete library, see <a href=\"/zh-CN/docs/Web/JavaScript/Typed_arrays/StringView\" class=\"page-not-created\" title=\"This is a link to an unwritten page\"><code>StringView</code> – a C-like representation of strings based on typed arrays</a> (source code <a href=\"https://github.com/madmurphy/stringview.js\" class=\"external\" rel=\" noopener\">available on GitHub</a>).</p>","titleAsText":"Solution #1 – JavaScript's UTF-16 => base64"}},{"type":"prose","value":{"id":"solution_2_–_javascripts_utf-16__utf-8__base64","title":"Solution #2 – JavaScript's UTF-16 =&gt; UTF-8 =&gt; base64","isH3":true,"content":"<p>This solution consists in converting a JavaScript's native UTF-16 string into a UTF-8 string and then encoding the latter into base64. This also grants that converting a pure ASCII string to base64 always produces the same output as the native <a href=\"/zh-CN/docs/Web/API/btoa\"><code>btoa()</code></a>.</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token string\">\"use strict\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/*\\\n|*|\n|*|  Base64 / binary data / UTF-8 strings utilities (#2)\n|*|\n|*|  https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding\n|*|\n|*|  Author: madmurphy\n|*|\n\\*/</span>\n\n<span class=\"token comment\">/* Array of bytes to base64 string decoding */</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">b64ToUint6</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">nChr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">return</span> nChr <span class=\"token operator\">&gt;</span> <span class=\"token number\">64</span> <span class=\"token operator\">&amp;&amp;</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">91</span> <span class=\"token operator\">?</span>\n      nChr <span class=\"token operator\">-</span> <span class=\"token number\">65</span>\n    <span class=\"token operator\">:</span> nChr <span class=\"token operator\">&gt;</span> <span class=\"token number\">96</span> <span class=\"token operator\">&amp;&amp;</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">123</span> <span class=\"token operator\">?</span>\n      nChr <span class=\"token operator\">-</span> <span class=\"token number\">71</span>\n    <span class=\"token operator\">:</span> nChr <span class=\"token operator\">&gt;</span> <span class=\"token number\">47</span> <span class=\"token operator\">&amp;&amp;</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">58</span> <span class=\"token operator\">?</span>\n      nChr <span class=\"token operator\">+</span> <span class=\"token number\">4</span>\n    <span class=\"token operator\">:</span> nChr <span class=\"token operator\">===</span> <span class=\"token number\">43</span> <span class=\"token operator\">?</span>\n      <span class=\"token number\">62</span>\n    <span class=\"token operator\">:</span> nChr <span class=\"token operator\">===</span> <span class=\"token number\">47</span> <span class=\"token operator\">?</span>\n      <span class=\"token number\">63</span>\n    <span class=\"token operator\">:</span>\n      <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">base64DecToArr</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">sBase64<span class=\"token punctuation\">,</span> nBlockSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">var</span>\n    sB64Enc <span class=\"token operator\">=</span> sBase64<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">[^A-Za-z0-9\\+\\/]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> nInLen <span class=\"token operator\">=</span> sB64Enc<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\n    nOutLen <span class=\"token operator\">=</span> nBlockSize <span class=\"token operator\">?</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>nInLen <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> nBlockSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> nBlockSize <span class=\"token operator\">:</span> nInLen <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> aBytes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>nOutLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> nMod3<span class=\"token punctuation\">,</span> nMod4<span class=\"token punctuation\">,</span> nUint24 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> nOutIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> nInIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> nInIdx <span class=\"token operator\">&lt;</span> nInLen<span class=\"token punctuation\">;</span> nInIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nMod4 <span class=\"token operator\">=</span> nInIdx <span class=\"token operator\">&amp;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n    nUint24 <span class=\"token operator\">|=</span> <span class=\"token function\">b64ToUint6</span><span class=\"token punctuation\">(</span>sB64Enc<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span>nInIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">18</span> <span class=\"token operator\">-</span> <span class=\"token number\">6</span> <span class=\"token operator\">*</span> nMod4<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nMod4 <span class=\"token operator\">===</span> <span class=\"token number\">3</span> <span class=\"token operator\">||</span> nInLen <span class=\"token operator\">-</span> nInIdx <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>nMod3 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> nMod3 <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span> <span class=\"token operator\">&amp;&amp;</span> nOutIdx <span class=\"token operator\">&lt;</span> nOutLen<span class=\"token punctuation\">;</span> nMod3<span class=\"token operator\">++</span><span class=\"token punctuation\">,</span> nOutIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        aBytes<span class=\"token punctuation\">[</span>nOutIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> nUint24 <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">&gt;&gt;&gt;</span> nMod3 <span class=\"token operator\">&amp;</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">255</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      nUint24 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> aBytes<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/* Base64 string to array encoding */</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">uint6ToB64</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">nUint6</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">return</span> nUint6 <span class=\"token operator\">&lt;</span> <span class=\"token number\">26</span> <span class=\"token operator\">?</span>\n      nUint6 <span class=\"token operator\">+</span> <span class=\"token number\">65</span>\n    <span class=\"token operator\">:</span> nUint6 <span class=\"token operator\">&lt;</span> <span class=\"token number\">52</span> <span class=\"token operator\">?</span>\n      nUint6 <span class=\"token operator\">+</span> <span class=\"token number\">71</span>\n    <span class=\"token operator\">:</span> nUint6 <span class=\"token operator\">&lt;</span> <span class=\"token number\">62</span> <span class=\"token operator\">?</span>\n      nUint6 <span class=\"token operator\">-</span> <span class=\"token number\">4</span>\n    <span class=\"token operator\">:</span> nUint6 <span class=\"token operator\">===</span> <span class=\"token number\">62</span> <span class=\"token operator\">?</span>\n      <span class=\"token number\">43</span>\n    <span class=\"token operator\">:</span> nUint6 <span class=\"token operator\">===</span> <span class=\"token number\">63</span> <span class=\"token operator\">?</span>\n      <span class=\"token number\">47</span>\n    <span class=\"token operator\">:</span>\n      <span class=\"token number\">65</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">base64EncArr</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">aBytes</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">var</span> eqLen <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">%</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> sB64Enc <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> nMod3<span class=\"token punctuation\">,</span> nLen <span class=\"token operator\">=</span> aBytes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> nUint24 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> nIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> nIdx <span class=\"token operator\">&lt;</span> nLen<span class=\"token punctuation\">;</span> nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nMod3 <span class=\"token operator\">=</span> nIdx <span class=\"token operator\">%</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/* Uncomment the following line in order to split the output in lines 76-character long: */</span>\n    <span class=\"token comment\">/*\n    if (nIdx &gt; 0 &amp;&amp; (nIdx * 4 / 3) % 76 === 0) { sB64Enc += \"\\r\\n\"; }\n    */</span>\n    nUint24 <span class=\"token operator\">|=</span> aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">&gt;&gt;&gt;</span> nMod3 <span class=\"token operator\">&amp;</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nMod3 <span class=\"token operator\">===</span> <span class=\"token number\">2</span> <span class=\"token operator\">||</span> aBytes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> nIdx <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      sB64Enc <span class=\"token operator\">+=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">(</span><span class=\"token function\">uint6ToB64</span><span class=\"token punctuation\">(</span>nUint24 <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">18</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">uint6ToB64</span><span class=\"token punctuation\">(</span>nUint24 <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">12</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">uint6ToB64</span><span class=\"token punctuation\">(</span>nUint24 <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">6</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">uint6ToB64</span><span class=\"token punctuation\">(</span>nUint24 <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      nUint24 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span>  eqLen <span class=\"token operator\">===</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span>\n      <span class=\"token literal-property property\">sB64Enc</span>\n    <span class=\"token operator\">:</span>\n      sB64Enc<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> sB64Enc<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> eqLen<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>eqLen <span class=\"token operator\">===</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"=\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"==\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/* UTF-8 array to DOMString and vice versa */</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">UTF8ArrToStr</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">aBytes</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">var</span> sView <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> nPart<span class=\"token punctuation\">,</span> nLen <span class=\"token operator\">=</span> aBytes<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> nIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> nIdx <span class=\"token operator\">&lt;</span> nLen<span class=\"token punctuation\">;</span> nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nPart <span class=\"token operator\">=</span> aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    sView <span class=\"token operator\">+=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">(</span>\n      nPart <span class=\"token operator\">&gt;</span> <span class=\"token number\">251</span> <span class=\"token operator\">&amp;&amp;</span> nPart <span class=\"token operator\">&lt;</span> <span class=\"token number\">254</span> <span class=\"token operator\">&amp;&amp;</span> nIdx <span class=\"token operator\">+</span> <span class=\"token number\">5</span> <span class=\"token operator\">&lt;</span> nLen <span class=\"token operator\">?</span> <span class=\"token comment\">/* six bytes */</span>\n        <span class=\"token comment\">/* (nPart - 252 &lt;&lt; 30) may be not so safe in ECMAScript! So...: */</span>\n        <span class=\"token punctuation\">(</span>nPart <span class=\"token operator\">-</span> <span class=\"token number\">252</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1073741824</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span>\n      <span class=\"token operator\">:</span> nPart <span class=\"token operator\">&gt;</span> <span class=\"token number\">247</span> <span class=\"token operator\">&amp;&amp;</span> nPart <span class=\"token operator\">&lt;</span> <span class=\"token number\">252</span> <span class=\"token operator\">&amp;&amp;</span> nIdx <span class=\"token operator\">+</span> <span class=\"token number\">4</span> <span class=\"token operator\">&lt;</span> nLen <span class=\"token operator\">?</span> <span class=\"token comment\">/* five bytes */</span>\n        <span class=\"token punctuation\">(</span>nPart <span class=\"token operator\">-</span> <span class=\"token number\">248</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span>\n      <span class=\"token operator\">:</span> nPart <span class=\"token operator\">&gt;</span> <span class=\"token number\">239</span> <span class=\"token operator\">&amp;&amp;</span> nPart <span class=\"token operator\">&lt;</span> <span class=\"token number\">248</span> <span class=\"token operator\">&amp;&amp;</span> nIdx <span class=\"token operator\">+</span> <span class=\"token number\">3</span> <span class=\"token operator\">&lt;</span> nLen <span class=\"token operator\">?</span> <span class=\"token comment\">/* four bytes */</span>\n        <span class=\"token punctuation\">(</span>nPart <span class=\"token operator\">-</span> <span class=\"token number\">240</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span>\n      <span class=\"token operator\">:</span> nPart <span class=\"token operator\">&gt;</span> <span class=\"token number\">223</span> <span class=\"token operator\">&amp;&amp;</span> nPart <span class=\"token operator\">&lt;</span> <span class=\"token number\">240</span> <span class=\"token operator\">&amp;&amp;</span> nIdx <span class=\"token operator\">+</span> <span class=\"token number\">2</span> <span class=\"token operator\">&lt;</span> nLen <span class=\"token operator\">?</span> <span class=\"token comment\">/* three bytes */</span>\n        <span class=\"token punctuation\">(</span>nPart <span class=\"token operator\">-</span> <span class=\"token number\">224</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span>\n      <span class=\"token operator\">:</span> nPart <span class=\"token operator\">&gt;</span> <span class=\"token number\">191</span> <span class=\"token operator\">&amp;&amp;</span> nPart <span class=\"token operator\">&lt;</span> <span class=\"token number\">224</span> <span class=\"token operator\">&amp;&amp;</span> nIdx <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;</span> nLen <span class=\"token operator\">?</span> <span class=\"token comment\">/* two bytes */</span>\n        <span class=\"token punctuation\">(</span>nPart <span class=\"token operator\">-</span> <span class=\"token number\">192</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> aBytes<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>nIdx<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">128</span>\n      <span class=\"token operator\">:</span> <span class=\"token comment\">/* nPart &lt; 127 ? */</span> <span class=\"token comment\">/* one byte */</span>\n        nPart\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> sView<span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">strToUTF8Arr</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">sDOMStr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">var</span> aBytes<span class=\"token punctuation\">,</span> nChr<span class=\"token punctuation\">,</span> nStrLen <span class=\"token operator\">=</span> sDOMStr<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> nArrLen <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/* mapping... */</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> nMapIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> nMapIdx <span class=\"token operator\">&lt;</span> nStrLen<span class=\"token punctuation\">;</span> nMapIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nChr <span class=\"token operator\">=</span> sDOMStr<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span>nMapIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    nArrLen <span class=\"token operator\">+=</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x80</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x800</span> <span class=\"token operator\">?</span> <span class=\"token number\">2</span> <span class=\"token operator\">:</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x10000</span> <span class=\"token operator\">?</span> <span class=\"token number\">3</span> <span class=\"token operator\">:</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x200000</span> <span class=\"token operator\">?</span> <span class=\"token number\">4</span> <span class=\"token operator\">:</span> nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x4000000</span> <span class=\"token operator\">?</span> <span class=\"token number\">5</span> <span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  aBytes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>nArrLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/* transcription... */</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> nIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> nChrIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> nIdx <span class=\"token operator\">&lt;</span> nArrLen<span class=\"token punctuation\">;</span> nChrIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nChr <span class=\"token operator\">=</span> sDOMStr<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span>nChrIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">128</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* one byte */</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> nChr<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x800</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* two bytes */</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">192</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x10000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* three bytes */</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">224</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">6</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x200000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* four bytes */</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">240</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">12</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">6</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&lt;</span> <span class=\"token number\">0x4000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* five bytes */</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">248</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">18</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">12</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">6</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token comment\">/* if (nChr &lt;= 0x7fffffff) */</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">/* six bytes */</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">252</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">24</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">18</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">12</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token number\">6</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      aBytes<span class=\"token punctuation\">[</span>nIdx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">128</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>nChr <span class=\"token operator\">&amp;</span> <span class=\"token number\">63</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> aBytes<span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h4 id=\"tests_2\">Tests</h4>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token comment\">/* Tests */</span>\n\n<span class=\"token keyword\">var</span> sMyInput <span class=\"token operator\">=</span> <span class=\"token string\">\"Base 64 \\u2014 Mozilla Developer Network\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> aMyUTF8Input <span class=\"token operator\">=</span> <span class=\"token function\">strToUTF8Arr</span><span class=\"token punctuation\">(</span>sMyInput<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> sMyBase64 <span class=\"token operator\">=</span> <span class=\"token function\">base64EncArr</span><span class=\"token punctuation\">(</span>aMyUTF8Input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>sMyBase64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"QmFzZSA2NCDigJQgTW96aWxsYSBEZXZlbG9wZXIgTmV0d29yaw==\"</span>\n\n<span class=\"token keyword\">var</span> aMyUTF8Output <span class=\"token operator\">=</span> <span class=\"token function\">base64DecToArr</span><span class=\"token punctuation\">(</span>sMyBase64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> sMyOutput <span class=\"token operator\">=</span> <span class=\"token function\">UTF8ArrToStr</span><span class=\"token punctuation\">(</span>aMyUTF8Output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>sMyOutput<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"Base 64 — Mozilla Developer Network\"</span>\n</code></pre></div>","titleAsText":"Solution #2 – JavaScript's UTF-16 => UTF-8 => base64"}},{"type":"prose","value":{"id":"solution_3_–_javascripts_utf-16__binary_string__base64","title":"Solution #3 – JavaScript's UTF-16 =&gt; binary string =&gt; base64","isH3":true,"content":"<p>The following is the fastest and most compact possible approach. The output is exactly the same produced by <a href=\"#solution_1_–_javascript's_utf-16_>_base64\">Solution #1</a> (UTF-16 encoded strings), but instead of rewriting <a href=\"/zh-CN/docs/Web/API/atob\" title=\"atob()\"><code>atob()</code></a> and <a href=\"/zh-CN/docs/Web/API/btoa\" title=\"btoa()\"><code>btoa()</code></a> it uses the native ones. This is made possible by the fact that instead of using typed arrays as encoding/decoding inputs this solution uses <a href=\"/zh-CN/docs/Web/API/btoa\">binary strings</a> as an intermediate format. It is a “dirty” workaround in comparison to <a href=\"#solution_1_–_javascript's_utf-16_>_base64\">Solution #1</a> (<a href=\"/zh-CN/docs/Web/API/btoa\">binary strings</a> are a grey area), however it works pretty well and requires only a few lines of code.</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token string\">\"use strict\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/*\\\n|*|\n|*|  Base64 / binary data / UTF-8 strings utilities (#3)\n|*|\n|*|  https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding\n|*|\n|*|  Author: madmurphy\n|*|\n\\*/</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">btoaUTF16</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">sString</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">var</span> aUTF16CodeUnits <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint16Array</span><span class=\"token punctuation\">(</span>sString<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">Array</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>aUTF16CodeUnits<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">,</span> arr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> arr<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> sString<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">btoa</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>aUTF16CodeUnits<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">atobUTF16</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">sBase64</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n <span class=\"token keyword\">var</span> sBinaryString <span class=\"token operator\">=</span> <span class=\"token function\">atob</span><span class=\"token punctuation\">(</span>sBase64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> aBinaryView <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>sBinaryString<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token class-name\">Array</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>aBinaryView<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">,</span> arr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> arr<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> sBinaryString<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token keyword\">return</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint16Array</span><span class=\"token punctuation\">(</span>aBinaryView<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h4 id=\"tests_3\">Tests</h4>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">var</span> myString <span class=\"token operator\">=</span> <span class=\"token string\">\"☸☹☺☻☼☾☿\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* Part 1: Encode `myString` to base64 using native UTF-16 */</span>\n\n<span class=\"token keyword\">var</span> sUTF16Base64 <span class=\"token operator\">=</span> <span class=\"token function\">btoaUTF16</span><span class=\"token punctuation\">(</span>myString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* Show output */</span>\n\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>sUTF16Base64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"OCY5JjomOyY8Jj4mPyY=\"</span>\n\n<span class=\"token comment\">/* Part 2: Decode `sUTF16Base64` to UTF-16 */</span>\n\n<span class=\"token keyword\">var</span> sDecodedString <span class=\"token operator\">=</span> <span class=\"token function\">atobUTF16</span><span class=\"token punctuation\">(</span>sUTF16Base64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* Show output */</span>\n\n<span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>sDecodedString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"☸☹☺☻☼☾☿\"</span>\n</code></pre></div>\n<p>For a cleaner solution that uses typed arrays instead of binary strings, see solutions <a href=\"#solution_1_–_javascript's_utf-16_>_base64\">#1</a> and <a href=\"#solution_2_–_javascript's_utf-16_>_utf-8_>_base64\">#2</a>.</p>","titleAsText":"Solution #3 – JavaScript's UTF-16 => binary string => base64"}},{"type":"prose","value":{"id":"solution_4_–_escaping_the_string_before_encoding_it","title":"Solution #4 – escaping the string before encoding it","isH3":true,"content":"<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">b64EncodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// first we use encodeURIComponent to get percent-encoded UTF-8,</span>\n    <span class=\"token comment\">// then we convert the percent encodings into raw bytes which</span>\n    <span class=\"token comment\">// can be fed into btoa.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">btoa</span><span class=\"token punctuation\">(</span><span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">%([0-9A-F]{2})</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">function</span> <span class=\"token function\">toSolidBytes</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">match<span class=\"token punctuation\">,</span> p1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0x'</span> <span class=\"token operator\">+</span> p1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">b64EncodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'✓ à la mode'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"4pyTIMOgIGxhIG1vZGU=\"</span>\n<span class=\"token function\">b64EncodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"Cg==\"</span>\n</code></pre></div>\n<p>To decode the Base64-encoded value back into a String:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">b64DecodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Going backwards: from bytestream, to percent-encoding, to original string.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">decodeURIComponent</span><span class=\"token punctuation\">(</span><span class=\"token function\">atob</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">'%'</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'00'</span> <span class=\"token operator\">+</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">b64DecodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'4pyTIMOgIGxhIG1vZGU='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"✓ à la mode\"</span>\n<span class=\"token function\">b64DecodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Cg=='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"\\n\"</span>\n</code></pre></div>\n<p><a href=\"https://git.daplie.com/Daplie/unibabel-js\" class=\"external\" rel=\" noopener\">Unibabel</a> implements common conversions using this strategy.</p>"}},{"type":"prose","value":{"id":"solution_5_–_rewrite_the_doms_atob_and_btoa_using_javascripts_typedarrays_and_utf-8","title":"Solution #5 – rewrite the DOMs <code>atob()</code> and <code>btoa()</code> using JavaScript's <code>TypedArray</code>s and UTF-8","isH3":true,"content":"<p>Use a <a href=\"/zh-CN/docs/Web/API/TextEncoder\">TextEncoder</a> polyfill such as <a href=\"https://github.com/inexorabletash/text-encoding\" class=\"external\" rel=\" noopener\">TextEncoding</a> (also includes legacy windows, mac, and ISO encodings), <a href=\"https://github.com/coolaj86/TextEncoderLite\" class=\"external\" rel=\" noopener\">TextEncoderLite</a>, combined with a <a href=\"https://github.com/feross/buffer\" class=\"external\" rel=\" noopener\">Buffer</a> and a Base64 implementation such as <a href=\"https://github.com/beatgammit/base64-js\" class=\"external\" rel=\" noopener\">base64-js</a> or <a href=\"https://github.com/waitingsong/base64\" class=\"external\" rel=\" noopener\">TypeScript version of base64-js</a> for both modern browsers and Node.js.</p>\n<p>When a native <code>TextEncoder</code> implementation is not available, the most light-weight solution would be to use <a href=\"#solution_3_–_javascript's_utf-16_>_binary_string_>_base64\">Solution #3</a> because in addition to being much faster, <a href=\"#solution_3_–_javascript's_utf-16_>_binary_string_>_base64\">Solution #3</a> also works in IE9 \"out of the box.\" Alternatively, use <a href=\"https://github.com/coolaj86/TextEncoderLite\" class=\"external\" rel=\" noopener\">TextEncoderLite</a> with <a href=\"https://github.com/beatgammit/base64-js\" class=\"external\" rel=\" noopener\">base64-js</a>. Use the browser implementation when you can.</p>\n<p>The following function implements such a strategy. It assumes base64-js imported as <code>&lt;script type=\"text/javascript\" src=\"base64js.min.js\"/&gt;</code>. Note that TextEncoderLite only works with UTF-8.</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">Base64Encode</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> encoding <span class=\"token operator\">=</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> bytes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> TextEncoder <span class=\"token operator\">===</span> <span class=\"token string\">\"undefined\"</span> <span class=\"token operator\">?</span> TextEncoderLite <span class=\"token operator\">:</span> TextEncoder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>encoding<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> base64js<span class=\"token punctuation\">.</span><span class=\"token function\">fromByteArray</span><span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Base64Decode</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> encoding <span class=\"token operator\">=</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> bytes <span class=\"token operator\">=</span> base64js<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> TextDecoder <span class=\"token operator\">===</span> <span class=\"token string\">\"undefined\"</span> <span class=\"token operator\">?</span> TextDecoderLite <span class=\"token operator\">:</span> TextDecoder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>encoding<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>\n  <strong>注意</strong>: <a href=\"https://github.com/coolaj86/TextEncoderLite\" class=\"external\" rel=\" noopener\">TextEncoderLite</a> 不能正确处理四字节 UTF-8 字符，比如 '\\uD842\\uDFB7' 或缩写为 '\\u{20BB7}' 。参见 <a href=\"https://github.com/solderjs/TextEncoderLite/issues/16\" class=\"external\" rel=\" noopener\">issue</a>\n  可使用 <a href=\"https://github.com/inexorabletash/text-encoding\" class=\"external\" rel=\" noopener\">text-encoding</a> 作为替代。\n</p>\n<p>某些场景下，以上经由 UTF-8 转换到 Base64 的实现在空间利用上不一定高效。当处理包含大量 U+0800-U+FFFF 区域间字符的文本时，UTF-8 输出结果长于 UTF-16 的，因为这些字符在 UTF-8 下占用三个字节而 UTF-16 是两个。在处理均匀分布 UTF-16 码点的 JavaScript 字符串时应考虑采用 UTF-16 替代 UTF-8 作为 Base64 结果的中间编码格式，这将减少 40% 尺寸。</p>\n<div class=\"notecard note\" id=\"sect2\">\n  <p><strong>备注：</strong> 下为陈旧翻译片段</p>\n</div>\n<ul>\n  <li>第一个是转义 (escape) 整个字符串然后编码这个它；</li>\n  <li>第二个是把 UTF-16 的 <a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String\"><code>DOMString</code></a> 转码为 UTF-8 的字符数组然后编码它。</li>\n</ul>","titleAsText":"Solution #5 – rewrite the DOMs atob() and btoa() using JavaScript's TypedArrays and UTF-8"}},{"type":"prose","value":{"id":"方案_1_–_编码之前转义_escape_字符串","title":"方案 #1 – 编码之前转义 (escape) 字符串","isH3":true,"content":"<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">b64EncodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">btoa</span><span class=\"token punctuation\">(</span><span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">%([0-9A-F]{2})</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">match<span class=\"token punctuation\">,</span> p1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0x'</span> <span class=\"token operator\">+</span> p1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">b64EncodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'✓ à la mode'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"4pyTIMOgIGxhIG1vZGU=\"</span>\n</code></pre></div>\n<p>把 base64 转换回字符串</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">b64DecodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">decodeURIComponent</span><span class=\"token punctuation\">(</span><span class=\"token function\">atob</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">'%'</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'00'</span> <span class=\"token operator\">+</span> c<span class=\"token punctuation\">.</span><span class=\"token function\">charCodeAt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">b64DecodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'4pyTIMOgIGxhIG1vZGU='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"✓ à la mode\"</span>\n<span class=\"token function\">b64DecodeUnicode</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Cg=='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"\\n\"</span>\n</code></pre></div>\n<p><a href=\"https://github.com/coolaj86/unibabel-js\" class=\"external\" rel=\" noopener\">Unibabel</a> 是一个包含了一些使用这种策略的通用转换的库。</p>"}},{"type":"prose","value":{"id":"方案_6_–_用_javascript_的_typedarray_和_utf-8_重写_dom_的_atob_和_btoa","title":"方案 #6 – 用 JavaScript 的 <code>TypedArray</code> 和 UTF-8 重写 DOM 的 <code>atob()</code> 和 <code>btoa()</code>","isH3":true,"content":"<p>使用像<a href=\"https://github.com/inexorabletash/text-encoding\" class=\"external\" rel=\" noopener\">TextEncoding</a>(包含了早期 (legacy) 的 windows，mac，和 ISO 编码)，<a href=\"https://github.com/coolaj86/TextEncoderLite/blob/master/index.js\" class=\"external\" rel=\" noopener\">TextEncoderLite</a> 或者 <a href=\"https://github.com/feross/buffer\" class=\"external\" rel=\" noopener\">Buffer</a> 这样的文本编码器增强 (polyfill) 和 Base64 增强，比如<a href=\"https://github.com/beatgammit/base64-js/blob/master/index.js\" class=\"external\" rel=\" noopener\">base64-js</a> 或 <a href=\"https://github.com/waitingsong/base64\" class=\"external\" rel=\" noopener\">TypeScript 版本的 base64-js</a>（适用于长青浏览器和 Node.js）。</p>\n<p>最简单，最轻量级的解决方法就是使用 <a href=\"https://github.com/coolaj86/TextEncoderLite/blob/master/index.js\" class=\"external\" rel=\" noopener\">TextEncoderLite</a> 和 <a href=\"https://github.com/beatgammit/base64-js/blob/master/index.js\" class=\"external\" rel=\" noopener\">base64-js</a>.</p>\n<p>想要更完整的库的话，参见 <a href=\"/zh-CN/docs/Web/JavaScript/Typed_arrays/StringView\" class=\"page-not-created\" title=\"This is a link to an unwritten page\"><code>StringView</code> – a C-like representation of strings based on typed arrays</a>.</p>","titleAsText":"方案 #6 – 用 JavaScript 的 TypedArray 和 UTF-8 重写 DOM 的 atob() 和 btoa()"}},{"type":"prose","value":{"id":"参见","title":"参见","isH3":false,"content":"<ul>\n  <li><a href=\"/zh-CN/docs/Web/API/atob\" title=\"atob()\"><code>atob()</code></a></li>\n  <li><a href=\"/zh-CN/docs/Web/API/btoa\" title=\"btoa()\"><code>btoa()</code></a></li>\n  <li><a href=\"/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Data_URLs\"><code>data</code> URIs</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\">ArrayBuffer</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Typed_arrays\">TypedArrays</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/TypedArray\">ArrayBufferView</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array\">Uint8Array</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Typed_arrays/StringView\" class=\"page-not-created\" title=\"This is a link to an unwritten page\"><code>StringView</code> – a C-like representation of strings based on typed arrays</a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String\">DOMString</a></li>\n  <li><a href=\"/zh-CN/docs/Glossary/URI\"><code>URI</code></a></li>\n  <li><a href=\"/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/encodeURI\"><code>encodeURI()</code></a></li>\n  <li><a href=\"/zh-CN/docs/XPCOM_Interface_Reference/nsIURIFixup\" class=\"page-not-created\" title=\"This is a link to an unwritten page\"><code>nsIURIFixup()</code></a></li>\n  <li><a href=\"https://en.wikipedia.org/wiki/Base64\" class=\"external\" rel=\" noopener\"><code>Base64 on Wikipedia</code></a></li>\n</ul>"}}],"toc":[{"text":"文档","id":"文档"},{"text":"工具","id":"工具"},{"text":"相关文章","id":"相关文章"},{"text":"Unicode 问题","id":"unicode_问题_2"},{"text":"参见","id":"参见"}],"summary":"Base64 是一组相似的二进制到文本（binary-to-text）的编码规则，使得二进制数据在解释成 radix-64 的表现形式后能够用 ASCII 字符串的格式表示出来。Base64 这个词出自一种 MIME 数据传输编码。","popularity":0.0019,"modified":"2022-10-01T03:41:16.000Z","other_translations":[{"title":"Base64","locale":"en-US","native":"English (US)"},{"title":"Base64 codificando y decodificando","locale":"es","native":"Español"},{"title":"Décoder et encoder en base64","locale":"fr","native":"Français"},{"title":"Base64","locale":"ja","native":"日本語"},{"title":"Кодирование и декодирование в формате Base64","locale":"ru","native":"Русский"}],"source":{"folder":"zh-cn/glossary/base64","github_url":"https://github.com/mdn/translated-content/blob/main/files/zh-cn/glossary/base64/index.md","last_commit_url":"https://github.com/mdn/translated-content/commit/921c46a374ab0a9f4cc809af0370f8c412e54701","filename":"index.md"},"parents":[{"uri":"/zh-CN/docs/Glossary","title":"术语表"},{"uri":"/zh-CN/docs/Glossary/Base64","title":"Base64 的编码与解码"}],"pageTitle":"Base64 的编码与解码 - 术语表 | MDN","noIndexing":false}}