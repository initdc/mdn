{"doc":{"isMarkdown":true,"isTranslated":true,"isActive":true,"flaws":{},"title":"使用 canvas 处理视频","mdn_url":"/zh-CN/docs/Web/API/Canvas_API/Manipulating_video_using_canvas","locale":"zh-CN","native":"中文 (简体)","sidebarHTML":"\n <ol>\n  <li><a href=\"/zh-CN/docs/Web/API/Canvas_API\"><strong>Canvas API</strong></a></li>\n  <li class=\"toggle\">\n    <details open=\"\">\n      <summary>Canvas 教程</summary>\n      <ol>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Basic_usage\">基本用法</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Drawing_shapes\">绘制形状</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Applying_styles_and_colors\">添加样式和颜色</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Drawing_text\">绘制文本</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Using_images\">使用图片</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Transformations\">变形</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Compositing\">合成与裁剪</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Basic_animations\">基本动画</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Advanced_animations\">高级动画</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas\">像素操作</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas\">canvas 的优化</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Tutorial/Finale\">终极</a></li>\n        </ol>\n    </details>\n  </li>\n  <li class=\"toggle\">\n    <details open=\"\">\n      <summary>示例</summary>\n      <ol>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/A_basic_ray-caster\">一个基本的光线投射例子</a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/Canvas_API/Manipulating_video_using_canvas\">在 canvas 中操作视频</a></li>\n      </ol>\n    </details>\n  </li>\n  <li class=\"toggle\">\n    <details open=\"\">\n      <summary>接口</summary>\n      <ol>\n        <li><a href=\"/zh-CN/docs/Web/API/HTMLCanvasElement\"><code>HTMLCanvasElement</code></a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/CanvasRenderingContext2D\"><code>CanvasRenderingContext2D</code></a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/CanvasGradient\"><code>CanvasGradient</code></a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/CanvasPattern\"><code>CanvasPattern</code></a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/ImageBitmap\"><code>ImageBitmap</code></a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/ImageData\"><code>ImageData</code></a></li>\n        <li><a href=\"/zh-CN/docs/Web/API/TextMetrics\"><code>TextMetrics</code></a></li>\n        <li><svg class=\"icon icon-experimental\" tabindex=\"0\">\n    <use xlink:href=\"/assets/badges.svg#icon-experimental\"></use>\n</svg> <a href=\"/zh-CN/docs/Web/API/Path2D\"><code>Path2D</code></a></li>\n      </ol>\n    </details>\n  </li>\n  <li><strong><a href=\"/zh-CN/docs/MDN\">文档:</a></strong></li>\n  <li class=\"toggle\">\n    <details>\n      <summary>贡献</summary>\n      <ol>\n        <li><a href=\"/zh-CN/docs/MDN\">MDN 项目</a></li>\n      </ol>\n    </details>\n  </li>\n </ol>\n","body":[{"type":"prose","value":{"id":null,"title":null,"isH3":false,"content":"<p>通过在一个 canvas（画布）上结合 video 元素功能，你可以实时地操纵视频数据来合成各种视觉特效到正在呈现的视频画面中。本教程示范如何使用 JavaScript 代码执行色度键控（也被称为“绿屏效果”）。</p>\n<p><a href=\"https://media.prod.mdn.mozit.cloud/samples/video/chroma-key/index.xhtml\" class=\"external\" rel=\" noopener\">查看该实例</a>。</p>"}},{"type":"prose","value":{"id":"文档内容","title":"文档内容","isH3":false,"content":"<p>以下是用于渲染该内容的 XHTML 文档。</p>\n<div class=\"code-example\"><pre class=\"brush: html notranslate\"><code><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span> <span class=\"token name\">PUBLIC</span> <span class=\"token string\">\"-//W3C//DTD XHTML 1.0 Transitional//EN\"</span>\n        <span class=\"token string\">\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">xmlns</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://www.w3.org/1999/xhtml<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token style\"><span class=\"token language-css\">\n      <span class=\"token selector\">body</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">background</span><span class=\"token punctuation\">:</span> black<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">color</span><span class=\"token punctuation\">:</span>#CCCCCC<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token selector\">#c2</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">background-image</span><span class=\"token punctuation\">:</span> <span class=\"token url\"><span class=\"token function\">url</span><span class=\"token punctuation\">(</span>foo.png<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token property\">background-repeat</span><span class=\"token punctuation\">:</span> no-repeat<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token selector\">div</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">float</span><span class=\"token punctuation\">:</span> left<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">border</span> <span class=\"token punctuation\">:</span>1px solid #444444<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span>10px<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">margin</span><span class=\"token punctuation\">:</span> 10px<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">background</span><span class=\"token punctuation\">:</span>#3B3B3B<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript;<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>main.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span> <span class=\"token special-attr\"><span class=\"token attr-name\">onload</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value javascript language-javascript\">processor<span class=\"token punctuation\">.</span><span class=\"token function\">doLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>video</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>video<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>video.ogv<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">controls</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>c1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>160<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>96<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>c2<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>160<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>96<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div>\n<p>从这里带出的关键有：</p>\n<ol>\n  <li>这篇文档布置了两个 <a href=\"/zh-CN/docs/Web/HTML/Element/canvas\"><code>canvas</code></a> 元素，分别带着 ID 为 <code>c1</code> 和 <code>c2</code> 的属性。Canvas <code>c1</code> 用于显示原视频的当前帧，而 <code>c2</code> 用于显示执行了色度键控效果后的视频；<code>c2</code> 预先加载将被用于替换视频中绿幕（绿色背景）的静态图像。</li>\n  <li>JavaScript 代码从一个名为 <code>main.js</code> 的脚本引入；这个脚本使用 JavaScript 1.8 特性，所以在 22 行引入脚本时它的 version（版本）是指定的。</li>\n  <li>当文档加载时，在 <code>main.js</code> 里的 <code>processor.doLoad()</code> 方法开始执行。</li>\n</ol>"}},{"type":"prose","value":{"id":"javascript_代码","title":"JavaScript 代码","isH3":false,"content":"<p><code>main.js</code> 里的 JavaScript 代码由三个方法组成。</p>"}},{"type":"prose","value":{"id":"初始化色键播放器","title":"初始化色键播放器","isH3":true,"content":"<p>当 XHTML 文档最初加载时 <code>doLoad()</code> 方法被调用。这个方法的工作是准备色键处理代码所需的变量，并设置一个监听事件以便我们可以监测用户何时开始播放视频。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>  <span class=\"token keyword\">var</span> processor<span class=\"token punctuation\">;</span>\n\n  processor<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">doLoad</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">doLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>video <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'video'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>c1 <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'c1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ctx1 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>c1<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>c2 <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'c2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ctx2 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>c2<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> self <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>video<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'play'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        self<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>video<span class=\"token punctuation\">.</span>videoWidth <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n        self<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>video<span class=\"token punctuation\">.</span>videoHeight <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n        self<span class=\"token punctuation\">.</span><span class=\"token function\">timerCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</code></pre></div>\n<p>这段代码抓取 XHTML 文档中关键元素的引用，即 <code>video</code> 元素和两个 <code>canvas</code> 元素。它也获取了两个 canvas 各自的图形上下文引用。这些将在我们真正做色键控制效果的时候被用到。</p>\n<p>然后 <code>addEventListener()</code> 被调用来开始监视 <code>video</code> 元素以便我们在用户按下视频上的播放按钮时获得通知。为响应用户开始回放，这段代码获取了视频的宽度和高度，并各自减半（当我们执行色度键控效果的时候我们将减半视频的尺寸），然后调用 <code>timerCallback()</code> 方法来开始监视视频以及计算视觉效果。</p>"}},{"type":"prose","value":{"id":"计时器回调","title":"计时器回调","isH3":true,"content":"<p>计时器回调最初在视频开始播放时（当“播放”事件发生时）被调用，然后负责设定自身定期被调用以便为每一帧启用键控效果。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>  processor<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">timerCallback</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">timerCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>video<span class=\"token punctuation\">.</span>paused <span class=\"token operator\">||</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>video<span class=\"token punctuation\">.</span>ended<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">computeFrame</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> self <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        self<span class=\"token punctuation\">.</span><span class=\"token function\">timerCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</code></pre></div>\n<p>回调做的第一件事情是检查视频是否正好在播放；如果不是，回调立即返回并不会做任何事情。</p>\n<p>然后（如果视频正在播放）它调用 <code>computeFrame()</code> 方法，该方法对当前视频帧执行色度键控效果。</p>\n<p>回调做的最后一件事是调用 <code>setTimeout()</code> 来设定它自身被尽快地再次调用。在真实环境中，你可能会根据视频的帧速率情况来计划实现这种调用。</p>"}},{"type":"prose","value":{"id":"操作视频帧数据","title":"操作视频帧数据","isH3":true,"content":"<p>下方展示的 <code>computeFrame()</code> 方法负责真实获取一帧数据并执行色度键控效果。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>  processor<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">computeFrame</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">computeFrame</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ctx1<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>video<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> frame <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ctx1<span class=\"token punctuation\">.</span><span class=\"token function\">getImageData</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> l <span class=\"token operator\">=</span> frame<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> l<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> r <span class=\"token operator\">=</span> frame<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">let</span> g <span class=\"token operator\">=</span> frame<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">let</span> b <span class=\"token operator\">=</span> frame<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g <span class=\"token operator\">&gt;</span> <span class=\"token number\">100</span> <span class=\"token operator\">&amp;&amp;</span> r <span class=\"token operator\">&gt;</span> <span class=\"token number\">100</span> <span class=\"token operator\">&amp;&amp;</span> b <span class=\"token operator\">&lt;</span> <span class=\"token number\">43</span><span class=\"token punctuation\">)</span>\n        frame<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ctx2<span class=\"token punctuation\">.</span><span class=\"token function\">putImageData</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>当这段例行程序被调用时，video 元素正显示最新的视频数据帧，就像这样：</p>\n<p>\n  <img src=\"/@api/deki/files/3282/=video.png\" alt=\"video.png\" loading=\"lazy\">\n</p>\n<p>在第 2 行，视频帧被复制到第一个 canvas 的图形上下文 <code>ctx1</code> 中，并指定了和我们之前保存的值一样的宽度和高度来绘制一半大小的帧。注意这点，你可以简单地把 video 元素放到上下文的 <code>drawImage()</code> 方法当中来绘制当前的视频帧到上下文里。效果如下：</p>\n<p>\n  <img src=\"/@api/deki/files/3284/=sourcectx.png\" alt=\"sourcectx.png\" loading=\"lazy\">\n</p>\n<p>第 3 行通过在第一个上下文里调用 <code>getImageData()</code> 方法获取到视频当前帧的原始图形数据的拷贝。它提供了原始的 32 位像素的图像数据使我们可以继续操作。第 4 行通过用帧的图像数据的总大小除以四来计算图像中的像素数。</p>\n<p>从第 6 行开始 <code>for</code> 循环扫描帧的像素，取出每个像素的红、绿和蓝的值，并和用于检测绿幕的预设的数对比。其中绿幕将用从 <code>foo.png</code> 导入的静态背景图像替换。</p>\n<p>每一个（数值）范围内得到的被认为是绿幕一部分的帧图像数据里的像素具有的 alpha 值被替换为零，以表示该像素完全透明。因此，最终的图像里的整个绿幕的区域 100% 透明，于是在 13 行当它被绘制到目标上下文中时，效果是作为一层遮罩覆于静态背景上面。</p>\n<p>形成的图像像这样：</p>\n<p>\n  <img src=\"/@api/deki/files/3283/=output.png\" alt=\"output.png\" loading=\"lazy\">\n</p>\n<p>这随视频播放而被反复实现，所以一帧接着一帧被处理并带有色键效果被显示出来。</p>\n<p><a href=\"https://media.prod.mdn.mozit.cloud/samples/video/chroma-key/index.xhtml\" class=\"external\" rel=\" noopener\">查看该实例</a>。</p>"}},{"type":"prose","value":{"id":"参见","title":"参见","isH3":false,"content":"<ul>\n  <li><a href=\"/en-US/docs/Learn/HTML/Multimedia_and_embedding/Video_and_audio_content\" class=\"only-in-en-us\" title=\"Currently only available in English (US)\">使用音频和视频 (en-US)</a></li>\n</ul>"}}],"toc":[{"text":"文档内容","id":"文档内容"},{"text":"JavaScript 代码","id":"javascript_代码"},{"text":"参见","id":"参见"}],"summary":"通过在一个 canvas（画布）上结合 video 元素功能，你可以实时地操纵视频数据来合成各种视觉特效到正在呈现的视频画面中。本教程示范如何使用 JavaScript 代码执行色度键控（也被称为“绿屏效果”）。","popularity":0.0009,"modified":"2022-10-01T03:41:16.000Z","other_translations":[{"title":"Manipulating video using canvas","locale":"en-US","native":"English (US)"},{"title":"Manipular video por medio de canvas","locale":"es","native":"Español"},{"title":"Manipulation vidéo avec la balise canvas","locale":"fr","native":"Français"},{"title":"캔버스(canvas)를 이용한 비디오 조작하기","locale":"ko","native":"한국어"}],"source":{"folder":"zh-cn/web/api/canvas_api/manipulating_video_using_canvas","github_url":"https://github.com/mdn/translated-content/blob/main/files/zh-cn/web/api/canvas_api/manipulating_video_using_canvas/index.md","last_commit_url":"https://github.com/mdn/translated-content/commit/921c46a374ab0a9f4cc809af0370f8c412e54701","filename":"index.md"},"parents":[{"uri":"/zh-CN/docs/Web","title":"Web 开发技术"},{"uri":"/zh-CN/docs/Web/API","title":"Web API 接口参考"},{"uri":"/zh-CN/docs/Web/API/Canvas_API","title":"Canvas"},{"uri":"/zh-CN/docs/Web/API/Canvas_API/Manipulating_video_using_canvas","title":"使用 canvas 处理视频"}],"pageTitle":"使用 canvas 处理视频 - Web API 接口参考 | MDN","noIndexing":false}}