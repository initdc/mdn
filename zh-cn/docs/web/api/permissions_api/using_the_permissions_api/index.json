{"doc":{"isMarkdown":true,"isTranslated":true,"isActive":true,"flaws":{},"title":"Using the Permissions API","mdn_url":"/zh-CN/docs/Web/API/Permissions_API/Using_the_Permissions_API","locale":"zh-CN","native":"中文 (简体)","sidebarHTML":"<ol><li><strong><a href=\"/zh-CN/docs/Web/API/Permissions_API\">Permissions API</a></strong></li><li class=\"toggle\"><details open=\"\"><summary>指南</summary><ol><li><a href=\"/zh-CN/docs/Web/API/Permissions_API/Using_the_Permissions_API\">Using the Permissions API</a></li></ol></details></li><li class=\"toggle\"><details open=\"\"><summary>接口</summary><ol><li><a href=\"/zh-CN/docs/Web/API/Permissions\"><code>Permissions</code></a></li><li><a href=\"/zh-CN/docs/Web/API/PermissionStatus\"><code>PermissionStatus</code></a></li></ol></details></li><li class=\"toggle\"><details open=\"\"><summary>属性</summary><ol><li><a href=\"/zh-CN/docs/Web/API/Navigator/permissions\"><code>Navigator.permissions</code></a></li><li><a href=\"/zh-CN/docs/Web/API/WorkerNavigator/permissions\"><code>WorkerNavigator.permissions</code></a></li></ol></details></li></ol>","body":[{"type":"prose","value":{"id":null,"title":null,"isH3":false,"content":"<div class=\"notecard experimental\" id=\"sect1\"><p><strong>Experimental:</strong> <strong>这是一个实验中的功能</strong><br>此功能某些浏览器尚在开发中，请参考<a href=\"#browser_compatibility\">浏览器兼容性表格</a>以得到在不同浏览器中适合使用的前缀。由于该功能对应的标准文档可能被重新修订，所以在未来版本的浏览器中该功能的语法和行为可能随之改变。</p></div>\n<p>本文提供了使用 W3C Permission API 的基本说明，它提供了一种程序上的方式来查询当前上下文的 API 权限授权状态。</p>"}},{"type":"prose","value":{"id":"申请权限面临的困境","title":"申请权限面临的困境...","isH3":false,"content":"<p>惨淡的事实是，权限在 Web 开发中是令人厌恶却不得不面对的问题，对于开发者而言，处理它毫无乐趣。</p>\n<p>由于历史原因，不同的 API 使用各自不同的方式来处理自己的权限 ── 例如，Notification API 允许显式地检查权限状态和申请权限，然而，Geolocation API 却不能（如果用户拒绝了首次权限请求，就会造成我们下面将要看到的问题）。</p>\n<p><a href=\"/zh-CN/docs/Web/API/Permissions_API\">Permissions API</a> 提供了一系列工具来让开发者在权限方面实现更好的用户体验。例如，它提供了特定的 API 来查询某个权限被授予了还是被拒绝了，以及可以使用 API 来申请特定的权限。</p>\n<p>目前来说，该 API 的实现还在早期阶段，所以浏览器支持也是参差不齐：</p>\n<ul>\n  <li>只在 Chrome 44 以上版本及 Firefox 43 以上版本实现了。</li>\n  <li>当下仅支持 <a class=\"only-in-en-us\" title=\"Currently only available in English (US)\" href=\"/en-US/docs/Web/API/Permissions/query\"><code>Permissions.query()</code> <small>(en-US)</small></a> 方法，它用来查询权限。</li>\n  <li>Chrome 中目前可以被 Permission API 识别的权限仅有 <a href=\"/zh-CN/docs/Web/API/Geolocation\">Geolocation</a> 和 Notification，对于 Firefox 来说，还支持 <a href=\"/zh-CN/docs/Web/API/Push_API\">Push</a> and WebMIDI.</li>\n</ul>\n<p>更多特性将逐步实现。</p>"}},{"type":"prose","value":{"id":"一个简单的例子","title":"一个简单的例子","isH3":false,"content":"<p>在本文中，我们有一个简单的 demo 叫作 Location Finder. 它使用 Geolocation 获取用户的当前位置，并标注在 Google 地图上：</p>\n<p>\n  <img src=\"/en-US/docs/Web/API/Permissions_API/Using_the_Permissions_API/location-finder-with-permissions-api.png\" alt=\"Screenshot showing a map of Greenfield, UK.\" width=\"987\" height=\"603\" loading=\"lazy\">\n</p>\n<p>You can <a href=\"https://chrisdavidmills.github.io/location-finder-permissions-api/\" class=\"external\" rel=\" noopener\">在线运行</a>， 或 <a href=\"https://github.com/chrisdavidmills/location-finder-permissions-api/tree/gh-pages\" class=\"external\" rel=\" noopener\">在 Github 查看源码</a>。 大部分代码都很简单且常见 ── 所以接下来我们会重点关注和 Permission API 有关的代码，如果你想学习其他部分，请自行阅读。</p>"}},{"type":"prose","value":{"id":"访问_permissions_api","title":"访问 Permissions API","isH3":true,"content":"<p>浏览器现已包含 <a href=\"/zh-CN/docs/Web/API/Navigator/permissions\"><code>Navigator.permissions</code></a> 属性使开发者可以访问全局的 <a href=\"/zh-CN/docs/Web/API/Permissions\"><code>Permissions</code></a> 对象。这个对象最终将包含用来查询、申请和重置权限的方法，尽管，目前只有 <a class=\"only-in-en-us\" title=\"Currently only available in English (US)\" href=\"/en-US/docs/Web/API/Permissions/query\"><code>Permissions.query()</code> <small>(en-US)</small></a>; 我们接下来会讨论它。</p>"}},{"type":"prose","value":{"id":"查询权限状态","title":"查询权限状态","isH3":true,"content":"<p>在我们的例子中，权限功能使用一个函数来处理— <code>handlePermission()</code>. 它开始于使用 <a class=\"only-in-en-us\" title=\"Currently only available in English (US)\" href=\"/en-US/docs/Web/API/Permissions/query\"><code>Permissions.query()</code> <small>(en-US)</small></a> 查询权限状态。根据 Promise resolve 后返回的 <a class=\"only-in-en-us\" title=\"Currently only available in English (US)\" href=\"/en-US/docs/Web/API/PermissionStatus\"><code>PermissionStatus</code> <small>(en-US)</small></a> 对象的 <a class=\"only-in-en-us\" title=\"Currently only available in English (US)\" href=\"/en-US/docs/Web/API/PermissionStatus/state\"><code>state</code> <small>(en-US)</small></a> 属性，做出不同的处理：</p>\n<dl>\n  <dt id=\"granted\"><code>\"granted\"</code></dt>\n  <dd>\n    <p>\"Enable Geolocation\" 按钮被隐藏掉了，因为 Geolocation 已经被允许了，不需要这个按钮了。</p>\n  </dd>\n  <dt id=\"prompt\"><code>\"prompt\"</code></dt>\n  <dd>\n    <p>隐藏 \"Enable Geolocation\" 按钮，因为用户会被（浏览器）引导授权 Geolocation 权限，所以它不需要了。接下来 <a href=\"/zh-CN/docs/Web/API/Geolocation/getCurrentPosition\"><code>Geolocation.getCurrentPosition()</code></a> 函数会运行，它会引导用户授权；如果用户授权了，它会继续执行 <code>revealPosition()</code> 函数（会显示地图）；如果用户拒绝了， <code>positionDenied()</code> 函数会被执行（这会让 \"Enable Geolocation\" 按钮显示出来）。</p>\n  </dd>\n  <dt id=\"denied\"><code>\"denied\"</code></dt>\n  <dd>\n    <p>\"Enable Geolocation\" 按钮会被显示（这段代码也需要放在这里，以防在页面首次加载时，这个源的权限状态就已经被设置为拒绝了）。</p>\n  </dd>\n</dl>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">handlePermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  navigator<span class=\"token punctuation\">.</span>permissions<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span><span class=\"token string\">'geolocation'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>state <span class=\"token operator\">==</span> <span class=\"token string\">'granted'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">report</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      geoBtn<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>state <span class=\"token operator\">==</span> <span class=\"token string\">'prompt'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">report</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      geoBtn<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span>\n      navigator<span class=\"token punctuation\">.</span>geolocation<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentPosition</span><span class=\"token punctuation\">(</span>revealPosition<span class=\"token punctuation\">,</span>positionDenied<span class=\"token punctuation\">,</span>geoSettings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>state <span class=\"token operator\">==</span> <span class=\"token string\">'denied'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">report</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      geoBtn<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'inline'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onchange</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">report</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">report</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Permission '</span> <span class=\"token operator\">+</span> state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">handlePermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>"}},{"type":"prose","value":{"id":"权限描述符","title":"权限描述符","isH3":true,"content":"<p><a class=\"only-in-en-us\" title=\"Currently only available in English (US)\" href=\"/en-US/docs/Web/API/Permissions/query\"><code>Permissions.query()</code> <small>(en-US)</small></a> 方法接受一个 <code>PermissionDescriptor</code> 字典作为参数 — 它包含你感兴趣的 API 的名称。一些 API 有继承自默认的 <code>PermissionDescriptor</code> 的更加复杂的 <code>PermissionDescriptor</code>s 以包含更多额外的信息。例如，<code>PushPermissionDescriptor</code> 也包含一个比尔值指定 <a href=\"/zh-CN/docs/Web/API/PushManager/subscribe#parameters\"><code>userVisibleOnly</code></a> 是 <code>true</code> 还是 <code>false</code>.</p>"}},{"type":"prose","value":{"id":"重置权限","title":"重置权限","isH3":true,"content":"<p>从 Firefox 47 开始，你可以使用 <a class=\"only-in-en-us\" title=\"Currently only available in English (US)\" href=\"/en-US/docs/Web/API/Permissions/revoke\"><code>Permissions.revoke()</code> <small>(en-US)</small></a> 方法重置现有权限。它的调用方式和 <a class=\"only-in-en-us\" title=\"Currently only available in English (US)\" href=\"/en-US/docs/Web/API/Permissions/query\"><code>Permissions.query()</code> <small>(en-US)</small></a> 方法几乎一模一样，区别是，当 promise 成功 resolve 时，它会让一个现有的权限恢复默认状态（通常是 <code>prompt</code>）。让我们看看 demo 中的代码：</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">var</span> revokeBtn <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.revoke'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token operator\">...</span>\n\nrevokeBtn<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">revokePermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n  <span class=\"token operator\">...</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">revokePermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  navigator<span class=\"token punctuation\">.</span>permissions<span class=\"token punctuation\">.</span><span class=\"token function\">revoke</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span><span class=\"token string\">'geolocation'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">report</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect2\">\n  <p><strong>备注：</strong> 自 Firefox 51 开始 <code>revoke()</code> 函数被默认关闭了，因为它的设计带来了 <a href=\"https://www.w3.org/2011/webappsec/\" class=\"external\" rel=\" noopener\">Web Applications Security Working Group</a> 中提到的问题。可以通过将设置项 <code>dom.permissions.revoke.enable</code> 置为 <code>true</code> 来重新开启它。</p>\n</div>"}},{"type":"prose","value":{"id":"响应权限状态变化","title":"响应权限状态变化","isH3":true,"content":"<p>你会注意到，在上面的代码中，在 <a class=\"only-in-en-us\" title=\"Currently only available in English (US)\" href=\"/en-US/docs/Web/API/PermissionStatus\"><code>PermissionStatus</code> <small>(en-US)</small></a> 对象上有一个 <code>onchange</code> 事件回调 — 这让我们可以对感兴趣的 API 的状态变化做出响应。目前，我们只是上报了状态的变化。</p>"}},{"type":"prose","value":{"id":"总结和展望未来","title":"总结和展望未来","isH3":false,"content":"<p>目前，较之我们已有的，这个 API 并没有提供太多额外内容。如果在浏览器询问时，我们选择了从不分享我们的位置，那么不使用浏览器菜单选项的话，我们将无法返回权限的初始状态（询问）：</p>\n<ul>\n  <li><strong>Firefox</strong>: <em>工具 &gt; 页面信息 &gt; 权限 &gt; 访问你的位置</em>。选择“总是询问”。</li>\n  <li><strong>Chrome</strong>: <em>汉堡菜单 &gt; 设置 &gt; 显示高级设置。在隐私部分，点击“内容设置”。在出现的对话框中，找到 “位置” 部分，选择“当网站试图访问时询问”...最后，点击“管理特例”</em>，移除你对特定网站的授权。</li>\n</ul>\n<p>但是，未来浏览器会提供 <code>request()</code> 方法，他让我们可以在任何时候以编程的方式来请求权限。这非常值得期待尽快被实现。</p>"}}],"toc":[{"text":"申请权限面临的困境...","id":"申请权限面临的困境"},{"text":"一个简单的例子","id":"一个简单的例子"},{"text":"总结和展望未来","id":"总结和展望未来"}],"summary":"本文提供了使用 W3C Permission API 的基本说明，它提供了一种程序上的方式来查询当前上下文的 API 权限授权状态。","popularity":0,"modified":"2022-10-01T03:41:16.000Z","other_translations":[{"title":"Using the Permissions API","locale":"en-US","native":"English (US)"},{"title":"Permissions API の使用","locale":"ja","native":"日本語"}],"source":{"folder":"zh-cn/web/api/permissions_api/using_the_permissions_api","github_url":"https://github.com/mdn/translated-content/blob/main/files/zh-cn/web/api/permissions_api/using_the_permissions_api/index.md","last_commit_url":"https://github.com/mdn/translated-content/commit/921c46a374ab0a9f4cc809af0370f8c412e54701","filename":"index.md"},"parents":[{"uri":"/zh-CN/docs/Web","title":"Web 开发技术"},{"uri":"/zh-CN/docs/Web/API","title":"Web API 接口参考"},{"uri":"/zh-CN/docs/Web/API/Permissions_API","title":"Permissions API"},{"uri":"/zh-CN/docs/Web/API/Permissions_API/Using_the_Permissions_API","title":"Using the Permissions API"}],"pageTitle":"Using the Permissions API - Web API 接口参考 | MDN","noIndexing":false}}