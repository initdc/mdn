{"doc":{"isMarkdown":true,"isTranslated":true,"isActive":true,"flaws":{},"title":"HTTP Public Key Pinning (HPKP)","mdn_url":"/zh-CN/docs/Web/Security/Certificate_Transparency","locale":"zh-CN","native":"中文 (简体)","sidebarHTML":"","body":[{"type":"prose","value":{"id":null,"title":null,"isH3":false,"content":"<p>HTTP 公钥锁定（HPKP）是一种安全功能，它告诉 Web 客户端将特定加密公钥与某个 Web 服务器相关联，以降低使用伪造证书进行 MITM 攻击的风险。</p>\n<p>为确保 TLS 会话中使用的服务器公钥的真实性，此公钥将包装到 X.509 证书中，该证书通常由证书颁发机构（CA）签名。诸如浏览器之类的 Web 客户端信任许多这些 CA，它们都可以为任意域名创建证书。如果攻击者能够攻击单个 CA，则他们可以对各种 TLS 连接执行 MITM 攻击。HPKP 可以通过告知客户端哪个公钥属于某个 Web 服务器来规避 HTTPS 协议的这种威胁。</p>\n<p>HPKP 是首次使用信任（TOFU）技术。Web 服务器第一次通过特殊的 HTTP 标头告诉客户端哪些公钥属于它，客户端会在给定的时间段内存储此信息。当客户端再次访问服务器时，它希望证书链中至少有一个证书包含一个公钥，其指纹已通过 HPKP 已知。如果服务器提供未知的公钥，则客户端应向用户发出警告。</p>\n<p>Firefox 和 Chrome 禁用固定主机的引脚验证，其验证的证书链终止于用户定义的信任锚（而不是内置信任锚）。这意味着对于导入自定义根证书的用户，将忽略所有固定违规。</p>"}},{"type":"prose","value":{"id":"启用_hpkp","title":"启用 HPKP","isH3":false,"content":"<p>要为您的站点启用此功能，您需要在通过 HTTPS 访问站点时返回 Public-Key-Pins HTTP 标头：</p>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">Public-Key-Pins: pin-sha256=\"base64==\"; max-age=expireTime [; includeSubDomains][; report-uri=\"reportURI\"]\n</pre></div>\n<dl>\n  <dt id=\"pin-sha256\"><code>pin-sha256</code></dt>\n  <dd>\n    <p>引用的字符串是 Base64 编码的主题公钥信息（SPKI）指纹。可以为不同的公钥指定多个引脚。某些浏览器将来可能允许使用其他哈希算法而不是 SHA-256。请参阅下文，了解如何从证书或密钥文件中提取此信息。</p>\n  </dd>\n  <dt id=\"max-age\"><code>max-age</code></dt>\n  <dd>\n    <p>浏览器应记住仅使用其中一个已定义的密钥访问此站点的时间（以秒为单位）。</p>\n  </dd>\n  <dt id=\"includesubdomains\"><code>includeSubDomains</code> <span class=\"badge inline optional\">可选</span></dt>\n  <dd>\n    <p>如果指定了此可选参数，则此规则也适用于所有站点的子域。</p>\n  </dd>\n  <dt id=\"report-uri\"><code>report-uri</code> <span class=\"badge inline optional\">可选</span></dt>\n  <dd>\n    <p>如果指定了此可选参数，则会将引脚验证失败报告给给定的 URL。</p>\n  </dd>\n</dl>\n<div class=\"notecard note\" id=\"sect1\">\n  <p><strong>备注：</strong> 当前规范要求包含第二个用于备份密钥的引脚，该引脚尚未在生产中使用。这允许更改服务器的公钥，而不会破坏已经记下引脚的客户端的无障碍。例如，当前一个密钥被泄露时，这很重要。</p>\n</div>"}},{"type":"prose","value":{"id":"提取_base64_编码的公钥信息","title":"提取 Base64 编码的公钥信息","isH3":true,"content":"<div class=\"notecard note\" id=\"sect2\">\n  <p><strong>备注：</strong> 虽然下面的示例显示了如何在服务器证书上设置引脚，但建议将引脚放在颁发服务器证书的 CA 的中间证书上，以简化证书续订和轮换。</p>\n</div>\n<p>首先，您需要从证书或密钥文件中提取公钥信息，并使用 Base64 对其进行编码。</p>\n<p>以下命令将帮助您从密钥文件，证书签名请求或证书中提取 Base64 编码信息。</p>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">openssl rsa -in my-rsa-key-file.key -outform der -pubout | openssl dgst -sha256 -binary | openssl enc -base64\n</pre></div>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">openssl ec -in my-ecc-key-file.key -outform der -pubout | openssl dgst -sha256 -binary | openssl enc -base64\n</pre></div>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">openssl req -in my-signing-request.csr -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64\n</pre></div>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">openssl x509 -in my-certificate.crt -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64\n</pre></div>\n<p>以下命令将提取网站的 Base64 编码信息。</p>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">openssl s_client -servername www.example.com -connect www.example.com:443 | openssl x509 -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64\n</pre></div>"}},{"type":"prose","value":{"id":"hpkp_头示例","title":"HPKP 头示例","isH3":true,"content":"<div class=\"code-example\"><pre class=\"brush: plain notranslate\">Public-Key-Pins:\n  pin-sha256=\"cUPcTAZWKaASuYWhhneDttWpY3oBAkE3h2+soZS7sWs=\";\n  pin-sha256=\"M8HztCzM3elUxkcjR2S5P4hhyBNf6lHkmjAHKhpGPWE=\";\n  max-age=5184000; includeSubDomains;\n  report-uri=\"https://www.example.org/hpkp-report\"\n</pre></div>\n<p>在此示例中，<code>pin-sha256=\"cUPcTAZWKaASuYWhhneDttWpY3oBAkE3h2+soZS7sWs=\"</code> 固定服务器在生产中使用的公钥。第二个引脚声明引脚- <code>sha256=\"M8HztCzM3elUxkcjR2S5P4hhyBNf6lHkmjAHKhpGPWE=\"</code> 也固定备份密钥。 <code>max-age=5184000</code> 告诉客户端将此信息存储两个月，根据 IETF RFC，这是一个合理的时间限制。此密钥固定也适用于所有子域，includeSubDomains 声明告知。最后，<code>report-uri=\"https://www.example.net/hpkp-report\"</code> 解释了报告引脚验证失败的位置。</p>"}},{"type":"prose","value":{"id":"report-only_header","title":"Report-Only header","isH3":true,"content":"<p>Instead of using a <a href=\"/zh-CN/docs/Web/HTTP/Headers/Expect-CT\"><code>Public-Key-Pins</code></a> header you can also use a <a href=\"/zh-CN/docs/Web/HTTP/Headers/Expect-CT\"><code>Public-Key-Pins-Report-Only</code></a> header. This header only sends reports to the <code>report-uri</code> specified in the header and does still allow browsers to connect to the webserver even if the pinning is violated.</p>"}},{"type":"prose","value":{"id":"setting_up_your_webserver_to_include_the_hpkp_header","title":"Setting up your webserver to include the HPKP header","isH3":true,"content":"<p>The concrete steps necessary to deliver the HPKP header depend on the web server you use.</p>\n<div class=\"notecard note\" id=\"sect3\">\n  <p><strong>备注：</strong> These examples use a max-age of two months and include all subdomains. It is advised to verify that this setup will work for your server.</p>\n</div>\n<div class=\"notecard warning\" id=\"sect4\">\n  <p><strong>警告：</strong> HPKP has the potential to lock out users for a long time if used incorrectly! The use of backup certificates and/or pinning the CA certificate is recommended.</p>\n</div>\n<h4 id=\"apache\">Apache</h4>\n<p>Adding a line similar to the following to your webserver's config will enable HPKP on your Apache. This requires <code>mod_headers</code> enabled.</p>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">Header always set Public-Key-Pins \"pin-sha256=\\\"base64+primary==\\\"; pin-sha256=\\\"base64+backup==\\\"; max-age=5184000; includeSubDomains\"\n</pre></div>\n<h4 id=\"nginx\">Nginx</h4>\n<p>Adding the following line and inserting the appropriate <code>pin-sha256=\"...\"</code> values will enable HPKP on your nginx. This requires the <code>ngx_http_headers_module.</code></p>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">add_header Public-Key-Pins 'pin-sha256=\"base64+primary==\"; pin-sha256=\"base64+backup==\"; max-age=5184000; includeSubDomains' always;\n</pre></div>\n<h4 id=\"lighttpd\">Lighttpd</h4>\n<p>The following line with your relevant key information (pin-sha256=\"...\" fields) will enable HPKP on lighttpd.</p>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">setenv.add-response-header  = ( \"Public-Key-Pins\" =&gt; \"pin-sha256=\\\"base64+primary==\\\"; pin-sha256=\\\"base64+backup==\\\"; max-age=5184000; includeSubDomains\")\n</pre></div>\n<p><strong>Note:</strong> This requires the <code>mod_setenv</code> server.module loaded which can be included by the following if not already loaded.</p>\n<div class=\"code-example\"><pre class=\"brush: plain notranslate\">server.modules += ( \"mod_setenv\" )\n</pre></div>\n<h4 id=\"iis\">IIS</h4>\n<p>Add the following line to the Web.config file to send the <code>Public-Key-Pins</code> header:</p>\n<div class=\"code-example\"><pre class=\"brush: xml notranslate\"><code><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>system.webServer</span><span class=\"token punctuation\">&gt;</span></span>\n  ...\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>httpProtocol</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>customHeaders</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>add</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Public-Key-Pins<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>pin-sha256=<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span>base64+primary==<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span>; pin-sha256=<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span>base64+backup==<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span>; max-age=5184000; includeSubDomains<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>customHeaders</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>httpProtocol</span><span class=\"token punctuation\">&gt;</span></span>\n\n  ...\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>system.webServer</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div>"}},{"type":"prose","value":{"id":"browser_compatibility","title":"Browser compatibility","isH3":false,"content":"{{Compat}}"}},{"type":"prose","value":{"id":"see_also","title":"See also","isH3":false,"content":"<ul>\n  <li><a href=\"/zh-CN/docs/Web/HTTP/Headers/Expect-CT\"><code>Public-Key-Pins</code></a></li>\n  <li><a href=\"/zh-CN/docs/Web/HTTP/Headers/Expect-CT\"><code>Public-Key-Pins-Report-Only</code></a></li>\n  <li>Browser test site: <a href=\"https://projects.dm.id.lv/Public-Key-Pins_test\" class=\"external\" rel=\" noopener\">HSTS and HPKP test</a></li>\n</ul>"}}],"toc":[{"text":"启用 HPKP","id":"启用_hpkp"},{"text":"Browser compatibility","id":"browser_compatibility"},{"text":"See also","id":"see_also"}],"summary":"HTTP 公钥锁定（HPKP）是一种安全功能，它告诉 Web 客户端将特定加密公钥与某个 Web 服务器相关联，以降低使用伪造证书进行 MITM 攻击的风险。","popularity":0.0002,"modified":"2022-10-01T03:41:16.000Z","other_translations":[{"title":"Certificate Transparency","locale":"en-US","native":"English (US)"},{"title":"Public Key Pinning","locale":"fr","native":"Français"},{"title":"証明書の透明性","locale":"ja","native":"日本語"}],"source":{"folder":"zh-cn/web/security/certificate_transparency","github_url":"https://github.com/mdn/translated-content/blob/main/files/zh-cn/web/security/certificate_transparency/index.md","last_commit_url":"https://github.com/mdn/translated-content/commit/921c46a374ab0a9f4cc809af0370f8c412e54701","filename":"index.md"},"parents":[{"uri":"/zh-CN/docs/Web","title":"Web 开发技术"},{"uri":"/zh-CN/docs/Web/Security","title":"Web 安全"},{"uri":"/zh-CN/docs/Web/Security/Certificate_Transparency","title":"HTTP Public Key Pinning (HPKP)"}],"pageTitle":"HTTP Public Key Pinning (HPKP) - Web 安全 | MDN","noIndexing":false}}