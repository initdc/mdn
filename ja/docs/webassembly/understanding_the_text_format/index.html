<!DOCTYPE html><html lang="en-US" prefix="og: https://ogp.me/ns#"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon-48x48.97046865.png"><link rel="apple-touch-icon" href="/apple-touch-icon.0ea0fa02.png"><meta name="theme-color" content="#ffffff"><link rel="manifest" href="/manifest.56b1cedc.json"><link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="MDN Web Docs"><script>Array.prototype.flat&&Array.prototype.includes||document.write('<script src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.flat%2Ces6"><\/script>')</script><title>WebAssembly テキスト形式の理解 - WebAssembly | MDN</title><link rel="preload" as="font" type="font/woff2" crossorigin="" href="/static/media/ZillaSlab-Bold.subset.0beac26b.woff2"><link rel="alternate" title="WebAssembly テキスト形式の理解" href="https://developer.mozilla.org/ja/docs/WebAssembly/Understanding_the_text_format" hreflang="ja"><link rel="alternate" title="理解 WebAssembly 文本格式" href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/Understanding_the_text_format" hreflang="zh"><link rel="alternate" title="Описание текстового формата WebAssembly" href="https://developer.mozilla.org/ru/docs/WebAssembly/Understanding_the_text_format" hreflang="ru"><link rel="alternate" title="Entendendo o formato textual do WebAssembly" href="https://developer.mozilla.org/pt-BR/docs/WebAssembly/Understanding_the_text_format" hreflang="pt"><link rel="alternate" title="Understanding WebAssembly text format" href="https://developer.mozilla.org/ko/docs/WebAssembly/Understanding_the_text_format" hreflang="ko"><link rel="alternate" title="Understanding WebAssembly text format" href="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format" hreflang="en"><meta name="description" content="WebAssembly を人間が読んだり編集したりできるようにするため、 wasm バイナリー形式にはテキスト表現が存在します。これはテキストエディター、ブラウザーの開発者ツールなどで見せるために設計された中間表現です。この記事では、テキスト形式のしくみ、生の構文、および元のバイトコードの表現との関係 (と JavaScript で wasm を表現したラッパーオブジェクト) について説明します。"><meta property="og:url" content="https://developer.mozilla.org/ja/docs/WebAssembly/Understanding_the_text_format"><meta property="og:title" content="WebAssembly テキスト形式の理解 - WebAssembly | MDN"><meta property="og:description" content="WebAssembly を人間が読んだり編集したりできるようにするため、 wasm バイナリー形式にはテキスト表現が存在します。これはテキストエディター、ブラウザーの開発者ツールなどで見せるために設計された中間表現です。この記事では、テキスト形式のしくみ、生の構文、および元のバイトコードの表現との関係 (と JavaScript で wasm を表現したラッパーオブジェクト) について説明します。"><meta property="og:locale" content="ja"><meta property="og:image" content="https://developer.mozilla.org/mdn-social-share.0ca9dbda.png"><meta property="twitter:card" content="summary_large_image"><meta name="robots" content="index, follow"><link rel="canonical" href="https://developer.mozilla.org/ja/docs/WebAssembly/Understanding_the_text_format"><style media="print">.breadcrumbs-container,.document-toc-container,.language-menu,.language-toggle,.on-github,.page-footer,.page-header-main,nav.sidebar,ul.prev-next{display:none!important}.main-page-content,.main-page-content pre{padding:2px}.main-page-content pre{border-left-width:2px}</style><link href="/static/css/main.55b68e13.chunk.css" rel="stylesheet"><script src="/static/js/runtime-main.4bb4c356.js" defer=""></script><script src="/static/js/4.a756dea3.chunk.js" defer=""></script><script src="/static/js/main.d4d565e0.chunk.js" defer=""></script></head><body><div id="root"><ul id="nav-access" class="a11y-nav"><li><a id="skip-main" href="#content">Skip to main content</a></li><li><a id="skip-search" href="#main-q">Skip to search</a></li><li><a id="skip-select-language" href="#select-language">Skip to select language</a></li></ul><div class="page-wrapper document-page"><header class="page-header"><a href="/ja/" class="logo" aria-label="MDN Web Docs"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 451.74 135"><path d="M7.14 8.35v111.06h111.05V8.35zm103.71 56c-.48.92-1 1.79-1.46 2.71a3.44 3.44 0 01-3.54 2 2.4 2.4 0 00-1.55.5c-1.37.9-2.76 1.79-4.18 2.63a7.33 7.33 0 01-6.35.34 29.71 29.71 0 00-10.63-2 11.7 11.7 0 00-9.46 4.31 14.84 14.84 0 00-2.13 4.29c-1.24 3.07-2.3 21.38-2.3 26.05 0 0-17.62-3.42-34.15-20.34l4.31-11.32h-13.5l9.76-10.35h-16.8l9.77-10.34H12.69L30.45 34a40.9 40.9 0 0119.77-10.83c7.1-1.22 8.93-.53 13.31.77l2.43.73.85.25 3.1.95a12.56 12.56 0 006.21.09 11.37 11.37 0 018.25 1 8.24 8.24 0 014.1 6.22 7.29 7.29 0 003.61 5.49 59.45 59.45 0 009.32 4.11c2.27.86 4.54 1.84 6.79 2.72a6.81 6.81 0 012.86 2.06 4.81 4.81 0 011.1 2.73c.14 2 .37 4 .47 6a15.24 15.24 0 01-1.77 8.03zM320.12 39.62a5.42 5.42 0 00-4.53 2.13 7.36 7.36 0 00-1.7 4.43v2.36a6.28 6.28 0 001.7 4.46 5.63 5.63 0 004.3 1.82 5.12 5.12 0 004.57-2.27A9.7 9.7 0 00326 47a8.11 8.11 0 00-1.67-5.52 5.36 5.36 0 00-4.21-1.86zM387.38 39.53a5.52 5.52 0 00-4.7 2.15 8.8 8.8 0 00-1.63 5.49 9.23 9.23 0 001.58 5.45 5.38 5.38 0 004.7 2.25 5.61 5.61 0 004.74-2.2 8.91 8.91 0 001.68-5.59 8.24 8.24 0 00-1.75-5.52 5.76 5.76 0 00-4.62-2.03zM299.47 41.35a4.34 4.34 0 00-4-1.92 4.55 4.55 0 00-3.89 1.73 8.37 8.37 0 00-1.58 4.17h10.48a6.3 6.3 0 00-1.01-3.98zM357.74 30.75H352v23.31h5.72q5.47 0 8.35-3t2.93-8.65q0-5.43-2.88-8.55t-8.38-3.11z"></path><path d="M121.55 8.35v70.8h323V8.35zm42.21 22.45h-4V54h3.68v3.73h-11.25V54h3.31V36.79h-.19l-9.63 19.12h-2.12l-10-19.4h-.19V54h3.45v3.73h-11.15V54h3.68V30.8h-4v-3.73H133l11.66 22.56h.19l11.18-22.56h7.7zm29.12 22.67q-4.11 4.28-11.38 4.28h-14.06v-3.69h3.73V30.75h-3.73v-3.68h13.83q7.59 0 11.66 4.29a15.4 15.4 0 014 11 15.33 15.33 0 01-4.05 11.11zm38.89-22.67h-3.68v27h-2.6L208.08 35h-.19v19h4.67v3.73h-12.22V54h3.49V30.8h-4v-3.73h7.08l16.9 22.09h.19V30.8h-4.58v-3.73h12.32zm43.8 27h-3.31l-7.83-23.18h-.19l-7.55 23.18h-3.35l-8.78-27h-2.65v-3.73H253v3.73h-3.87L255 50.71h.23l6.61-19.91H259v-3.73h11v3.73h-2.78l6.61 20.1h.23l5.43-20.1h-4.15v-3.73h11v3.73h-2.54zm26.71-1.51a9.66 9.66 0 01-6.42 2 10.2 10.2 0 01-7.41-2.74c-1.89-1.82-2.83-4.47-2.83-7.93a12.37 12.37 0 012.64-8.12 9 9 0 017.32-3.21 8.62 8.62 0 016.75 2.69 9.65 9.65 0 012.45 6.52 13.67 13.67 0 01-.28 2.69H290q.29 6.71 6.18 6.7a5.2 5.2 0 003.71-1.18 5.82 5.82 0 001.67-2.83l3.45.71a7.21 7.21 0 01-2.73 4.65zm25.77-1.63c-1.51 2.4-3.92 3.61-7.22 3.61s-5.84-1.29-7.22-3.87c0 .25-.1.82-.21 1.7s-.19 1.44-.22 1.7H309c.16-1 .31-2 .47-3.07a21.42 21.42 0 00.24-3.16v-23h-3.4v-3.3h7.55V40.9a9.76 9.76 0 012.67-3.28 7.33 7.33 0 014.74-1.4 8.48 8.48 0 016.5 2.78q2.55 2.74 2.55 7.74a14.6 14.6 0 01-2.27 7.87zm41.39-1.14q-4.11 4.28-11.37 4.28H344v-3.74h3.73V30.75H344v-3.68h13.83q7.59 0 11.66 4.29a15.41 15.41 0 014.06 11 15.34 15.34 0 01-4.11 11.11zm25.65 1.68a10.53 10.53 0 01-7.9 3.07 10 10 0 01-7.63-3 10.93 10.93 0 01-2.8-7.83 12.13 12.13 0 012.69-7.93q2.69-3.3 8-3.3t8 3.28a12 12 0 012.64 7.76 10.86 10.86 0 01-3 7.9zm22.61.57c-1.4 1.66-3.63 2.5-6.68 2.5a9.58 9.58 0 01-7.15-2.76q-2.72-2.76-2.71-7.91a12.25 12.25 0 012.69-8 9.17 9.17 0 017.5-3.28 15 15 0 013.82.48 10.37 10.37 0 013.5 1.65l.85 5.47-3.35.38-.76-3.54a8.07 8.07 0 00-4.11-1 4.9 4.9 0 00-4.39 2.15 9.93 9.93 0 00-1.41 5.55 8.9 8.9 0 001.5 5.38 5.23 5.23 0 004.44 2c2.92 0 4.67-1.7 5.23-5.1l3.5.71a10.34 10.34 0 01-2.47 5.27zm20.48.75a11.68 11.68 0 01-6.63 1.75 15.52 15.52 0 01-8.26-2.08L424 51l3.26.33-.1 2.74a7 7 0 002.06.66 12.63 12.63 0 002.19.19 8.68 8.68 0 003.66-.75 2.5 2.5 0 001.63-2.36 2.25 2.25 0 00-1.32-2.2 12.65 12.65 0 00-3.28-1 47.39 47.39 0 01-3.9-.82 7.5 7.5 0 01-3.25-1.7 4.67 4.67 0 01-1.33-3.66c0-2.36.88-4 2.62-4.91a12 12 0 015.6-1.37 15 15 0 014.08.55 16.65 16.65 0 013.47 1.39l.47 5.1-3.3.37-.48-3.3a9.5 9.5 0 00-4.06-.9 5.62 5.62 0 00-2.87.66 2.33 2.33 0 00-1.15 2.25 2.13 2.13 0 001.3 2.07 11.91 11.91 0 003.21.92 36.69 36.69 0 013.82.83 7.46 7.46 0 013.21 1.74 4.9 4.9 0 011.3 3.73 5.56 5.56 0 01-2.66 4.91z"></path><path d="M181.17 30.75h-5.71v23.31h5.71q5.47 0 8.36-3t2.88-8.61q0-5.43-2.88-8.55t-8.36-3.15zM121.63 119.32V81.74h114.91v37.58zM153.22 109h-2v-6.85a4.8 4.8 0 00-1.58-4 5.57 5.57 0 00-3.55-1.26 5 5 0 00-4.92 3.26 4.19 4.19 0 00-1.88-2.46 5.82 5.82 0 00-3-.8 4.89 4.89 0 00-4.56 2.56v-2.21h-6.28v3.26h2v8.5h-2v3.23h9.11V109h-2.86v-5.25a4.4 4.4 0 01.69-2.56 2.47 2.47 0 012.21-1q2.57 0 2.56 3.63v8.41h6.29V109h-2v-5.25a4.47 4.47 0 01.67-2.56 2.42 2.42 0 012.19-1q2.63 0 2.63 3.63v8.41h6.28zm9.88-12.07q-4 0-6 2.36a8.41 8.41 0 00-2 5.66 7.25 7.25 0 002.17 5.62 8 8 0 005.65 2 8.54 8.54 0 005.94-2.11 7.27 7.27 0 002.34-5.67 8.21 8.21 0 00-2-5.51q-2.07-2.34-6.1-2.34zm-.1 12.35a3 3 0 01-2.63-1.33 5.68 5.68 0 01-.9-3.26 5 5 0 011-3.28 3.23 3.23 0 012.61-1.18 3.5 3.5 0 012.59 1.08 4.56 4.56 0 011.07 3.31 5.21 5.21 0 01-1 3.41 3.33 3.33 0 01-2.74 1.25zm25-2.3l-3.39-.29-.7 2.32H179l8.32-9.54-.32-2.23h-13.19l-.53 5.25 3.16.34.67-2.36h4.65l-8.25 9.53.44 2.26h13.13zm7.62-9.74h-4.46v5.39h4.46zm0 9.61h-4.46v5.39h4.46zm13.54-17.49h-4.23l-6.48 22.88h4.22zm8.68 0h-4.23l-6.45 22.88h4.19zm15 22.51l-.07-2.26a1.22 1.22 0 01-.56.1c-.69 0-1-.39-1-1.16v-6.49a4.39 4.39 0 00-1.8-3.84 7 7 0 00-4.16-1.28 14.55 14.55 0 00-3.16.3 24.14 24.14 0 00-3.29 1.06l-.56 3.46 3.39.4.5-1.69a2.78 2.78 0 011.08-.37 11.3 11.3 0 011.25-.07c1.19 0 1.89.37 2.09 1.1a8.55 8.55 0 01.3 2.26v.5a8.91 8.91 0 00-1.18-.11h-1.21a12.64 12.64 0 00-4.81.88 3.53 3.53 0 00-2.18 3.64 3.66 3.66 0 001.48 3.33 5.63 5.63 0 003.11 1 4.67 4.67 0 003-.91 6.78 6.78 0 001.8-2 3 3 0 003.33 3 5.54 5.54 0 002.66-.85zm-9.25-2.32a1.69 1.69 0 01-1.36-.52 1.81 1.81 0 01-.43-1.21 1.67 1.67 0 01.86-1.68 4.63 4.63 0 012-.42 7.69 7.69 0 011.07.07l1.06.13a3.58 3.58 0 01-1.08 2.74 3.24 3.24 0 01-2.11.89z"></path></svg></a><button type="button" class="ghost main-menu-toggle" aria-haspopup="true" aria-label="Show Menu"></button><div class="page-header-main "><nav class="main-nav" aria-label="Main menu"><ul class="main-menu nojs"><li class="top-level-entry-container"><button id="technologies-button" type="button" class="top-level-entry" aria-haspopup="menu" aria-expanded="false">Technologies</button><ul class="technologies " role="menu" aria-labelledby="technologies-button"><li role="none"><a tabindex="-1" href="/ja/docs/Web" role="menuitem">Technologies Overview</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/HTML" role="menuitem">HTML</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/CSS" role="menuitem">CSS</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/JavaScript" role="menuitem">JavaScript</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/Guide/Graphics" role="menuitem">Graphics</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/HTTP" role="menuitem">HTTP</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/API" role="menuitem">APIs</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Mozilla/Add-ons/WebExtensions" role="menuitem">Browser Extensions</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/MathML" role="menuitem">MathML</a></li></ul></li><li class="top-level-entry-container"><button id="references-guides-button" type="button" class="top-level-entry" aria-haspopup="menu" aria-expanded="false">References &amp; Guides</button><ul class="references-guides " role="menu" aria-labelledby="references-guides-button"><li role="none"><a tabindex="-1" href="/ja/docs/Learn" role="menuitem">Learn web development</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/Tutorials" role="menuitem">Tutorials</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/Reference" role="menuitem">References</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/Guide" role="menuitem">Developer Guides</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web/Accessibility" role="menuitem">Accessibility</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Games" role="menuitem">Game development</a></li><li role="none"><a tabindex="-1" href="/ja/docs/Web" role="menuitem">...more docs</a></li></ul></li><li class="top-level-entry-container"><button id="feedback-button" type="button" class="top-level-entry" aria-haspopup="menu" aria-expanded="false">Feedback</button><ul class="feedback " role="menu" aria-labelledby="feedback-button"><li role="none"><a tabindex="-1" href="/ja/docs/MDN/Contribute/Feedback" role="menuitem">Send Feedback</a></li><li role="none"><a tabindex="-1" href="/ja/docs/MDN/Contribute" role="menuitem">Contribute to MDN</a></li><li role="none"><a tabindex="-1" target="_blank" rel="noopener noreferrer" href="https://github.com/mdn/content/issues/new" role="menuitem">Report a content issue<!-- --> 🌐</a></li><li role="none"><a tabindex="-1" target="_blank" rel="noopener noreferrer" href="https://github.com/mdn/yari/issues/new" role="menuitem">Report a platform issue<!-- --> 🌐</a></li></ul></li></ul></nav><div class="header-search"><form action="/ja/search" class="search-form search-widget" role="search"><label for="main-q" class="visually-hidden">Search MDN</label><input type="search" name="q" id="main-q" class="search-input-field" placeholder="Site search... (Press &quot;/&quot; to focus)" pattern="(.|\s)*\S(.|\s)*" required="" value=""><input type="submit" class="ghost search-button" value="" aria-label="Search"></form></div><div class="auth-container"></div></div></header><div class="breadcrumb-locale-container"><nav class="breadcrumbs-container" aria-label="Breadcrumb navigation"><ol typeof="BreadcrumbList" vocab="https://schema.org/" aria-label="breadcrumbs"><li property="itemListElement" typeof="ListItem"><a class="breadcrumb-penultimate" property="item" typeof="WebPage" href="/ja/docs/WebAssembly"><span property="name">WebAssembly</span></a><meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem"><a class="breadcrumb-current-page" property="item" typeof="WebPage" href="/ja/docs/WebAssembly/Understanding_the_text_format"><span property="name">WebAssembly テキスト形式の理解</span></a><meta property="position" content="2"></li></ol></nav><ul class="language-toggle"><li><a href="#select-language" class="language-icon"><span class="show-desktop">Change language</span></a></li><li><a class="view-in-english" href="/en-US/docs/WebAssembly/Understanding_the_text_format"><span class="show-desktop">View in</span> English</a></li></ul></div><div class="localized-content-note notecard inline neutral"><a href="/en-US/docs/MDN/Contribute/Localize#active_locales">このページはコミュニティーの尽力で英語から翻訳されました。MDN Web Docs コミュニティーについてもっと知り、仲間になるにはこちらから。</a></div><aside class="document-toc-container"><section class="document-toc"><header><h2>Table of contents</h2><button type="button" class="ghost toc-trigger-mobile" aria-controls="toc-entries" aria-expanded="false">Table of contents</button></header><ul id="toc-entries"><li><a href="#s_式">S 式</a></li><li><a href="#シグネチャと引数">シグネチャと引数</a></li><li><a href="#ローカル変数と引数を取得設定する">ローカル変数と引数を取得/設定する</a></li><li><a href="#スタックマシン">スタックマシン</a></li><li><a href="#はじめての関数本体">はじめての関数本体</a></li><li><a href="#基礎を探る">基礎を探る</a></li><li><a href="#大規模メモリー操作">大規模メモリー操作</a></li><li><a href="#参照型">参照型</a></li><li><a href="#webassembly_の複数値">WebAssembly の複数値</a></li><li><a href="#webassembly_スレッド">WebAssembly スレッド</a></li><li><a href="#まとめ">まとめ</a></li><li><a href="#関連情報">関連情報</a></li></ul></section></aside><main id="content" class="main-content" role="main"><article class="main-page-content" lang="ja"><h1>WebAssembly テキスト形式の理解</h1><div><p>WebAssembly を人間が読んだり編集したりできるようにするため、 wasm バイナリー形式にはテキスト表現が存在します。これはテキストエディター、ブラウザーの開発者ツールなどで見せるために設計された中間表現です。この記事では、テキスト形式のしくみ、生の構文、および元のバイトコードの表現との関係 (と JavaScript で wasm を表現したラッパーオブジェクト) について説明します。</p>
<div class="notecard note" id="sect1">
  <p><strong>Note:</strong> この記事は、あなたがウェブ開発者で wasm モジュールをページに読み込んでコード内で使用するだけなら過剰なものかもしれません (<a href="/ja/docs/WebAssembly/Using_the_JavaScript_API">WebAssembly JavaScript API の使用</a>を参照)。しかし、例えば、パフォーマンスを最適化するために wasm モジュールを書きたいときや、あなた自身で WebAssembly コンパイラーを作るときには役に立ちます。</p>
</div></div><h2 id="s_式"><a href="#s_式" title="Permalink to S 式">S 式</a></h2><div><p>バイナリー、テキスト形式どちらでも、 WebAssembly の基本的なコードの単位はモジュールです。テキスト形式ではモジュールは 1 つの大きな S 式として表現されます。 S 式はツリー構造を表現するための非常に古くてシンプルなテキスト形式で、モジュールをその構造とそのコードを記述するノードツリーとして考えることができます。しかし、プログラミング言語の AST (抽象構文木) とは異なり、　WebAssembly のツリーはかなり平坦で、ほとんどは命令の列で構成されています。</p>
<p>はじめに、 S 式がどういうものか見てみましょう。ツリー内の各ノードは <code>( ... )</code> のように 1 組の括弧内に入れられます。 括弧内の最初のラベルは、それがどのノードタイプかを示し、スペースで区切られた属性、または子ノードのリストが続きます。次のコードは WebAssembly の S 式を意味します。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>ルートノード "module" と 2 つの子ノード、 "1" を属性に持つ "memory" ノード、"func" ノードを表します。これらのノードが実際にどういう意味なのかを見ていきましょう。</p></div><h3 id="最もシンプルなモジュール"><a href="#最もシンプルなモジュール" title="Permalink to 最もシンプルなモジュール">最もシンプルなモジュール</a></h3><div><p>最もシンプルで短い実行可能な wasm モジュールから始めてみましょう。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">)</span>
</code></pre></div>
<p>このモジュールは完全に空ですが、モジュールとしては有効です。</p>
<p>いま、このモジュールをバイナリーに変換すると (<a href="/ja/docs/WebAssembly/Text_format_to_wasm">WebAssembly テキスト形式から wasm に変換する</a> を参照) 、 <a href="http://webassembly.org/docs/binary-encoding/#high-level-structure" class="external" rel=" noopener">バイナリー形式</a> で記述された 8 バイトのモジュールヘッダーだけになります。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token number">0000000</span>: <span class="token number">0061</span> 736d              ; WASM_BINARY_MAGIC
<span class="token number">0000004</span>: <span class="token number">0100</span> <span class="token number">0000</span>              ; WASM_BINARY_VERSION
</code></pre></div></div><h3 id="モジュールに機能を追加する"><a href="#モジュールに機能を追加する" title="Permalink to モジュールに機能を追加する">モジュールに機能を追加する</a></h3><div><p>はい、これは全然面白くないですね。モジュールに実行可能なコードを追加していきましょう。</p>
<p>すべての WebAssembly モジュール内のコードは次の疑似コード構造を持つ関数にグループ化されます:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span> <span class="token keyword">func</span> &lt;signature&gt; &lt;locals&gt; &lt;body&gt; <span class="token punctuation">)</span>
</code></pre></div>
<ul>
  <li><strong>signature</strong> は関数が何を受け取る (引数) かと何を返す (返値) かを宣言します。</li>
  <li><strong>locals</strong> は JavaScript でいうと変数のようなものですが、明示的な型が宣言されます。</li>
  <li><strong>body</strong> は線形の低レベルな命令のリストです。</li>
</ul>
<p>S 式であるために違って見えますが、これは、他の言語の関数に似ています。</p></div><h2 id="シグネチャと引数"><a href="#シグネチャと引数" title="Permalink to シグネチャと引数">シグネチャと引数</a></h2><div><p>シグネチャは、返値の型宣言のリストが後に続く、引数の型宣言の並びです。ここで注目すべきは次の点です。</p>
<ul>
  <li><code>(result)</code> がない場合、その関数は何も返さないということです。</li>
  <li>現在は、最大で 1 つの返値の型を指定することができますが、任意の数に<a href="https://github.com/WebAssembly/spec/blob/master/proposals/multi-value/Overview.md" class="external" rel=" noopener">緩和される予定</a>です。</li>
</ul>
<p>それぞれの引数には、明示的に型を宣言します。 wasm は現在 4 つの数値型を利用できます（さらに参照型もあります。以下の<a href="#%E5%8F%82%E7%85%A7%E5%9E%8B">参照型</a>の項を参照してください）。</p>
<ul>
  <li><code>i32</code>: 32 ビット整数</li>
  <li><code>i64</code>: 64 ビット整数</li>
  <li><code>f32</code>: 32 ビット浮動小数点数</li>
  <li><code>f64</code>: 64 ビット浮動小数点数</li>
</ul>
<p>単体の引数は <code>(param i32)</code> 、返値は <code>(result i32)</code> のように記述します。したがって、 2 つの 32 ビット整数を引数にとり、 64 ビット浮動小数点数を返すバイナリー関数は次のように記述します。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> ... <span class="token punctuation">)</span>
</code></pre></div>
<p>シグネチャのあとに、型付けされたローカル変数のリストが続きます (例: <code>(local i32)</code>) 。引数は基本的に、呼び出し元から渡された対応する引数の値で初期化される単なるローカル変数です。</p></div><h2 id="ローカル変数と引数を取得設定する"><a href="#ローカル変数と引数を取得設定する" title="Permalink to ローカル変数と引数を取得/設定する">ローカル変数と引数を取得/設定する</a></h2><div><p>ローカル変数と引数は関数本体から <code>local.get</code> と <code>local.set</code> 命令を使用して読み書きすることができます。</p>
<p><code>local.get</code>/<code>local.get</code> コマンドは数値のインデックスから取得/設定される項目を参照します。最初に引数が宣言順に、その後に、ローカル変数が宣言順に参照されます。次の関数を見てください。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token keyword">f64</span><span class="token punctuation">)</span>
  <span class="token keyword">local</span>.get <span class="token number">0</span>
  <span class="token keyword">local</span>.get <span class="token number">1</span>
  <span class="token keyword">local</span>.get <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div>
<p>命令 <code>local.get 0</code> は i32 の引数, <code>local.get 1</code> は f32 の引数、そして <code>local.get 2</code> は f64 のローカル変数を取得します。</p>
<p>ここで別の問題があります。数値のインデックスを使用して項目を参照すると、混乱したり、困ってしまうことがあります。そこで、テキスト形式では、単純に型宣言の直前に (<code>$</code>) を接頭辞として付けた名前を、引数、ローカル変数や他の多くの項目につけることができます。</p>
<p>したがって、上記のシグネチャを次のように書き直すことができます。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p1</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p2</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span> <span class="token variable">$loc</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> …<span class="token punctuation">)</span>
</code></pre></div>
<p>そして、<code>local.get 0</code> の代わりに <code>local.get $p1</code> と書くことができるようになります（このテキストがバイナリーに変換されたとき、バイナリーには整数値だけが残されることに注意してください）。</p></div><h2 id="スタックマシン"><a href="#スタックマシン" title="Permalink to スタックマシン">スタックマシン</a></h2><div><p>関数本体を書く前に、もう 1 つ、<strong>スタックマシン</strong>について話をする必要があります。ブラウザーはそれを更に効率的な形にコンパイルしますが、wasm の実行はスタックマシンとして定義されます。スタックマシンの基本的な考え方は、すべての命令がスタックから特定の数の <code>i32</code>/<code>i64</code>/<code>f32</code>/<code>f64</code> 値をプッシュ、ポップするようにすることです。</p>
<p>例えば、 <code>local.get</code> はローカル変数の値をスタックにプッシュするように定義されます。そして、<code>i32.add</code> は2つの <code>i32</code> 値 (スタックにプッシュされた前の2つの値を暗黙的に取得します) をポップし、合計を計算して (2^32 の剰余として) 結果の i32 値をプッシュします。</p>
<p>関数が呼び出されたとき、空のスタックから開始され、徐々に積まれてゆき、本体の命令が実行されると空になります。例として、次の関数の実行後について見てみましょう。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$p</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
  <span class="token keyword">local</span>.get <span class="token variable">$p</span>
  <span class="token keyword">local</span>.get <span class="token variable">$p</span>
  <span class="token keyword">i32<span class="token punctuation">.</span>add</span><span class="token punctuation">)</span>
</code></pre></div>
<p>スタックには <code>i32</code> という値 1 つだけが入っています。これは式 (<code>$p + $p</code>) が <code>i32.add</code> よって処理された結果です。関数の返値はスタックに残った最後の値になります。</p>
<p>WebAssembly のバリデーションルールはスタックが正確に一致することを保証します。もし、<code>(result f32)</code> と宣言した場合、最終的にスタックに1つだけ <code>f32</code> 値が積まれている状態である必要があります。結果の型がない場合は、スタックは空でなければなりません。</p></div><h2 id="はじめての関数本体"><a href="#はじめての関数本体" title="Permalink to はじめての関数本体">はじめての関数本体</a></h2><div><p>前述の通り、関数本体は関数が呼び出された後に続く単純な命令列です。 これまでに学んだことと共に、最終的にはシンプルな関数を含むモジュールを定義することができるようになります。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$lhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$rhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span>.get <span class="token variable">$lhs</span>
    <span class="token keyword">local</span>.get <span class="token variable">$rhs</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>add</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>この関数は 2 つの引数を受け取って、それらを足して、その結果を返します。</p>
<p>関数本体に置けるものはもっとたくさんありますが、いまはシンプルなもので始めます。進むにつれてもっと多くの例を見ていきます。すべての有効なオペコードのリストについては <a href="https://webassembly.github.io/spec/core/exec/index.html" class="external" rel=" noopener">webassembly.org Semantics reference</a> を調べてみてください。</p></div><h3 id="関数を呼び出す"><a href="#関数を呼び出す" title="Permalink to 関数を呼び出す">関数を呼び出す</a></h3><div><p>定義した関数は自身では大したことをしません。いまはそれを呼び出す必要があります。どのようにすればよいでしょうか。 ES2015 モジュールのように、wasm 関数はモジュール内の <code>export</code> ステートメントによって明示的にエクスポートしなければなりません。</p>
<p>ローカル変数と同じように、関数も既定ではインデックスで識別されますが、便宜上の関数名を付けることができます。 <code>func</code> キーワードの直後にドル記号で始まる名前を付けてみましょう。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$add</span> … <span class="token punctuation">)</span>
</code></pre></div>
<p>ここでエクスポート宣言を追加する必要があります。次のようになります。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$add</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>ここで <code>add</code> は JavaScript で認識される関数名であるのに対して、<code>$add</code> はモジュール内の、どの WebAssembly 関数をエクスポートするのかを選択します。</p>
<p>（今のところ）最終的なモジュールは次のようになります。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$add</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$lhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$rhs</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span>.get <span class="token variable">$lhs</span>
    <span class="token keyword">local</span>.get <span class="token variable">$rhs</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>add</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"add"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$add</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>例に従うなら、上のモジュールを <code>add.wat</code> という名前で保存して、wabt を使用して（詳細は <a href="/ja/docs/WebAssembly/Text_format_to_wasm">WebAssembly テキスト形式から wasm に変換する</a> を参照してください）、<code>add.wasm</code> というファイルに変換します。</p>
<p>次に、 <code>addCode</code> という名前の型付き配列にバイナリー読み込み（<a href="/ja/docs/WebAssembly/Loading_and_running">WebAssembly コードのロードと実行</a> で説明されています）、コンパイル、インスタンス化して、JavaScript で <code>add</code> 関数を実行します（<code>add()</code> はインスタンスの <a href="/ja/docs/WebAssembly/JavaScript_interface/Instance/exports"><code>exports</code></a> プロパティから見つけることができます）。</p>
<div class="code-example"><pre class="brush: js notranslate"><code>WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'add.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">obj</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// "3"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="notecard note" id="sect2">
  <p><strong>Note:</strong> この例は GitHub の<a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/add.html" class="external" rel=" noopener">add.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/add.html" class="external" rel=" noopener">動作例</a>) にあります。関数のインスタンス化についての詳細は <a href="/ja/docs/WebAssembly/JavaScript_interface/instantiateStreaming"><code>WebAssembly.instantiateStreaming()</code></a> も合わせて参照してください。</p>
</div></div><h2 id="基礎を探る"><a href="#基礎を探る" title="Permalink to 基礎を探る">基礎を探る</a></h2><div><p>ここでは実際の基本的な例を取り上げてから、いくつかの高度な機能について見てみましょう。</p></div><h3 id="同じモジュールの他の関数から関数を呼び出す"><a href="#同じモジュールの他の関数から関数を呼び出す" title="Permalink to 同じモジュールの他の関数から関数を呼び出す">同じモジュールの他の関数から関数を呼び出す</a></h3><div><p><code>call</code> 命令はインデックスか名前を指定して単一の関数を呼び出します。例えば、次のモジュールには 2 つの関数が含まれています。 1 つ目はただ 42 を返すだけ、もう 1 つは 1 つ目のものに 1 を足した値を返します。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$getAnswer</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"getAnswerPlus1"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">call</span> <span class="token variable">$getAnswer</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>add</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<div class="notecard note" id="sect3">
  <p><strong>Note:</strong> <code>i32.const</code> は 32 ビット整数を定義してスタックにプッシュするだけです。 <code>i32</code> 以外の有効な型に変えて、 const の値を好きなものに変えることができます（ここでは <code>42</code> に設定しました）。</p>
</div>
<p>この例で、 <code>func</code> の直後に宣言された <code>(export "getAnswerPlus1")</code> セクションに気づくでしょう。これはこの関数をエクスポートするための宣言をして、さらにそれに名前をつけるために使用するショートカットです。</p>
<p>これは、上で行ったように、モジュール内の関数外の別の場所で、関数ステートメントと分けて定義するのと同等の機能です。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"getAnswerPlus1"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$functionName</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>上のモジュールを呼び出す JavaScript コードは次のようになります。</p>
<div class="code-example"><pre class="brush: js notranslate"><code>WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'call.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">obj</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">getAnswerPlus1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// "43"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><h3 id="javascript_から関数をインポートする"><a href="#javascript_から関数をインポートする" title="Permalink to JavaScript から関数をインポートする">JavaScript から関数をインポートする</a></h3><div><p>すでに、JavaScript から WebAssembly 関数を呼び出すことについては確認しましたが、WebAssembly から JavaScript 関数を呼び出すことについてはどうでしょうか? WebAssembly は実際に JavaScript のビルトインの情報を持っていませんが、JavaScript か wasm 関数をインポートするための一般的な方法があります。例を見てみましょう。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"console"</span> <span class="token string">"log"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$log</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"logIt"</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">13</span>
    <span class="token keyword">call</span> <span class="token variable">$log</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>WebAssembly は 2 階層の名前空間のインポート文を持っています。ここでは、<code>console</code> モジュールから <code>log</code> 関数をインポートすることを要求しています。また、エクスポートされた <code>logIt</code> 関数から、上で紹介した <code>call</code> 命令を使用して、インポートされた関数を呼ぶ出すことができます。</p>
<p>インポートされた関数は通常の関数と同じようなものです。WebAssembly のバリデーションによって静的にチェックするシグネチャを持ち、インデックスか名前を付けて呼び出すことができます。</p>
<p>JavaScript 関数にはシグネチャの概念がないため、インポート宣言のシグネチャに関係なく、どの JavaScript 関数も渡すことができます。モジュールがインポート宣言をすると、 <a href="/ja/docs/WebAssembly/JavaScript_interface/instantiate"><code>WebAssembly.instantiate()</code></a> を呼び出す側は、対応したプロパティを持ったインポートオブジェクトを渡す必要があります。</p>
<p>上の場合、 <code>importObject.console.log</code> が JavaScript 関数であるようなオブジェクト(<code>importObject</code> と呼びましょう) が必要になります。</p>
<p>これは次のようになります。</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">var</span> importObject <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">console</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'logger.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importObject<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">obj</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">logIt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="notecard note" id="sect4">
  <p><strong>Note:</strong> この例は GitHub の <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/logger.html" class="external" rel=" noopener">logger.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/logger.html" class="external" rel=" noopener">動作例</a>)を参照してください。</p>
</div></div><h3 id="webassembly_でのグローバルの宣言"><a href="#webassembly_でのグローバルの宣言" title="Permalink to WebAssembly でのグローバルの宣言">WebAssembly でのグローバルの宣言</a></h3><div><p>WebAssembly には、 JavaScript からアクセス可能なグローバル変数インスタンスを作成する機能と、 1 つ以上の <a href="/ja/docs/WebAssembly/JavaScript_interface/Module"><code>WebAssembly.Module</code></a> インスタンスにまたがってインポート/エクスポート可能なグローバル変数インスタンスを作成する機能があります。これは、複数のモジュールを動的にリンクすることができるので、とても便利です。</p>
<p>WebAssembly のテキスト形式では、次のようになります (GitHub のリポジトリにある <a href="https://github.com/mdn/webassembly-examples/blob/master/js-api-examples/global.wat" class="external" rel=" noopener">global.wat</a> を参照してください。JavaScript の例は <a href="https://mdn.github.io/webassembly-examples/js-api-examples/global.html" class="external" rel=" noopener">global.html</a> も参照してください)。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
   <span class="token punctuation">(</span><span class="token keyword">global</span> <span class="token variable">$g</span> <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"global"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"getGlobal"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$g</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"incGlobal"</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token keyword">global</span>.set <span class="token variable">$g</span>
            <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>add</span> <span class="token punctuation">(</span><span class="token keyword">global</span>.get <span class="token variable">$g</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>これは、キーワード <code>global</code> を使用してグローバルな値を指定していることと、値のデータ型と一緒にキーワード <code>mut</code> を指定して変更可能にしたい場合に指定していることを除いて、以前に見たものと似ています。</p>
<p>JavaScript を使用して同等の値を作成するには、 <a href="/ja/docs/WebAssembly/JavaScript_interface/Global"><code>WebAssembly.Global()</code></a> コンストラクターを使用してください。</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">const</span> global <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Global</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">"i32"</span><span class="token punctuation">,</span> <span class="token literal-property property">mutable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><h3 id="webassembly_メモリー"><a href="#webassembly_メモリー" title="Permalink to WebAssembly メモリー">WebAssembly メモリー</a></h3><div><p>上の例はとてもひどいロギング関数です。たった 1 つの整数値を表示するだけです。文字列を表示するためにはどうしたらよいでしょうか? 文字列やさらに複雑なデータ型を扱うために WebAssembly は <strong>メモリー</strong> を提供します（WebAssembly のより新しい実装では、<a href="#%E5%8F%82%E7%85%A7%E5%9E%8B">参照型</a>もあります）。 WebAssembly では、メモリーは徐々に拡張することのできるただの大きなバイト列です。 WebAssembly は <code>i32.load</code> や <code>i32.store</code> のような命令を持っており、それで<a href="http://webassembly.org/docs/semantics/#linear-memory" class="external" rel=" noopener">線形メモリー</a>を読み書きします。</p>
<p>JavaScript から見ると、メモリーはすべて 1 つの大きな (リサイズ可能な) <a href="/ja/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code>ArrayBuffer</code></a> の内部にあるように見えます。それはまさに、asm.js とともに動かさなければならないものすべてです (ただしリサイズは出来ません。asm.js の <a href="http://asmjs.org/spec/latest/#programming-model" class="external" rel=" noopener">プログラミングモデル</a> を参照してください) 。</p>
<p>したがって、文字列は線形メモリー内部のどこかに存在するただのバイト列です。適切なバイト列の文字列をメモリーに書き込んだとしましょう。その文字列をどのように JavaScript に渡すのでしょうか?</p>
<p>鍵は <a href="/ja/docs/WebAssembly/JavaScript_interface/Memory"><code>WebAssembly.Memory()</code></a> インターフェースを使用して JavaScript から WebAssembly の線形メモリーを作成し、関連するインスタンスメソッドを使用して既存の Memory インスタンス (現在は 1 モジュールごとに 1 つだけ持つことができます) にアクセスできることです。Memory インスタンスは <a href="/ja/docs/WebAssembly/JavaScript_interface/Memory/buffer"><code>buffer</code></a> ゲッターを持ち、これは線形メモリー全体を指し示す ArrayBuffer を返します。</p>
<p>Memory インスタンスは、例えば JavaScript から <a href="/ja/docs/WebAssembly/JavaScript_interface/Memory/grow"><code>Memory.grow()</code></a> メソッドを使用して拡張することもできます。拡張したとき、<code>ArrayBuffer</code> はサイズを変更することができないため、現在の <code>ArrayBuffer</code> は切り離され、新しく作成された、より大きな <code>ArrayBuffer</code> を指し示すようになります。これは、JavaScript に文字列を渡すために必要なことは、線形メモリー内での文字列のオフセットと長さを指定する方法を渡すことだけであることを意味します。</p>
<p>文字列自身に文字列の長さの情報をエンコードするさまざまな方法 (例えば、 C 言語の文字列) がありますが、簡単にするためにここではオフセットと長さの両方を引数として渡します。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"console"</span> <span class="token string">"log"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$log</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>JavaScript 側では、バイト列を簡単に JavaScript 文字列にデコードするために <a href="/ja/docs/Web/API/TextDecoder">TextDecoder API</a> を使用することができます (ここでは <code>utf8</code> を指定していますが、他の多くのエンコーディングに対応しています) 。</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">function</span> <span class="token function">consoleLogString</span><span class="token punctuation">(</span><span class="token parameter">offset<span class="token punctuation">,</span> length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>memory<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> string <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>最後のに欠けているのは、 <code>consoleLogString</code> が WebAssembly の <code>memory</code> にアクセスする場所です。このあたり WebAssembly は柔軟です。JavaScript から <a href="/ja/docs/WebAssembly/JavaScript_interface/Memory"><code>Memory</code></a> オブジェクトを作成して WebAssembly モジュールでメモリーをインポートするか、WebAssembly モジュールでメモリーを作成して JavaScript で使用するためにエクスポートすることができます。</p>
<p>簡単にするために、JavaScript で作成したメモリーを WebAssembly にインポートしてみましょう。<code>import</code> ステートメントは次のようになります。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"mem"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p><code>1</code> はインポートされたメモリーに少なくとも 1 ページ分のメモリーが必要であることを示します(WebAssembly では 1 ページを 64KB と定義しています)。</p>
<p>文字列 "Hi" を出力する完全なモジュールを見てみましょう。通常のコンパイルされた C のプログラムでは文字列にメモリーを割り当てる関数を呼び出しますが、ここでは独自のアセンブリーを書くだけで、すべての線形メモリーを所有しているので、 <code>data</code> セクションを使用してグローバルメモリーに文字列の内容を書きこむことができます。データセクションではインスタンス化時にオフセットを指定してバイト列の文字列を書きこむことができます。これはネイティブの実行可能形式の <code>.data</code> セクションに似ています。</p>
<p>最終的な wasm モジュールは次のようになります。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"console"</span> <span class="token string">"log"</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$log</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"mem"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">"Hi"</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"writeHi"</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span>  <span class="token comment">;; pass offset 0 to log</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span>  <span class="token comment">;; pass length 2 to log</span>
    <span class="token keyword">call</span> <span class="token variable">$log</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<div class="notecard note" id="sect5">
  <p><strong>Note:</strong> 上記の 2 重のセミコロン構文 (<code>;;</code>) は WebAssembly ファイル内でコメントを書くためのものです。</p>
</div>
<p>ここで、JavaScript から 1 ページ分のサイズを持つ Memory を作成してそれに渡すことができます。結果としてコンソールに "Hi" と出力されます。</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">var</span> memory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">initial</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> importObject <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">console</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">log</span><span class="token operator">:</span> consoleLogString <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">js</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">mem</span><span class="token operator">:</span> memory <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'logger2.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importObject<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">obj</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">writeHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="notecard note" id="sect6">
  <p><strong>Note:</strong> 完全なソースは GitHub の <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/logger2.html" class="external" rel=" noopener">logger2.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/logger2.html" class="external" rel=" noopener">動作例</a>) を参照してください。</p>
</div></div><h3 id="webassembly_テーブル"><a href="#webassembly_テーブル" title="Permalink to WebAssembly テーブル">WebAssembly テーブル</a></h3><div><p>WebAssembly テキスト形式のツアーを終了するために、 WebAssembly で最も複雑でしばしば混乱する部分 (<strong>テーブル</strong>) を見てみましょう。テーブルは基本的に WebAssembly コードからインデックスでアクセスできるリサイズ可能な参照の配列です。</p>
<p>なぜテーブルが必要なのかを見るために、最初に観察する必要があります。さきほど見た <code>call</code> 命令 (<a href="#%E5%90%8C%E3%81%98%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E4%BB%96%E3%81%AE%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E9%96%A2%E6%95%B0%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99">同じモジュールの他の関数から関数を呼び出す</a> を参照) は静的な関数インデックスをとり、結果として 1 つの関数しか呼び出せません。しかし、呼び出し先がランタイム値の場合はどうなるでしょうか。</p>
<ul>
  <li>JavaScript ではこれは常に見えます。関数は第一級の値です。</li>
  <li>C/C++ では関数ポインターで見ることができます。</li>
  <li>C++ では仮想関数で見ることができます。</li>
</ul>
<p>WebAssembly にはこれを実現するための一種の呼び出し命令が必要だったため、動的な関数をオペランドに受け取る <code>call_indirect</code> を与えました。問題は WebAssembly ではオペランドに指定できる型が (現在) <code>i32</code>/<code>i64</code>/<code>f32</code>/<code>f64</code> だけであることです。</p>
<p>WebAssembly は <code>anyfunc</code> 型 (任意のシグニチャの関数を保持できるため "any") を追加することができましたが、あいにくセキュリティ上の理由から <code>anyfunc</code> 型は線形メモリーに格納できませんでした。線形メモリーは格納された値の生の内容をバイト列として公開し、これによって wasm コンテンツが生の関数ポインターを自由に観察できて破損させることができてしまいます。これはウェブ上では許可できません。</p>
<p>解決方法は関数参照をテーブルに格納し、代わりにテーブルのインデックスを渡すことでした。これは単なる i32 値です。<code>call_indirect</code> のオペランドは単純に i32 のインデックス値にすることができます。</p>
<h4 id="wasm_でテーブルを定義する">wasm でテーブルを定義する</h4>
<p>どのようにしてテーブルに wasm 関数を配置するのでしょうか。 <code>data</code> セクションを使用して線形メモリーの領域をバイト列で初期化するのと同じように、<code>elem</code> セクションを使用してテーブルの領域を関数の列で初期化することが出来ます:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token number">2</span> funcref<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">elem</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token variable">$f1</span> <span class="token variable">$f2</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$f1</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$f2</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">13</span><span class="token punctuation">)</span>
  ...
<span class="token punctuation">)</span>
</code></pre></div>
<ul>
  <li><code>(table 2 funcref)</code> で、2 はテーブルの初期サイズ (2つの参照を格納できることを意味します) で、<code>funcref</code> はこれらの参照の要素型がの関数参照であることを宣言します。</li>
  <li>関数 (<code>func</code>) セクションは他の宣言された wasm 関数と同様です。これらはテーブルで参照する関数です (上の例ではそれぞれは定数を返すだけです) 。セクションが宣言された順序は重要ではないことに注意してください。関数はどこででも宣言できて <code>elem</code> セクションから参照することができます。</li>
  <li><code>elem</code> セクションはモジュール内の関数のサブセットをリスト化することができます (任意の順で並べることができ、重複を許容します) 。これは参照された順序でテーブルに参照される関数のリストです。</li>
  <li><code>elem</code> セクション内の <code>(i32.const 0)</code> 値はオフセットです。これはセクションの先頭で宣言する必要があります。これはテーブルに関数参照を追加するインデックスの開始位置を指定します。ここでは 0 と テーブルのサイズとして 2 (上記参照) を指定していますので、2つの参照はインデックスが 0 と 1 の部分に書き込まれます。もしオフセットを 1 にして書き込みたければ、 <code>(i32.const 1)</code> と記述してテーブルのサイズを 3 にする必要があります。</li>
</ul>
<div class="notecard note" id="sect7">
  <p><strong>Note:</strong> 初期化されていない要素はデフォルトの throw-on-call 値が与えられます。</p>
</div>
<p>JavaScript で同じようなテーブルのインスタンスを作成する場合、次のようになります。</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// table section</span>
  <span class="token keyword">var</span> tbl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Table</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">initial</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">element</span><span class="token operator">:</span><span class="token string">"anyfunc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// function sections:</span>
  <span class="token keyword">var</span> f1 <span class="token operator">=</span> <span class="token operator">...</span> <span class="token comment">/* some imported WebAssembly function */</span>
  <span class="token keyword">var</span> f2 <span class="token operator">=</span> <span class="token operator">...</span> <span class="token comment">/* some imported WebAssembly function */</span>

  <span class="token comment">// elem section</span>
  tbl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tbl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<h4 id="テーブルを使用する">テーブルを使用する</h4>
<p>先に進みましょう。いま、何らかの形で使用するために必要なテーブルを定義しました。このコードのセクションで使ってみましょう。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; if this was f32, type checking would fail</span>
<span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"callByIndex"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$i</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
  <span class="token keyword">local</span>.get <span class="token variable">$i</span>
  <span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<ul>
  <li><code>(type $return_i32 (func (result i32)))</code> ブロックで参照名を持つ型を指定します。この型は後でテーブルの関数参照呼び出しの型チェックを行うときに使用されます。ここでは、参照が1つの <code>i32</code> を返す関数である必要があると言っています。</li>
  <li>次に、<code>callByIndex</code> としてエクスポートされる関数を定義します。引数として1つの <code>i32</code> をとり、引数名として <code>$i</code> が指定されています。</li>
  <li>関数内部でスタックに値を1つ追加します。値は引数 <code>$i</code> のものが渡されます。</li>
  <li>最後に、テーブルから関数を呼び出すために <code>call_indirect</code> を使用します。これは暗黙的に <code>$i</code> の値をスタックからポップします。この結果、<code>callByIndex</code> 関数はテーブルの <code>$i</code> 番目の関数を呼び出します。</li>
</ul>
<p><code>call_indirect</code> の引数はコマンド呼び出しの前に置く代わりに、次のように明示的に宣言することもできます:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">local</span>.get <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<p>より高級な、JavaScript のような表現力の高い言語では、関数を含む配列 (あるいはオブジェクトかもしれません) で同じことができることが想像できますよね。擬似コードだとこれは <code>tbl[i]()</code> のようになります。</p>
<p>型チェックの話に戻ります。WebAssembly は型チェックされていて、 <code>funcref</code> は「任意の関数シグネチャ」を意味するので、呼び出し先の (推定される) シグネチャを指定する必要があります。そのため、 <code>$return_i32</code> 型を指定することで、プログラムに関数が <code>i32</code> を返すはずだと知らせます。もし呼び出し先のシグネチャが一致しない (代わりに <code>f32</code> が返されるような) 場合は <a href="/ja/docs/WebAssembly/JavaScript_interface/RuntimeError"><code>WebAssembly.RuntimeError</code></a> 例外が発生します。</p>
<p>さて、呼び出しを行うときにどのようにテーブルに <code>call_indirect</code> をリンクさせているのでしょうか? 答えは、現在モジュールインスタンスごとに1つのテーブルしか許容されないため、<code>call_indirect</code> はそれを暗黙的に呼び出します。将来的に複数のテーブルを持てるようになったとき、以下の行のように、何らかのテーブル識別子を指定する必要があるでしょう。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token keyword">call_indirect</span> <span class="token variable">$my_spicy_table</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$i32_to_void</span><span class="token punctuation">)</span>
</code></pre></div>
<p>完全なモジュールは次のようになります。例は <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/wasm-table.wat" class="external" rel=" noopener">wasm-table.wat</a> を参照してください:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token number">2</span> funcref<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$f1</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$f2</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">13</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">elem</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token variable">$f1</span> <span class="token variable">$f2</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"callByIndex"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">param</span> <span class="token variable">$i</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span>.get <span class="token variable">$i</span>
    <span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$return_i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>次の JavaScript を使用してウェブページに読み込んでみましょう。</p>
<div class="code-example"><pre class="brush: js notranslate"><code>WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'wasm-table.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">obj</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">callByIndex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 42</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">callByIndex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns 13</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">callByIndex</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns an error, because there is no index position 2 in the table</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<div class="notecard note" id="sect8">
  <p><strong>Note:</strong> 例は GitHub の <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/wasm-table.html" class="external" rel=" noopener">wasm-table.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/wasm-table.html" class="external" rel=" noopener">動作例</a>) を参照してください。</p>
</div>
<div class="notecard note" id="sect9">
  <p><strong>Note:</strong> Memory と同じように Table も JavaScript から作成すること (<a href="/ja/docs/WebAssembly/JavaScript_interface/Table"><code>WebAssembly.Table()</code></a> を参照) 、別の wasm モジュール間でインポートすることができます。</p>
</div></div><h3 id="テーブルの変更と動的リンク"><a href="#テーブルの変更と動的リンク" title="Permalink to テーブルの変更と動的リンク">テーブルの変更と動的リンク</a></h3><div><p>JavaScript は関数参照にフルアクセスできるため、 Table オブジェクトは JavaScript から <a href="/ja/docs/WebAssembly/JavaScript_interface/Table/grow"><code>grow()</code></a>, <a href="/ja/docs/WebAssembly/JavaScript_interface/Table/get"><code>get()</code></a>, <a href="/ja/docs/WebAssembly/JavaScript_interface/Table/set"><code>set()</code></a> メソッドを使用して変更することができます。また、 WebAssembly のコード自体も、<a href="#%E5%8F%82%E7%85%A7%E5%9E%8B">参照型</a>の一部として追加された <code>table.get</code> や <code>table.set</code> などの命令を使ってテーブルを操作することが可能です。</p>
<p>テーブルは変更可能であるため、高度な読み込み時および実行時の<a href="https://webassembly.org/docs/dynamic-linking" class="external" rel=" noopener">動的リンクスキーム</a>の実装に使用することができます。プログラムが動的にリンクされたとき、複数のインスタンスで同じメモリーとテーブルを共有することができます。これは複数のコンパイル済み <code>.dll</code> が単一のプロセスのアドレス空間を共有するネイティブアプリケーションと対称的です。</p>
<p>この動作を確認するために、Memory オブジェクトと Table オブジェクトを含む単一のインポートオブジェクトを作成し、同じインポートオブジェクトを複数の <a href="/ja/docs/WebAssembly/JavaScript_interface/instantiate"><code>instantiate()</code></a> の呼び出しで渡してみましょう。</p>
<p><code>.wat</code> ファイルの例は次のようになります。</p>
<p><code>shared0.wat</code>:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"memory"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"table"</span> <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token number">1</span> funcref<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">elem</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token variable">$shared0func</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$shared0func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>load</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p><code>shared1.wat</code>:</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"memory"</span> <span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">import</span> <span class="token string">"js"</span> <span class="token string">"table"</span> <span class="token punctuation">(</span><span class="token keyword">table</span> <span class="token number">1</span> funcref<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$void_to_i32</span> <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"doIt"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>store</span>  <span class="token comment">;; store 42 at address 0</span>
   <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span>
   <span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$void_to_i32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>これらは次のように動作します。</p>
<ol>
  <li>関数 <code>shared0func</code> は <code>shared0.wat</code> で定義され、インポートされたテーブルに格納されます。</li>
  <li>この関数は定数値 <code>0</code> を作成して、次に <code>i32.load</code> コマンドを使用して指定したメモリーのインデックスから値をロードします。そのインデックスは <code>0</code> になります 。先と同様に、前の値をスタックから暗黙的にポップします。つまり、<code>shared0func</code> はメモリーのインデックス <code>0</code> の位置に格納された値をロードして返します。</li>
  <li><code>shared1.wat</code> では、 <code>doIt</code> という関数をエクスポートします。この関数は2つの定数値 <code>0</code> と <code>42</code> を作成して <code>i32.store</code> を呼び出して、インポートされたメモリーの指定したインデックスに指定した値を格納します。ここでも、これらの値はスタックから暗黙的にポップされます。したがって、結果的にメモリーのインデックスが <code>0</code> の位置に、値として <code>42</code> が格納されます。</li>
  <li>関数の最後では、定数値 <code>0</code> を作成し、テーブルのインデックスが 0 の位置にある関数を呼び出します。これは <code>shared0func</code> で、先に <code>shared0.wat</code> の <code>elem</code> ブロックで格納されたものです。</li>
  <li>呼び出されたとき、<code>shared0func</code> は <code>shared1.wat</code> 内で <code>i32.store</code> コマンドを使用してメモリーに格納された 42 をロードします。</li>
</ol>
<div class="notecard note" id="sect10">
  <p><strong>Note:</strong> 上の式はスタックから値を暗黙的にポップしますが、代わりにコマンド呼び出しの中で明示的に宣言することができます。</p>
  <div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>store</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">call_indirect</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token variable">$void_to_i32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
</div>
<p>アセンブリーに変換した後、次のコードで JavaScript 内で <code>shared0.wasm</code> と <code>shared1.wasm</code> を使用します:</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">var</span> importObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">js</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">memory</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">table</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Table</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token string">"anyfunc"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'shared0.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importObj<span class="token punctuation">)</span><span class="token punctuation">,</span>
  WebAssembly<span class="token punctuation">.</span><span class="token function">instantiateStreaming</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'shared1.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> importObj<span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">doIt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// prints 42</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>コンパイルされた各モジュールは同じメモリーとテーブルオブジェクトをインポートし、その結果同じ線形メモリーとテーブルの「アドレス空間」を共有することができます。</p>
<div class="notecard note" id="sect11">
  <p><strong>Note:</strong> 例は GitHub の <a href="https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/shared-address-space.html" class="external" rel=" noopener">shared-address-space.html</a> (<a href="https://mdn.github.io/webassembly-examples/understanding-text-format/shared-address-space.html" class="external" rel=" noopener">動作例</a>) を参照してください。</p>
</div></div><h2 id="大規模メモリー操作"><a href="#大規模メモリー操作" title="Permalink to 大規模メモリー操作">大規模メモリー操作</a></h2><div><p>大規模メモリー操作は、言語へ新しく追加されたものです（例えば <a href="/ja/docs/Mozilla/Firefox/Releases/79">Firefox 79</a>）。コピーや初期化などのバルクメモリ操作のために 7 つの新しい組み込み操作が提供されており、 WebAssembly が <code>memcpy</code> や <code>memmove</code> などのネイティブ関数を、より効率的でパフォーマンスの高い方法でモデル化できるようにします。</p>
<p>新しい操作は次の通りです。</p>
<ul>
  <li><code>data.drop</code>: データセグメント内のデータを無効にします。</li>
  <li><code>elem.drop</code>: 要素セグメント内のデータを無効にします。</li>
  <li><code>memory.copy</code>: 線形メモリーの一範囲を他へコピーします。</li>
  <li><code>memory.fill</code>: 線形メモリーの一範囲を指定した値で埋めます。</li>
  <li><code>memory.init</code>: データセグメントから範囲をコピーします。</li>
  <li><code>table.copy</code>: テーブルの一範囲から他へコピーします。</li>
  <li><code>table.init</code>: 要素セグメントから範囲をコピーします。</li>
</ul>
<div class="notecard note" id="sect12">
  <p><strong>Note:</strong> 詳しい情報は <a href="https://github.com/WebAssembly/bulk-memory-operations/blob/master/proposals/bulk-memory-operations/Overview.md" class="external" rel=" noopener">Bulk Memory Operations and Conditional Segment Initialization</a> の提案にあります。</p>
</div></div><h2 id="参照型"><a href="#参照型" title="Permalink to 参照型">参照型</a></h2><div><p><a href="https://github.com/WebAssembly/reference-types/blob/master/proposals/reference-types/Overview.md" class="external" rel=" noopener">参照型の提案</a> (<a href="/ja/docs/Mozilla/Firefox/Releases/79">Firefox 79</a> で対応) では、主に 2 つのことを提供しています。</p>
<ul>
  <li>新しい型である <code>externref</code> は、文字列、DOM 参照、オブジェクトなど、あらゆる JavaScript の値を保持することができます。 WebAssembly の観点からは <code>externref</code> は不透明です。wasm モジュールはこれらの値にアクセスして操作することができず、代わりに値を受け取って送り返すことだけができます。しかし、これは wasm モジュールが JavaScript の関数や DOM API などを呼び出したり、ホスト環境との相互運用を容易にするために非常に有用です。<code>externref</code> は値型とテーブル要素に使用することができます。</li>
  <li>JavaScript API 経由ではなく、wasm モジュールが直接 <a href="#webassembly_%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB">WebAssembly テーブル</a>を操作できるようにするための新しい命令がいくつか追加されました。</li>
</ul>
<div class="notecard note" id="sect13">
  <p><strong>Note:</strong> <a href="https://rustwasm.github.io/docs/wasm-bindgen/" class="external" rel=" noopener">wasm-bindgen</a> のドキュメントには、 <code>externref</code> を Rust で利用する方法について、いくつかの有用な情報が含まれています。</p>
</div></div><h2 id="webassembly_の複数値"><a href="#webassembly_の複数値" title="Permalink to WebAssembly の複数値">WebAssembly の複数値</a></h2><div><p>もっと最近になって (例えば <a href="/ja/docs/Mozilla/Firefox/Releases/78">Firefox 78</a>) 言語に追加されたものが WebAssembly 複数値です。これは、WebAssembly 関数が複数の値を返すことができるようになり、一連の命令が複数のスタック値を消費して生成することができるようになったことを意味します。</p>
<p>執筆時点 (2020 年 6 月) において、これは初期段階であり、利用可能な多値命令は、それ自体が複数の値を返す関数の呼び出しのみです。例を示します。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">module</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token variable">$get_two_numbers</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">1</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>const</span> <span class="token number">2</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token keyword">export</span> <span class="token string">"add_two_numbers"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">result</span> <span class="token keyword">i32</span><span class="token punctuation">)</span>
    <span class="token keyword">call</span> <span class="token variable">$get_two_numbers</span>
    <span class="token keyword">i32<span class="token punctuation">.</span>add</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div>
<p>しかし、これはより有用な命令タイプやその他のものへの道を開くことになるでしょう。これまでの進捗状況や、これがどのように動作するかについては、 Nick Fitzgerald の <a href="https://hacks.mozilla.org/2019/11/multi-value-all-the-wasm/" class="external" rel=" noopener">Multi-Value All The Wasm!</a> を参照してください。</p></div><h2 id="webassembly_スレッド"><a href="#webassembly_スレッド" title="Permalink to WebAssembly スレッド">WebAssembly スレッド</a></h2><div><p>WebAssembly スレッド (<a href="/ja/docs/Mozilla/Firefox/Releases/79">Firefox 79</a> 以降で対応) は、 WebAssembly Memory オブジェクトを別なウェブワーカー内で動作している複数の WebAssembly インスタンスで共有できるものであり、 JavaScript の <a href="/ja/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"><code>SharedArrayBuffer</code></a> と似たような形のものです。これにより、ワーカー間の非常に高速な通信が可能になり、ウェブアプリケーションのパフォーマンスが大幅に向上します。</p>
<p>スレッドの提案は、共有メモリーと不可分メモリーアクセスの 2 つの部分からなります。</p></div><h3 id="共有メモリー"><a href="#共有メモリー" title="Permalink to 共有メモリー">共有メモリー</a></h3><div><p>上記のように、共有の WebAssembly <a href="/ja/docs/WebAssembly/JavaScript_interface/Memory"><code>Memory</code></a> オブジェクトを作成することが可能です。これは、 <a href="/ja/docs/Web/API/Window/postMessage"><code>postMessage()</code></a> を使用してウィンドウとワーカーのコンテキスト間で、 <a href="/ja/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"><code>SharedArrayBuffer</code></a> と同じ方法で転送されるものです。</p>
<p>JavaScript API 側では、<a href="/ja/docs/WebAssembly/JavaScript_interface/Memory"><code>WebAssembly.Memory()</code></a> コンストラクタの初期化オブジェクトに <code>shared</code> プロパティを追加し、 <code>true</code> に設定すると共有メモリを作成するようになりました。</p>
<div class="code-example"><pre class="brush: js notranslate"><code><span class="token keyword">let</span> memory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAssembly<span class="token punctuation">.</span>Memory</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">initial</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">maximum</span><span class="token operator">:</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token literal-property property">shared</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>メモリーの <a href="/ja/docs/WebAssembly/JavaScript_interface/Memory/buffer"><code>buffer</code></a> プロパティは <code>SharedArrayBuffer</code> を返すようになり、普通の <code>ArrayBuffer</code> ではなくなりました。</p>
<div class="code-example"><pre class="brush: js notranslate"><code>memory<span class="token punctuation">.</span>buffer <span class="token comment">// returns SharedArrayBuffer</span>
</code></pre></div>
<p>テキスト形式の上では、 <code>shared</code> キーワードを使って、次のように共有メモリーを作成することができます。</p>
<div class="code-example"><pre class="brush: wasm notranslate"><code><span class="token punctuation">(</span><span class="token keyword">memory</span> <span class="token number">1</span> <span class="token number">2</span> shared<span class="token punctuation">)</span>
</code></pre></div>
<p>共有されていないメモリーと異なり、共有メモリーは JavaScript API のコンストラクターと wasm のテキスト形式の両方で「最大」サイズを指定する必要があります。</p>
<div class="notecard note" id="sect14">
  <p><strong>Note:</strong> 詳しくは、 <a href="https://github.com/WebAssembly/threads/blob/master/proposals/threads/Overview.md" class="external" rel=" noopener">WebAssembly のスレッド提案</a>にたくさん載っています。</p>
</div></div><h3 id="不可分メモリーアクセス"><a href="#不可分メモリーアクセス" title="Permalink to 不可分メモリーアクセス">不可分メモリーアクセス</a></h3><div><p>ミューテックスや条件変数など、より高度な機能を実装するために使用できる新しい wasm 命令が多数追加されました。<a href="https://github.com/WebAssembly/threads/blob/master/proposals/threads/Overview.md#atomic-memory-accesses" class="external" rel=" noopener">ここにリストアップされています</a>。これらの命令は、 Firefox 80 の時点で共有でないメモリー上で許可されています。</p>
<div class="notecard note" id="sect15">
  <p><strong>Note:</strong> <a href="https://emscripten.org/docs/porting/pthreads.html" class="external" rel=" noopener">Emscripten Pthreads support page</a> で、 Emscripten の新機能を利用する方法を紹介しています。</p>
</div></div><h2 id="まとめ"><a href="#まとめ" title="Permalink to まとめ">まとめ</a></h2><div><p>これで、WebAssembly テキスト形式の主要コンポーネントとそれらが WebAssembly JS API にどのように反映されるのかの高レベルなツアーが完了しました。</p></div><h2 id="関連情報"><a href="#関連情報" title="Permalink to 関連情報">関連情報</a></h2><div><ul>
  <li>この記事に含まれなかった主なものは、関数本体で現れるすべての命令の包括的なリストです。各命令の処理は <a href="http://webassembly.org/docs/semantics" class="external" rel=" noopener">WebAssembly のセマンティックス</a> を参照してください。</li>
  <li>スペックインタプリターによって実装された<a href="https://github.com/WebAssembly/spec/blob/master/interpreter/README.md#s-expression-syntax" class="external" rel=" noopener">テキスト形式の文法</a>も参照してください。</li>
</ul></div></article><aside class="metadata"><div class="metadata-content-container"><div id="on-github" class="on-github"><h3>Found a problem with this page?</h3><ul><li><a href="https://github.com/mdn/translated-content/edit/main/files/ja/webassembly/understanding_the_text_format/index.md" title="You're going to need to sign in to GitHub first (Opens in a new tab)" target="_blank" rel="noopener noreferrer">Edit on <b>GitHub</b></a></li><li><a href="https://github.com/mdn/translated-content/blob/main/files/ja/webassembly/understanding_the_text_format/index.md" title="Folder: ja/webassembly/understanding_the_text_format (Opens in a new tab)" target="_blank" rel="noopener noreferrer">Source on <b>GitHub</b></a></li><li><a href="https://github.com/mdn/translated-content/issues/new?body=MDN+URL%3A+https%3A%2F%2Fdeveloper.mozilla.org%2Fja%2Fdocs%2FWebAssembly%2FUnderstanding_the_text_format%0A%0A%23%23%23%23+What+information+was+incorrect%2C+unhelpful%2C+or+incomplete%3F%0A%0A%0A%23%23%23%23+Specific+section+or+headline%3F%0A%0A%0A%23%23%23%23+What+did+you+expect+to+see%3F%0A%0A%0A%23%23%23%23+Did+you+test+this%3F+If+so%2C+how%3F%0A%0A%0A%3C%21--+Do+not+make+changes+below+this+line+--%3E%0A%3Cdetails%3E%0A%3Csummary%3EMDN+Content+page+report+details%3C%2Fsummary%3E%0A%0A*+Folder%3A+%60ja%2Fwebassembly%2Funderstanding_the_text_format%60%0A*+MDN+URL%3A+https%3A%2F%2Fdeveloper.mozilla.org%2Fja%2Fdocs%2FWebAssembly%2FUnderstanding_the_text_format%0A*+GitHub+URL%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Ftranslated-content%2Fblob%2Fmain%2Ffiles%2Fja%2Fwebassembly%2Funderstanding_the_text_format%2Findex.md%0A*+Last+commit%3A+https%3A%2F%2Fgithub.com%2Fmdn%2Ftranslated-content%2Fcommit%2F921c46a374ab0a9f4cc809af0370f8c412e54701%0A*+Document+last+modified%3A+2022-10-01T03%3A41%3A16.000Z%0A%0A%3C%2Fdetails%3E&amp;title=Issue+with+%22WebAssembly+%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E5%BD%A2%E5%BC%8F%E3%81%AE%E7%90%86%E8%A7%A3%22%3A+%28short+summary+here+please%29&amp;labels=needs-triage%2Cl10n-ja" title="This will take you to https://github.com/mdn/content to file a new issue" target="_blank" rel="noopener noreferrer">Report a problem with this content on <b>GitHub</b></a></li><li>Want to fix the problem yourself? See<!-- --> <a href="https://github.com/mdn/content/blob/main/README.md" target="_blank" rel="noopener noreferrer">our Contribution guide</a>.</li></ul></div><p class="last-modified-date"><b>Last modified:</b> <time datetime="2022-10-01T03:41:16.000Z">Oct 1, 2022</time>,<!-- --> <a href="/ja/docs/WebAssembly/Understanding_the_text_format/contributors.txt">by MDN contributors</a></p><form class="language-menu"><fieldset id="select-language"><legend>Change your language</legend><label for="language-selector" class="visually-hidden">Select your preferred language</label> <select id="language-selector" name="language"><option selected="" value="ja">日本語</option><option value="en-US">English (US)</option><option value="ko">한국어</option><option value="pt-BR">Português (do&nbsp;Brasil)</option><option value="ru">Русский</option><option value="zh-CN">中文 (简体)</option></select> <button type="submit" class="button minimal">Change language</button></fieldset></form></div></aside></main><nav id="sidebar-quicklinks" class="sidebar"><h4>Related Topics</h4><div>

<ol>
  <li data-default-state="open"><a href="/ja/docs/WebAssembly"><strong>WebAssembly home page</strong></a>
  </li><li class="toggle">
    <details open="">
      <summary>Tutorials</summary>
      <ol>
        <li><a href="/ja/docs/WebAssembly/Concepts">WebAssembly concepts</a></li>
        <li><a href="/ja/docs/WebAssembly/C_to_wasm">Compiling from C/C++ to WebAssembly</a></li>
        <li><a href="/ja/docs/WebAssembly/Rust_to_wasm">Compiling from Rust to WebAssembly</a></li>
        <li><a href="/ja/docs/WebAssembly/Using_the_JavaScript_API">Using the WebAssembly JavaScript API</a></li>
        <li><a href="/ja/docs/WebAssembly/Understanding_the_text_format">Understanding WebAssembly text format</a></li>
        <li><a href="/ja/docs/WebAssembly/Text_format_to_wasm">Converting WebAssembly text format to wasm</a></li>
        <li><a href="/ja/docs/WebAssembly/Loading_and_running">Loading and running WebAssembly code</a></li>
        <li><a href="/ja/docs/WebAssembly/Caching_modules">Caching compiled WebAssembly modules</a></li>
        <li><a href="/ja/docs/WebAssembly/Exported_functions">Exported WebAssembly functions</a></li>
      </ol>
    </details>
  </li>
  <li class="toggle">
    <details open="">
      <summary>Object reference</summary>
      <ol>
        <li><a href="/ja/docs/WebAssembly/JavaScript_interface"><code>WebAssembly</code></a></li>
        <li><a href="/ja/docs/WebAssembly/JavaScript_interface/Module"><code>WebAssembly.Module</code></a></li>
        <li><a href="/ja/docs/WebAssembly/JavaScript_interface/Global"><code>WebAssembly.Global</code></a></li>
        <li><a href="/ja/docs/WebAssembly/JavaScript_interface/Instance"><code>WebAssembly.Instance</code></a></li>
        <li><a href="/ja/docs/WebAssembly/JavaScript_interface/Memory"><code>WebAssembly.Memory</code></a></li>
        <li><a href="/ja/docs/WebAssembly/JavaScript_interface/Table"><code>WebAssembly.Table</code></a></li>
        <li><a href="/ja/docs/WebAssembly/JavaScript_interface/CompileError"><code>WebAssembly.CompileError</code></a></li>
        <li><a href="/ja/docs/WebAssembly/JavaScript_interface/LinkError"><code>WebAssembly.LinkError</code></a></li>
        <li><a href="/ja/docs/WebAssembly/JavaScript_interface/RuntimeError"><code>WebAssembly.RuntimeError</code></a></li>
      </ol>
    </details>
  </li>
</ol>

</div></nav></div><footer id="nav-footer" class="page-footer"><div class="content-container"><div class="page-footer-logo"><a href="/ja/" class="logo" aria-label="MDN Web Docs"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 451.74 135" fill="#fff"><path d="M7.14 8.35v111.06h111.05V8.35zm103.71 56c-.48.92-1 1.79-1.46 2.71a3.44 3.44 0 01-3.54 2 2.4 2.4 0 00-1.55.5c-1.37.9-2.76 1.79-4.18 2.63a7.33 7.33 0 01-6.35.34 29.71 29.71 0 00-10.63-2 11.7 11.7 0 00-9.46 4.31 14.84 14.84 0 00-2.13 4.29c-1.24 3.07-2.3 21.38-2.3 26.05 0 0-17.62-3.42-34.15-20.34l4.31-11.32h-13.5l9.76-10.35h-16.8l9.77-10.34H12.69L30.45 34a40.9 40.9 0 0119.77-10.83c7.1-1.22 8.93-.53 13.31.77l2.43.73.85.25 3.1.95a12.56 12.56 0 006.21.09 11.37 11.37 0 018.25 1 8.24 8.24 0 014.1 6.22 7.29 7.29 0 003.61 5.49 59.45 59.45 0 009.32 4.11c2.27.86 4.54 1.84 6.79 2.72a6.81 6.81 0 012.86 2.06 4.81 4.81 0 011.1 2.73c.14 2 .37 4 .47 6a15.24 15.24 0 01-1.77 8.03zM320.12 39.62a5.42 5.42 0 00-4.53 2.13 7.36 7.36 0 00-1.7 4.43v2.36a6.28 6.28 0 001.7 4.46 5.63 5.63 0 004.3 1.82 5.12 5.12 0 004.57-2.27A9.7 9.7 0 00326 47a8.11 8.11 0 00-1.67-5.52 5.36 5.36 0 00-4.21-1.86zM387.38 39.53a5.52 5.52 0 00-4.7 2.15 8.8 8.8 0 00-1.63 5.49 9.23 9.23 0 001.58 5.45 5.38 5.38 0 004.7 2.25 5.61 5.61 0 004.74-2.2 8.91 8.91 0 001.68-5.59 8.24 8.24 0 00-1.75-5.52 5.76 5.76 0 00-4.62-2.03zM299.47 41.35a4.34 4.34 0 00-4-1.92 4.55 4.55 0 00-3.89 1.73 8.37 8.37 0 00-1.58 4.17h10.48a6.3 6.3 0 00-1.01-3.98zM357.74 30.75H352v23.31h5.72q5.47 0 8.35-3t2.93-8.65q0-5.43-2.88-8.55t-8.38-3.11z"></path><path d="M121.55 8.35v70.8h323V8.35zm42.21 22.45h-4V54h3.68v3.73h-11.25V54h3.31V36.79h-.19l-9.63 19.12h-2.12l-10-19.4h-.19V54h3.45v3.73h-11.15V54h3.68V30.8h-4v-3.73H133l11.66 22.56h.19l11.18-22.56h7.7zm29.12 22.67q-4.11 4.28-11.38 4.28h-14.06v-3.69h3.73V30.75h-3.73v-3.68h13.83q7.59 0 11.66 4.29a15.4 15.4 0 014 11 15.33 15.33 0 01-4.05 11.11zm38.89-22.67h-3.68v27h-2.6L208.08 35h-.19v19h4.67v3.73h-12.22V54h3.49V30.8h-4v-3.73h7.08l16.9 22.09h.19V30.8h-4.58v-3.73h12.32zm43.8 27h-3.31l-7.83-23.18h-.19l-7.55 23.18h-3.35l-8.78-27h-2.65v-3.73H253v3.73h-3.87L255 50.71h.23l6.61-19.91H259v-3.73h11v3.73h-2.78l6.61 20.1h.23l5.43-20.1h-4.15v-3.73h11v3.73h-2.54zm26.71-1.51a9.66 9.66 0 01-6.42 2 10.2 10.2 0 01-7.41-2.74c-1.89-1.82-2.83-4.47-2.83-7.93a12.37 12.37 0 012.64-8.12 9 9 0 017.32-3.21 8.62 8.62 0 016.75 2.69 9.65 9.65 0 012.45 6.52 13.67 13.67 0 01-.28 2.69H290q.29 6.71 6.18 6.7a5.2 5.2 0 003.71-1.18 5.82 5.82 0 001.67-2.83l3.45.71a7.21 7.21 0 01-2.73 4.65zm25.77-1.63c-1.51 2.4-3.92 3.61-7.22 3.61s-5.84-1.29-7.22-3.87c0 .25-.1.82-.21 1.7s-.19 1.44-.22 1.7H309c.16-1 .31-2 .47-3.07a21.42 21.42 0 00.24-3.16v-23h-3.4v-3.3h7.55V40.9a9.76 9.76 0 012.67-3.28 7.33 7.33 0 014.74-1.4 8.48 8.48 0 016.5 2.78q2.55 2.74 2.55 7.74a14.6 14.6 0 01-2.27 7.87zm41.39-1.14q-4.11 4.28-11.37 4.28H344v-3.74h3.73V30.75H344v-3.68h13.83q7.59 0 11.66 4.29a15.41 15.41 0 014.06 11 15.34 15.34 0 01-4.11 11.11zm25.65 1.68a10.53 10.53 0 01-7.9 3.07 10 10 0 01-7.63-3 10.93 10.93 0 01-2.8-7.83 12.13 12.13 0 012.69-7.93q2.69-3.3 8-3.3t8 3.28a12 12 0 012.64 7.76 10.86 10.86 0 01-3 7.9zm22.61.57c-1.4 1.66-3.63 2.5-6.68 2.5a9.58 9.58 0 01-7.15-2.76q-2.72-2.76-2.71-7.91a12.25 12.25 0 012.69-8 9.17 9.17 0 017.5-3.28 15 15 0 013.82.48 10.37 10.37 0 013.5 1.65l.85 5.47-3.35.38-.76-3.54a8.07 8.07 0 00-4.11-1 4.9 4.9 0 00-4.39 2.15 9.93 9.93 0 00-1.41 5.55 8.9 8.9 0 001.5 5.38 5.23 5.23 0 004.44 2c2.92 0 4.67-1.7 5.23-5.1l3.5.71a10.34 10.34 0 01-2.47 5.27zm20.48.75a11.68 11.68 0 01-6.63 1.75 15.52 15.52 0 01-8.26-2.08L424 51l3.26.33-.1 2.74a7 7 0 002.06.66 12.63 12.63 0 002.19.19 8.68 8.68 0 003.66-.75 2.5 2.5 0 001.63-2.36 2.25 2.25 0 00-1.32-2.2 12.65 12.65 0 00-3.28-1 47.39 47.39 0 01-3.9-.82 7.5 7.5 0 01-3.25-1.7 4.67 4.67 0 01-1.33-3.66c0-2.36.88-4 2.62-4.91a12 12 0 015.6-1.37 15 15 0 014.08.55 16.65 16.65 0 013.47 1.39l.47 5.1-3.3.37-.48-3.3a9.5 9.5 0 00-4.06-.9 5.62 5.62 0 00-2.87.66 2.33 2.33 0 00-1.15 2.25 2.13 2.13 0 001.3 2.07 11.91 11.91 0 003.21.92 36.69 36.69 0 013.82.83 7.46 7.46 0 013.21 1.74 4.9 4.9 0 011.3 3.73 5.56 5.56 0 01-2.66 4.91z"></path><path d="M181.17 30.75h-5.71v23.31h5.71q5.47 0 8.36-3t2.88-8.61q0-5.43-2.88-8.55t-8.36-3.15zM121.63 119.32V81.74h114.91v37.58zM153.22 109h-2v-6.85a4.8 4.8 0 00-1.58-4 5.57 5.57 0 00-3.55-1.26 5 5 0 00-4.92 3.26 4.19 4.19 0 00-1.88-2.46 5.82 5.82 0 00-3-.8 4.89 4.89 0 00-4.56 2.56v-2.21h-6.28v3.26h2v8.5h-2v3.23h9.11V109h-2.86v-5.25a4.4 4.4 0 01.69-2.56 2.47 2.47 0 012.21-1q2.57 0 2.56 3.63v8.41h6.29V109h-2v-5.25a4.47 4.47 0 01.67-2.56 2.42 2.42 0 012.19-1q2.63 0 2.63 3.63v8.41h6.28zm9.88-12.07q-4 0-6 2.36a8.41 8.41 0 00-2 5.66 7.25 7.25 0 002.17 5.62 8 8 0 005.65 2 8.54 8.54 0 005.94-2.11 7.27 7.27 0 002.34-5.67 8.21 8.21 0 00-2-5.51q-2.07-2.34-6.1-2.34zm-.1 12.35a3 3 0 01-2.63-1.33 5.68 5.68 0 01-.9-3.26 5 5 0 011-3.28 3.23 3.23 0 012.61-1.18 3.5 3.5 0 012.59 1.08 4.56 4.56 0 011.07 3.31 5.21 5.21 0 01-1 3.41 3.33 3.33 0 01-2.74 1.25zm25-2.3l-3.39-.29-.7 2.32H179l8.32-9.54-.32-2.23h-13.19l-.53 5.25 3.16.34.67-2.36h4.65l-8.25 9.53.44 2.26h13.13zm7.62-9.74h-4.46v5.39h4.46zm0 9.61h-4.46v5.39h4.46zm13.54-17.49h-4.23l-6.48 22.88h4.22zm8.68 0h-4.23l-6.45 22.88h4.19zm15 22.51l-.07-2.26a1.22 1.22 0 01-.56.1c-.69 0-1-.39-1-1.16v-6.49a4.39 4.39 0 00-1.8-3.84 7 7 0 00-4.16-1.28 14.55 14.55 0 00-3.16.3 24.14 24.14 0 00-3.29 1.06l-.56 3.46 3.39.4.5-1.69a2.78 2.78 0 011.08-.37 11.3 11.3 0 011.25-.07c1.19 0 1.89.37 2.09 1.1a8.55 8.55 0 01.3 2.26v.5a8.91 8.91 0 00-1.18-.11h-1.21a12.64 12.64 0 00-4.81.88 3.53 3.53 0 00-2.18 3.64 3.66 3.66 0 001.48 3.33 5.63 5.63 0 003.11 1 4.67 4.67 0 003-.91 6.78 6.78 0 001.8-2 3 3 0 003.33 3 5.54 5.54 0 002.66-.85zm-9.25-2.32a1.69 1.69 0 01-1.36-.52 1.81 1.81 0 01-.43-1.21 1.67 1.67 0 01.86-1.68 4.63 4.63 0 012-.42 7.69 7.69 0 011.07.07l1.06.13a3.58 3.58 0 01-1.08 2.74 3.24 3.24 0 01-2.11.89z"></path></svg></a></div><ul class="link-list-mdn"><li><a href="/ja/docs/Web">Web Technologies</a></li><li><a href="/ja/docs/Learn">Learn Web Development</a></li><li><a href="/ja/docs/MDN/About">About MDN</a></li><li><a href="/ja/docs/MDN/Feedback">Feedback</a></li></ul><ul class="link-list-moz"><li><a href="https://www.mozilla.org/about/" target="_blank" rel="noopener noreferrer">About</a></li><li><a href="https://shop.spreadshirt.com/mdn-store/" target="_blank" rel="noopener noreferrer">MDN Web Docs Store</a></li><li><a href="https://www.mozilla.org/contact/" target="_blank" rel="noopener noreferrer">Contact Us</a></li><li><a href="https://www.mozilla.org/firefox/?utm_source=developer.mozilla.org&amp;utm_campaign=footer&amp;utm_medium=referral" target="_blank" rel="noopener noreferrer">Firefox</a></li></ul><div class="social social-mdn"><h4>MDN</h4><ul><li><a class="social-icon twitter" href="https://twitter.com/mozdevnet" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">MDN on Twitter</span></a></li><li><a class="social-icon github" href="https://github.com/mdn/" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">MDN on Github</span></a></li></ul></div><div class="social social-moz"><h4>Mozilla</h4><ul><li><a class="social-icon twitter" href="https://twitter.com/mozilla" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">Mozilla on Twitter</span></a></li><li><a class="social-icon instagram" href="https://www.instagram.com/mozillagram/" target="_blank" rel="noopener noreferrer"><span class="visually-hidden">Mozilla on Instagram</span></a></li></ul></div><p id="license" class="footer-license">© 2005-<!-- -->2022<!-- --> Mozilla and individual contributors. Content is available under<!-- --> <a href="/docs/MDN/About#Copyrights_and_licenses">these licenses</a>.</p><ul class="footer-legal"><li><a href="https://www.mozilla.org/about/legal/terms/mozilla" target="_blank" rel="noopener noreferrer">Terms</a></li><li><a href="https://www.mozilla.org/privacy/websites/" target="_blank" rel="noopener noreferrer">Privacy</a></li><li><a href="https://www.mozilla.org/privacy/websites/#cookies" target="_blank" rel="noopener noreferrer">Cookies</a></li></ul></div></footer><div class="page-overlay hidden"></div></div><script type="application/json" id="hydration">{"doc":{"isMarkdown":true,"isTranslated":true,"isActive":true,"flaws":{},"title":"WebAssembly テキスト形式の理解","mdn_url":"/ja/docs/WebAssembly/Understanding_the_text_format","locale":"ja","native":"日本語","sidebarHTML":"\n\n<ol>\n  <li data-default-state=\"open\"><a href=\"/ja/docs/WebAssembly\"><strong>WebAssembly home page</strong></a>\n  </li><li class=\"toggle\">\n    <details open=\"\">\n      <summary>Tutorials</summary>\n      <ol>\n        <li><a href=\"/ja/docs/WebAssembly/Concepts\">WebAssembly concepts</a></li>\n        <li><a href=\"/ja/docs/WebAssembly/C_to_wasm\">Compiling from C/C++ to WebAssembly</a></li>\n        <li><a href=\"/ja/docs/WebAssembly/Rust_to_wasm\">Compiling from Rust to WebAssembly</a></li>\n        <li><a href=\"/ja/docs/WebAssembly/Using_the_JavaScript_API\">Using the WebAssembly JavaScript API</a></li>\n        <li><a href=\"/ja/docs/WebAssembly/Understanding_the_text_format\">Understanding WebAssembly text format</a></li>\n        <li><a href=\"/ja/docs/WebAssembly/Text_format_to_wasm\">Converting WebAssembly text format to wasm</a></li>\n        <li><a href=\"/ja/docs/WebAssembly/Loading_and_running\">Loading and running WebAssembly code</a></li>\n        <li><a href=\"/ja/docs/WebAssembly/Caching_modules\">Caching compiled WebAssembly modules</a></li>\n        <li><a href=\"/ja/docs/WebAssembly/Exported_functions\">Exported WebAssembly functions</a></li>\n      </ol>\n    </details>\n  </li>\n  <li class=\"toggle\">\n    <details open=\"\">\n      <summary>Object reference</summary>\n      <ol>\n        <li><a href=\"/ja/docs/WebAssembly/JavaScript_interface\"><code>WebAssembly</code></a></li>\n        <li><a href=\"/ja/docs/WebAssembly/JavaScript_interface/Module\"><code>WebAssembly.Module</code></a></li>\n        <li><a href=\"/ja/docs/WebAssembly/JavaScript_interface/Global\"><code>WebAssembly.Global</code></a></li>\n        <li><a href=\"/ja/docs/WebAssembly/JavaScript_interface/Instance\"><code>WebAssembly.Instance</code></a></li>\n        <li><a href=\"/ja/docs/WebAssembly/JavaScript_interface/Memory\"><code>WebAssembly.Memory</code></a></li>\n        <li><a href=\"/ja/docs/WebAssembly/JavaScript_interface/Table\"><code>WebAssembly.Table</code></a></li>\n        <li><a href=\"/ja/docs/WebAssembly/JavaScript_interface/CompileError\"><code>WebAssembly.CompileError</code></a></li>\n        <li><a href=\"/ja/docs/WebAssembly/JavaScript_interface/LinkError\"><code>WebAssembly.LinkError</code></a></li>\n        <li><a href=\"/ja/docs/WebAssembly/JavaScript_interface/RuntimeError\"><code>WebAssembly.RuntimeError</code></a></li>\n      </ol>\n    </details>\n  </li>\n</ol>\n\n","body":[{"type":"prose","value":{"id":null,"title":null,"isH3":false,"content":"<p>WebAssembly を人間が読んだり編集したりできるようにするため、 wasm バイナリー形式にはテキスト表現が存在します。これはテキストエディター、ブラウザーの開発者ツールなどで見せるために設計された中間表現です。この記事では、テキスト形式のしくみ、生の構文、および元のバイトコードの表現との関係 (と JavaScript で wasm を表現したラッパーオブジェクト) について説明します。</p>\n<div class=\"notecard note\" id=\"sect1\">\n  <p><strong>Note:</strong> この記事は、あなたがウェブ開発者で wasm モジュールをページに読み込んでコード内で使用するだけなら過剰なものかもしれません (<a href=\"/ja/docs/WebAssembly/Using_the_JavaScript_API\">WebAssembly JavaScript API の使用</a>を参照)。しかし、例えば、パフォーマンスを最適化するために wasm モジュールを書きたいときや、あなた自身で WebAssembly コンパイラーを作るときには役に立ちます。</p>\n</div>"}},{"type":"prose","value":{"id":"s_式","title":"S 式","isH3":false,"content":"<p>バイナリー、テキスト形式どちらでも、 WebAssembly の基本的なコードの単位はモジュールです。テキスト形式ではモジュールは 1 つの大きな S 式として表現されます。 S 式はツリー構造を表現するための非常に古くてシンプルなテキスト形式で、モジュールをその構造とそのコードを記述するノードツリーとして考えることができます。しかし、プログラミング言語の AST (抽象構文木) とは異なり、　WebAssembly のツリーはかなり平坦で、ほとんどは命令の列で構成されています。</p>\n<p>はじめに、 S 式がどういうものか見てみましょう。ツリー内の各ノードは <code>( ... )</code> のように 1 組の括弧内に入れられます。 括弧内の最初のラベルは、それがどのノードタイプかを示し、スペースで区切られた属性、または子ノードのリストが続きます。次のコードは WebAssembly の S 式を意味します。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>ルートノード \"module\" と 2 つの子ノード、 \"1\" を属性に持つ \"memory\" ノード、\"func\" ノードを表します。これらのノードが実際にどういう意味なのかを見ていきましょう。</p>"}},{"type":"prose","value":{"id":"最もシンプルなモジュール","title":"最もシンプルなモジュール","isH3":true,"content":"<p>最もシンプルで短い実行可能な wasm モジュールから始めてみましょう。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>このモジュールは完全に空ですが、モジュールとしては有効です。</p>\n<p>いま、このモジュールをバイナリーに変換すると (<a href=\"/ja/docs/WebAssembly/Text_format_to_wasm\">WebAssembly テキスト形式から wasm に変換する</a> を参照) 、 <a href=\"http://webassembly.org/docs/binary-encoding/#high-level-structure\" class=\"external\" rel=\" noopener\">バイナリー形式</a> で記述された 8 バイトのモジュールヘッダーだけになります。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token number\">0000000</span>: <span class=\"token number\">0061</span> 736d              ; WASM_BINARY_MAGIC\n<span class=\"token number\">0000004</span>: <span class=\"token number\">0100</span> <span class=\"token number\">0000</span>              ; WASM_BINARY_VERSION\n</code></pre></div>"}},{"type":"prose","value":{"id":"モジュールに機能を追加する","title":"モジュールに機能を追加する","isH3":true,"content":"<p>はい、これは全然面白くないですね。モジュールに実行可能なコードを追加していきましょう。</p>\n<p>すべての WebAssembly モジュール内のコードは次の疑似コード構造を持つ関数にグループ化されます:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span> <span class=\"token keyword\">func</span> &lt;signature&gt; &lt;locals&gt; &lt;body&gt; <span class=\"token punctuation\">)</span>\n</code></pre></div>\n<ul>\n  <li><strong>signature</strong> は関数が何を受け取る (引数) かと何を返す (返値) かを宣言します。</li>\n  <li><strong>locals</strong> は JavaScript でいうと変数のようなものですが、明示的な型が宣言されます。</li>\n  <li><strong>body</strong> は線形の低レベルな命令のリストです。</li>\n</ul>\n<p>S 式であるために違って見えますが、これは、他の言語の関数に似ています。</p>"}},{"type":"prose","value":{"id":"シグネチャと引数","title":"シグネチャと引数","isH3":false,"content":"<p>シグネチャは、返値の型宣言のリストが後に続く、引数の型宣言の並びです。ここで注目すべきは次の点です。</p>\n<ul>\n  <li><code>(result)</code> がない場合、その関数は何も返さないということです。</li>\n  <li>現在は、最大で 1 つの返値の型を指定することができますが、任意の数に<a href=\"https://github.com/WebAssembly/spec/blob/master/proposals/multi-value/Overview.md\" class=\"external\" rel=\" noopener\">緩和される予定</a>です。</li>\n</ul>\n<p>それぞれの引数には、明示的に型を宣言します。 wasm は現在 4 つの数値型を利用できます（さらに参照型もあります。以下の<a href=\"#%E5%8F%82%E7%85%A7%E5%9E%8B\">参照型</a>の項を参照してください）。</p>\n<ul>\n  <li><code>i32</code>: 32 ビット整数</li>\n  <li><code>i64</code>: 64 ビット整数</li>\n  <li><code>f32</code>: 32 ビット浮動小数点数</li>\n  <li><code>f64</code>: 64 ビット浮動小数点数</li>\n</ul>\n<p>単体の引数は <code>(param i32)</code> 、返値は <code>(result i32)</code> のように記述します。したがって、 2 つの 32 ビット整数を引数にとり、 64 ビット浮動小数点数を返すバイナリー関数は次のように記述します。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">)</span> ... <span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>シグネチャのあとに、型付けされたローカル変数のリストが続きます (例: <code>(local i32)</code>) 。引数は基本的に、呼び出し元から渡された対応する引数の値で初期化される単なるローカル変数です。</p>"}},{"type":"prose","value":{"id":"ローカル変数と引数を取得設定する","title":"ローカル変数と引数を取得/設定する","isH3":false,"content":"<p>ローカル変数と引数は関数本体から <code>local.get</code> と <code>local.set</code> 命令を使用して読み書きすることができます。</p>\n<p><code>local.get</code>/<code>local.get</code> コマンドは数値のインデックスから取得/設定される項目を参照します。最初に引数が宣言順に、その後に、ローカル変数が宣言順に参照されます。次の関数を見てください。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">f32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token number\">0</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token number\">1</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>命令 <code>local.get 0</code> は i32 の引数, <code>local.get 1</code> は f32 の引数、そして <code>local.get 2</code> は f64 のローカル変数を取得します。</p>\n<p>ここで別の問題があります。数値のインデックスを使用して項目を参照すると、混乱したり、困ってしまうことがあります。そこで、テキスト形式では、単純に型宣言の直前に (<code>$</code>) を接頭辞として付けた名前を、引数、ローカル変数や他の多くの項目につけることができます。</p>\n<p>したがって、上記のシグネチャを次のように書き直すことができます。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$p1</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$p2</span> <span class=\"token keyword\">f32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span> <span class=\"token variable\">$loc</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">)</span> …<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>そして、<code>local.get 0</code> の代わりに <code>local.get $p1</code> と書くことができるようになります（このテキストがバイナリーに変換されたとき、バイナリーには整数値だけが残されることに注意してください）。</p>"}},{"type":"prose","value":{"id":"スタックマシン","title":"スタックマシン","isH3":false,"content":"<p>関数本体を書く前に、もう 1 つ、<strong>スタックマシン</strong>について話をする必要があります。ブラウザーはそれを更に効率的な形にコンパイルしますが、wasm の実行はスタックマシンとして定義されます。スタックマシンの基本的な考え方は、すべての命令がスタックから特定の数の <code>i32</code>/<code>i64</code>/<code>f32</code>/<code>f64</code> 値をプッシュ、ポップするようにすることです。</p>\n<p>例えば、 <code>local.get</code> はローカル変数の値をスタックにプッシュするように定義されます。そして、<code>i32.add</code> は2つの <code>i32</code> 値 (スタックにプッシュされた前の2つの値を暗黙的に取得します) をポップし、合計を計算して (2^32 の剰余として) 結果の i32 値をプッシュします。</p>\n<p>関数が呼び出されたとき、空のスタックから開始され、徐々に積まれてゆき、本体の命令が実行されると空になります。例として、次の関数の実行後について見てみましょう。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$p</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$p</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$p</span>\n  <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>スタックには <code>i32</code> という値 1 つだけが入っています。これは式 (<code>$p + $p</code>) が <code>i32.add</code> よって処理された結果です。関数の返値はスタックに残った最後の値になります。</p>\n<p>WebAssembly のバリデーションルールはスタックが正確に一致することを保証します。もし、<code>(result f32)</code> と宣言した場合、最終的にスタックに1つだけ <code>f32</code> 値が積まれている状態である必要があります。結果の型がない場合は、スタックは空でなければなりません。</p>"}},{"type":"prose","value":{"id":"はじめての関数本体","title":"はじめての関数本体","isH3":false,"content":"<p>前述の通り、関数本体は関数が呼び出された後に続く単純な命令列です。 これまでに学んだことと共に、最終的にはシンプルな関数を含むモジュールを定義することができるようになります。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$lhs</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$rhs</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$lhs</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$rhs</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>この関数は 2 つの引数を受け取って、それらを足して、その結果を返します。</p>\n<p>関数本体に置けるものはもっとたくさんありますが、いまはシンプルなもので始めます。進むにつれてもっと多くの例を見ていきます。すべての有効なオペコードのリストについては <a href=\"https://webassembly.github.io/spec/core/exec/index.html\" class=\"external\" rel=\" noopener\">webassembly.org Semantics reference</a> を調べてみてください。</p>"}},{"type":"prose","value":{"id":"関数を呼び出す","title":"関数を呼び出す","isH3":true,"content":"<p>定義した関数は自身では大したことをしません。いまはそれを呼び出す必要があります。どのようにすればよいでしょうか。 ES2015 モジュールのように、wasm 関数はモジュール内の <code>export</code> ステートメントによって明示的にエクスポートしなければなりません。</p>\n<p>ローカル変数と同じように、関数も既定ではインデックスで識別されますが、便宜上の関数名を付けることができます。 <code>func</code> キーワードの直後にドル記号で始まる名前を付けてみましょう。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$add</span> … <span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>ここでエクスポート宣言を追加する必要があります。次のようになります。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"add\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$add</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>ここで <code>add</code> は JavaScript で認識される関数名であるのに対して、<code>$add</code> はモジュール内の、どの WebAssembly 関数をエクスポートするのかを選択します。</p>\n<p>（今のところ）最終的なモジュールは次のようになります。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$add</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$lhs</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$rhs</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$lhs</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$rhs</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"add\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$add</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>例に従うなら、上のモジュールを <code>add.wat</code> という名前で保存して、wabt を使用して（詳細は <a href=\"/ja/docs/WebAssembly/Text_format_to_wasm\">WebAssembly テキスト形式から wasm に変換する</a> を参照してください）、<code>add.wasm</code> というファイルに変換します。</p>\n<p>次に、 <code>addCode</code> という名前の型付き配列にバイナリー読み込み（<a href=\"/ja/docs/WebAssembly/Loading_and_running\">WebAssembly コードのロードと実行</a> で説明されています）、コンパイル、インスタンス化して、JavaScript で <code>add</code> 関数を実行します（<code>add()</code> はインスタンスの <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Instance/exports\"><code>exports</code></a> プロパティから見つけることができます）。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'add.wasm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// \"3\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect2\">\n  <p><strong>Note:</strong> この例は GitHub の<a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/add.html\" class=\"external\" rel=\" noopener\">add.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/add.html\" class=\"external\" rel=\" noopener\">動作例</a>) にあります。関数のインスタンス化についての詳細は <a href=\"/ja/docs/WebAssembly/JavaScript_interface/instantiateStreaming\"><code>WebAssembly.instantiateStreaming()</code></a> も合わせて参照してください。</p>\n</div>"}},{"type":"prose","value":{"id":"基礎を探る","title":"基礎を探る","isH3":false,"content":"<p>ここでは実際の基本的な例を取り上げてから、いくつかの高度な機能について見てみましょう。</p>"}},{"type":"prose","value":{"id":"同じモジュールの他の関数から関数を呼び出す","title":"同じモジュールの他の関数から関数を呼び出す","isH3":true,"content":"<p><code>call</code> 命令はインデックスか名前を指定して単一の関数を呼び出します。例えば、次のモジュールには 2 つの関数が含まれています。 1 つ目はただ 42 を返すだけ、もう 1 つは 1 つ目のものに 1 を足した値を返します。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$getAnswer</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"getAnswerPlus1\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">call</span> <span class=\"token variable\">$getAnswer</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect3\">\n  <p><strong>Note:</strong> <code>i32.const</code> は 32 ビット整数を定義してスタックにプッシュするだけです。 <code>i32</code> 以外の有効な型に変えて、 const の値を好きなものに変えることができます（ここでは <code>42</code> に設定しました）。</p>\n</div>\n<p>この例で、 <code>func</code> の直後に宣言された <code>(export \"getAnswerPlus1\")</code> セクションに気づくでしょう。これはこの関数をエクスポートするための宣言をして、さらにそれに名前をつけるために使用するショートカットです。</p>\n<p>これは、上で行ったように、モジュール内の関数外の別の場所で、関数ステートメントと分けて定義するのと同等の機能です。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"getAnswerPlus1\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$functionName</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>上のモジュールを呼び出す JavaScript コードは次のようになります。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'call.wasm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">getAnswerPlus1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// \"43\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>"}},{"type":"prose","value":{"id":"javascript_から関数をインポートする","title":"JavaScript から関数をインポートする","isH3":true,"content":"<p>すでに、JavaScript から WebAssembly 関数を呼び出すことについては確認しましたが、WebAssembly から JavaScript 関数を呼び出すことについてはどうでしょうか? WebAssembly は実際に JavaScript のビルトインの情報を持っていませんが、JavaScript か wasm 関数をインポートするための一般的な方法があります。例を見てみましょう。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"console\"</span> <span class=\"token string\">\"log\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$log</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"logIt\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">13</span>\n    <span class=\"token keyword\">call</span> <span class=\"token variable\">$log</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>WebAssembly は 2 階層の名前空間のインポート文を持っています。ここでは、<code>console</code> モジュールから <code>log</code> 関数をインポートすることを要求しています。また、エクスポートされた <code>logIt</code> 関数から、上で紹介した <code>call</code> 命令を使用して、インポートされた関数を呼ぶ出すことができます。</p>\n<p>インポートされた関数は通常の関数と同じようなものです。WebAssembly のバリデーションによって静的にチェックするシグネチャを持ち、インデックスか名前を付けて呼び出すことができます。</p>\n<p>JavaScript 関数にはシグネチャの概念がないため、インポート宣言のシグネチャに関係なく、どの JavaScript 関数も渡すことができます。モジュールがインポート宣言をすると、 <a href=\"/ja/docs/WebAssembly/JavaScript_interface/instantiate\"><code>WebAssembly.instantiate()</code></a> を呼び出す側は、対応したプロパティを持ったインポートオブジェクトを渡す必要があります。</p>\n<p>上の場合、 <code>importObject.console.log</code> が JavaScript 関数であるようなオブジェクト(<code>importObject</code> と呼びましょう) が必要になります。</p>\n<p>これは次のようになります。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">var</span> importObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">console</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">log</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nWebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'logger.wasm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importObject<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">logIt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect4\">\n  <p><strong>Note:</strong> この例は GitHub の <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/logger.html\" class=\"external\" rel=\" noopener\">logger.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/logger.html\" class=\"external\" rel=\" noopener\">動作例</a>)を参照してください。</p>\n</div>"}},{"type":"prose","value":{"id":"webassembly_でのグローバルの宣言","title":"WebAssembly でのグローバルの宣言","isH3":true,"content":"<p>WebAssembly には、 JavaScript からアクセス可能なグローバル変数インスタンスを作成する機能と、 1 つ以上の <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Module\"><code>WebAssembly.Module</code></a> インスタンスにまたがってインポート/エクスポート可能なグローバル変数インスタンスを作成する機能があります。これは、複数のモジュールを動的にリンクすることができるので、とても便利です。</p>\n<p>WebAssembly のテキスト形式では、次のようになります (GitHub のリポジトリにある <a href=\"https://github.com/mdn/webassembly-examples/blob/master/js-api-examples/global.wat\" class=\"external\" rel=\" noopener\">global.wat</a> を参照してください。JavaScript の例は <a href=\"https://mdn.github.io/webassembly-examples/js-api-examples/global.html\" class=\"external\" rel=\" noopener\">global.html</a> も参照してください)。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n   <span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span> <span class=\"token variable\">$g</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"global\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"getGlobal\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span>.get <span class=\"token variable\">$g</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"incGlobal\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span>.set <span class=\"token variable\">$g</span>\n            <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span>.get <span class=\"token variable\">$g</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>これは、キーワード <code>global</code> を使用してグローバルな値を指定していることと、値のデータ型と一緒にキーワード <code>mut</code> を指定して変更可能にしたい場合に指定していることを除いて、以前に見たものと似ています。</p>\n<p>JavaScript を使用して同等の値を作成するには、 <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Global\"><code>WebAssembly.Global()</code></a> コンストラクターを使用してください。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">const</span> global <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Global</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">value</span><span class=\"token operator\">:</span> <span class=\"token string\">\"i32\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">mutable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>"}},{"type":"prose","value":{"id":"webassembly_メモリー","title":"WebAssembly メモリー","isH3":true,"content":"<p>上の例はとてもひどいロギング関数です。たった 1 つの整数値を表示するだけです。文字列を表示するためにはどうしたらよいでしょうか? 文字列やさらに複雑なデータ型を扱うために WebAssembly は <strong>メモリー</strong> を提供します（WebAssembly のより新しい実装では、<a href=\"#%E5%8F%82%E7%85%A7%E5%9E%8B\">参照型</a>もあります）。 WebAssembly では、メモリーは徐々に拡張することのできるただの大きなバイト列です。 WebAssembly は <code>i32.load</code> や <code>i32.store</code> のような命令を持っており、それで<a href=\"http://webassembly.org/docs/semantics/#linear-memory\" class=\"external\" rel=\" noopener\">線形メモリー</a>を読み書きします。</p>\n<p>JavaScript から見ると、メモリーはすべて 1 つの大きな (リサイズ可能な) <a href=\"/ja/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer\"><code>ArrayBuffer</code></a> の内部にあるように見えます。それはまさに、asm.js とともに動かさなければならないものすべてです (ただしリサイズは出来ません。asm.js の <a href=\"http://asmjs.org/spec/latest/#programming-model\" class=\"external\" rel=\" noopener\">プログラミングモデル</a> を参照してください) 。</p>\n<p>したがって、文字列は線形メモリー内部のどこかに存在するただのバイト列です。適切なバイト列の文字列をメモリーに書き込んだとしましょう。その文字列をどのように JavaScript に渡すのでしょうか?</p>\n<p>鍵は <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Memory\"><code>WebAssembly.Memory()</code></a> インターフェースを使用して JavaScript から WebAssembly の線形メモリーを作成し、関連するインスタンスメソッドを使用して既存の Memory インスタンス (現在は 1 モジュールごとに 1 つだけ持つことができます) にアクセスできることです。Memory インスタンスは <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Memory/buffer\"><code>buffer</code></a> ゲッターを持ち、これは線形メモリー全体を指し示す ArrayBuffer を返します。</p>\n<p>Memory インスタンスは、例えば JavaScript から <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Memory/grow\"><code>Memory.grow()</code></a> メソッドを使用して拡張することもできます。拡張したとき、<code>ArrayBuffer</code> はサイズを変更することができないため、現在の <code>ArrayBuffer</code> は切り離され、新しく作成された、より大きな <code>ArrayBuffer</code> を指し示すようになります。これは、JavaScript に文字列を渡すために必要なことは、線形メモリー内での文字列のオフセットと長さを指定する方法を渡すことだけであることを意味します。</p>\n<p>文字列自身に文字列の長さの情報をエンコードするさまざまな方法 (例えば、 C 言語の文字列) がありますが、簡単にするためにここではオフセットと長さの両方を引数として渡します。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"console\"</span> <span class=\"token string\">\"log\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$log</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>JavaScript 側では、バイト列を簡単に JavaScript 文字列にデコードするために <a href=\"/ja/docs/Web/API/TextDecoder\">TextDecoder API</a> を使用することができます (ここでは <code>utf8</code> を指定していますが、他の多くのエンコーディングに対応しています) 。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span> <span class=\"token function\">consoleLogString</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">offset<span class=\"token punctuation\">,</span> length</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> bytes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>memory<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> string <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextDecoder</span><span class=\"token punctuation\">(</span><span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>最後のに欠けているのは、 <code>consoleLogString</code> が WebAssembly の <code>memory</code> にアクセスする場所です。このあたり WebAssembly は柔軟です。JavaScript から <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Memory\"><code>Memory</code></a> オブジェクトを作成して WebAssembly モジュールでメモリーをインポートするか、WebAssembly モジュールでメモリーを作成して JavaScript で使用するためにエクスポートすることができます。</p>\n<p>簡単にするために、JavaScript で作成したメモリーを WebAssembly にインポートしてみましょう。<code>import</code> ステートメントは次のようになります。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"mem\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p><code>1</code> はインポートされたメモリーに少なくとも 1 ページ分のメモリーが必要であることを示します(WebAssembly では 1 ページを 64KB と定義しています)。</p>\n<p>文字列 \"Hi\" を出力する完全なモジュールを見てみましょう。通常のコンパイルされた C のプログラムでは文字列にメモリーを割り当てる関数を呼び出しますが、ここでは独自のアセンブリーを書くだけで、すべての線形メモリーを所有しているので、 <code>data</code> セクションを使用してグローバルメモリーに文字列の内容を書きこむことができます。データセクションではインスタンス化時にオフセットを指定してバイト列の文字列を書きこむことができます。これはネイティブの実行可能形式の <code>.data</code> セクションに似ています。</p>\n<p>最終的な wasm モジュールは次のようになります。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"console\"</span> <span class=\"token string\">\"log\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$log</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"mem\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">data</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"Hi\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"writeHi\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span>  <span class=\"token comment\">;; pass offset 0 to log</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">2</span>  <span class=\"token comment\">;; pass length 2 to log</span>\n    <span class=\"token keyword\">call</span> <span class=\"token variable\">$log</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect5\">\n  <p><strong>Note:</strong> 上記の 2 重のセミコロン構文 (<code>;;</code>) は WebAssembly ファイル内でコメントを書くためのものです。</p>\n</div>\n<p>ここで、JavaScript から 1 ページ分のサイズを持つ Memory を作成してそれに渡すことができます。結果としてコンソールに \"Hi\" と出力されます。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">var</span> memory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Memory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> importObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">console</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">log</span><span class=\"token operator\">:</span> consoleLogString <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">js</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">mem</span><span class=\"token operator\">:</span> memory <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nWebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'logger2.wasm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importObject<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">writeHi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect6\">\n  <p><strong>Note:</strong> 完全なソースは GitHub の <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/logger2.html\" class=\"external\" rel=\" noopener\">logger2.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/logger2.html\" class=\"external\" rel=\" noopener\">動作例</a>) を参照してください。</p>\n</div>"}},{"type":"prose","value":{"id":"webassembly_テーブル","title":"WebAssembly テーブル","isH3":true,"content":"<p>WebAssembly テキスト形式のツアーを終了するために、 WebAssembly で最も複雑でしばしば混乱する部分 (<strong>テーブル</strong>) を見てみましょう。テーブルは基本的に WebAssembly コードからインデックスでアクセスできるリサイズ可能な参照の配列です。</p>\n<p>なぜテーブルが必要なのかを見るために、最初に観察する必要があります。さきほど見た <code>call</code> 命令 (<a href=\"#%E5%90%8C%E3%81%98%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E4%BB%96%E3%81%AE%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E9%96%A2%E6%95%B0%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99\">同じモジュールの他の関数から関数を呼び出す</a> を参照) は静的な関数インデックスをとり、結果として 1 つの関数しか呼び出せません。しかし、呼び出し先がランタイム値の場合はどうなるでしょうか。</p>\n<ul>\n  <li>JavaScript ではこれは常に見えます。関数は第一級の値です。</li>\n  <li>C/C++ では関数ポインターで見ることができます。</li>\n  <li>C++ では仮想関数で見ることができます。</li>\n</ul>\n<p>WebAssembly にはこれを実現するための一種の呼び出し命令が必要だったため、動的な関数をオペランドに受け取る <code>call_indirect</code> を与えました。問題は WebAssembly ではオペランドに指定できる型が (現在) <code>i32</code>/<code>i64</code>/<code>f32</code>/<code>f64</code> だけであることです。</p>\n<p>WebAssembly は <code>anyfunc</code> 型 (任意のシグニチャの関数を保持できるため \"any\") を追加することができましたが、あいにくセキュリティ上の理由から <code>anyfunc</code> 型は線形メモリーに格納できませんでした。線形メモリーは格納された値の生の内容をバイト列として公開し、これによって wasm コンテンツが生の関数ポインターを自由に観察できて破損させることができてしまいます。これはウェブ上では許可できません。</p>\n<p>解決方法は関数参照をテーブルに格納し、代わりにテーブルのインデックスを渡すことでした。これは単なる i32 値です。<code>call_indirect</code> のオペランドは単純に i32 のインデックス値にすることができます。</p>\n<h4 id=\"wasm_でテーブルを定義する\">wasm でテーブルを定義する</h4>\n<p>どのようにしてテーブルに wasm 関数を配置するのでしょうか。 <code>data</code> セクションを使用して線形メモリーの領域をバイト列で初期化するのと同じように、<code>elem</code> セクションを使用してテーブルの領域を関数の列で初期化することが出来ます:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">table</span> <span class=\"token number\">2</span> funcref<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">elem</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$f1</span> <span class=\"token variable\">$f2</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$f1</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$f2</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">13</span><span class=\"token punctuation\">)</span>\n  ...\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<ul>\n  <li><code>(table 2 funcref)</code> で、2 はテーブルの初期サイズ (2つの参照を格納できることを意味します) で、<code>funcref</code> はこれらの参照の要素型がの関数参照であることを宣言します。</li>\n  <li>関数 (<code>func</code>) セクションは他の宣言された wasm 関数と同様です。これらはテーブルで参照する関数です (上の例ではそれぞれは定数を返すだけです) 。セクションが宣言された順序は重要ではないことに注意してください。関数はどこででも宣言できて <code>elem</code> セクションから参照することができます。</li>\n  <li><code>elem</code> セクションはモジュール内の関数のサブセットをリスト化することができます (任意の順で並べることができ、重複を許容します) 。これは参照された順序でテーブルに参照される関数のリストです。</li>\n  <li><code>elem</code> セクション内の <code>(i32.const 0)</code> 値はオフセットです。これはセクションの先頭で宣言する必要があります。これはテーブルに関数参照を追加するインデックスの開始位置を指定します。ここでは 0 と テーブルのサイズとして 2 (上記参照) を指定していますので、2つの参照はインデックスが 0 と 1 の部分に書き込まれます。もしオフセットを 1 にして書き込みたければ、 <code>(i32.const 1)</code> と記述してテーブルのサイズを 3 にする必要があります。</li>\n</ul>\n<div class=\"notecard note\" id=\"sect7\">\n  <p><strong>Note:</strong> 初期化されていない要素はデフォルトの throw-on-call 値が与えられます。</p>\n</div>\n<p>JavaScript で同じようなテーブルのインスタンスを作成する場合、次のようになります。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// table section</span>\n  <span class=\"token keyword\">var</span> tbl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Table</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">element</span><span class=\"token operator\">:</span><span class=\"token string\">\"anyfunc\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// function sections:</span>\n  <span class=\"token keyword\">var</span> f1 <span class=\"token operator\">=</span> <span class=\"token operator\">...</span> <span class=\"token comment\">/* some imported WebAssembly function */</span>\n  <span class=\"token keyword\">var</span> f2 <span class=\"token operator\">=</span> <span class=\"token operator\">...</span> <span class=\"token comment\">/* some imported WebAssembly function */</span>\n\n  <span class=\"token comment\">// elem section</span>\n  tbl<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> f1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  tbl<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> f2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h4 id=\"テーブルを使用する\">テーブルを使用する</h4>\n<p>先に進みましょう。いま、何らかの形で使用するために必要なテーブルを定義しました。このコードのセクションで使ってみましょう。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">;; if this was f32, type checking would fail</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"callByIndex\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$i</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$i</span>\n  <span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<ul>\n  <li><code>(type $return_i32 (func (result i32)))</code> ブロックで参照名を持つ型を指定します。この型は後でテーブルの関数参照呼び出しの型チェックを行うときに使用されます。ここでは、参照が1つの <code>i32</code> を返す関数である必要があると言っています。</li>\n  <li>次に、<code>callByIndex</code> としてエクスポートされる関数を定義します。引数として1つの <code>i32</code> をとり、引数名として <code>$i</code> が指定されています。</li>\n  <li>関数内部でスタックに値を1つ追加します。値は引数 <code>$i</code> のものが渡されます。</li>\n  <li>最後に、テーブルから関数を呼び出すために <code>call_indirect</code> を使用します。これは暗黙的に <code>$i</code> の値をスタックからポップします。この結果、<code>callByIndex</code> 関数はテーブルの <code>$i</code> 番目の関数を呼び出します。</li>\n</ul>\n<p><code>call_indirect</code> の引数はコマンド呼び出しの前に置く代わりに、次のように明示的に宣言することもできます:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span>.get <span class=\"token variable\">$i</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>より高級な、JavaScript のような表現力の高い言語では、関数を含む配列 (あるいはオブジェクトかもしれません) で同じことができることが想像できますよね。擬似コードだとこれは <code>tbl[i]()</code> のようになります。</p>\n<p>型チェックの話に戻ります。WebAssembly は型チェックされていて、 <code>funcref</code> は「任意の関数シグネチャ」を意味するので、呼び出し先の (推定される) シグネチャを指定する必要があります。そのため、 <code>$return_i32</code> 型を指定することで、プログラムに関数が <code>i32</code> を返すはずだと知らせます。もし呼び出し先のシグネチャが一致しない (代わりに <code>f32</code> が返されるような) 場合は <a href=\"/ja/docs/WebAssembly/JavaScript_interface/RuntimeError\"><code>WebAssembly.RuntimeError</code></a> 例外が発生します。</p>\n<p>さて、呼び出しを行うときにどのようにテーブルに <code>call_indirect</code> をリンクさせているのでしょうか? 答えは、現在モジュールインスタンスごとに1つのテーブルしか許容されないため、<code>call_indirect</code> はそれを暗黙的に呼び出します。将来的に複数のテーブルを持てるようになったとき、以下の行のように、何らかのテーブル識別子を指定する必要があるでしょう。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token keyword\">call_indirect</span> <span class=\"token variable\">$my_spicy_table</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$i32_to_void</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>完全なモジュールは次のようになります。例は <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/wasm-table.wat\" class=\"external\" rel=\" noopener\">wasm-table.wat</a> を参照してください:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">table</span> <span class=\"token number\">2</span> funcref<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$f1</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$f2</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">13</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">elem</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$f1</span> <span class=\"token variable\">$f2</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"callByIndex\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token variable\">$i</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">local</span>.get <span class=\"token variable\">$i</span>\n    <span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$return_i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>次の JavaScript を使用してウェブページに読み込んでみましょう。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wasm-table.wasm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">callByIndex</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns 42</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">callByIndex</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns 13</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">callByIndex</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns an error, because there is no index position 2 in the table</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"notecard note\" id=\"sect8\">\n  <p><strong>Note:</strong> 例は GitHub の <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/wasm-table.html\" class=\"external\" rel=\" noopener\">wasm-table.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/wasm-table.html\" class=\"external\" rel=\" noopener\">動作例</a>) を参照してください。</p>\n</div>\n<div class=\"notecard note\" id=\"sect9\">\n  <p><strong>Note:</strong> Memory と同じように Table も JavaScript から作成すること (<a href=\"/ja/docs/WebAssembly/JavaScript_interface/Table\"><code>WebAssembly.Table()</code></a> を参照) 、別の wasm モジュール間でインポートすることができます。</p>\n</div>"}},{"type":"prose","value":{"id":"テーブルの変更と動的リンク","title":"テーブルの変更と動的リンク","isH3":true,"content":"<p>JavaScript は関数参照にフルアクセスできるため、 Table オブジェクトは JavaScript から <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Table/grow\"><code>grow()</code></a>, <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Table/get\"><code>get()</code></a>, <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Table/set\"><code>set()</code></a> メソッドを使用して変更することができます。また、 WebAssembly のコード自体も、<a href=\"#%E5%8F%82%E7%85%A7%E5%9E%8B\">参照型</a>の一部として追加された <code>table.get</code> や <code>table.set</code> などの命令を使ってテーブルを操作することが可能です。</p>\n<p>テーブルは変更可能であるため、高度な読み込み時および実行時の<a href=\"https://webassembly.org/docs/dynamic-linking\" class=\"external\" rel=\" noopener\">動的リンクスキーム</a>の実装に使用することができます。プログラムが動的にリンクされたとき、複数のインスタンスで同じメモリーとテーブルを共有することができます。これは複数のコンパイル済み <code>.dll</code> が単一のプロセスのアドレス空間を共有するネイティブアプリケーションと対称的です。</p>\n<p>この動作を確認するために、Memory オブジェクトと Table オブジェクトを含む単一のインポートオブジェクトを作成し、同じインポートオブジェクトを複数の <a href=\"/ja/docs/WebAssembly/JavaScript_interface/instantiate\"><code>instantiate()</code></a> の呼び出しで渡してみましょう。</p>\n<p><code>.wat</code> ファイルの例は次のようになります。</p>\n<p><code>shared0.wat</code>:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"memory\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"table\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">table</span> <span class=\"token number\">1</span> funcref<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">elem</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$shared0func</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$shared0func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>load</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p><code>shared1.wat</code>:</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"memory\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span> <span class=\"token string\">\"js\"</span> <span class=\"token string\">\"table\"</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">table</span> <span class=\"token number\">1</span> funcref<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$void_to_i32</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"doIt\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>store</span>  <span class=\"token comment\">;; store 42 at address 0</span>\n   <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span>\n   <span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$void_to_i32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>これらは次のように動作します。</p>\n<ol>\n  <li>関数 <code>shared0func</code> は <code>shared0.wat</code> で定義され、インポートされたテーブルに格納されます。</li>\n  <li>この関数は定数値 <code>0</code> を作成して、次に <code>i32.load</code> コマンドを使用して指定したメモリーのインデックスから値をロードします。そのインデックスは <code>0</code> になります 。先と同様に、前の値をスタックから暗黙的にポップします。つまり、<code>shared0func</code> はメモリーのインデックス <code>0</code> の位置に格納された値をロードして返します。</li>\n  <li><code>shared1.wat</code> では、 <code>doIt</code> という関数をエクスポートします。この関数は2つの定数値 <code>0</code> と <code>42</code> を作成して <code>i32.store</code> を呼び出して、インポートされたメモリーの指定したインデックスに指定した値を格納します。ここでも、これらの値はスタックから暗黙的にポップされます。したがって、結果的にメモリーのインデックスが <code>0</code> の位置に、値として <code>42</code> が格納されます。</li>\n  <li>関数の最後では、定数値 <code>0</code> を作成し、テーブルのインデックスが 0 の位置にある関数を呼び出します。これは <code>shared0func</code> で、先に <code>shared0.wat</code> の <code>elem</code> ブロックで格納されたものです。</li>\n  <li>呼び出されたとき、<code>shared0func</code> は <code>shared1.wat</code> 内で <code>i32.store</code> コマンドを使用してメモリーに格納された 42 をロードします。</li>\n</ol>\n<div class=\"notecard note\" id=\"sect10\">\n  <p><strong>Note:</strong> 上の式はスタックから値を暗黙的にポップしますが、代わりにコマンド呼び出しの中で明示的に宣言することができます。</p>\n  <div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>store</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">call_indirect</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token variable\">$void_to_i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n</div>\n<p>アセンブリーに変換した後、次のコードで JavaScript 内で <code>shared0.wasm</code> と <code>shared1.wasm</code> を使用します:</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">var</span> importObj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">js</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">memory</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Memory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">table</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Table</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">element</span><span class=\"token operator\">:</span> <span class=\"token string\">\"anyfunc\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'shared0.wasm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiateStreaming</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'shared1.wasm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> importObj<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">results</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function\">doIt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// prints 42</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>コンパイルされた各モジュールは同じメモリーとテーブルオブジェクトをインポートし、その結果同じ線形メモリーとテーブルの「アドレス空間」を共有することができます。</p>\n<div class=\"notecard note\" id=\"sect11\">\n  <p><strong>Note:</strong> 例は GitHub の <a href=\"https://github.com/mdn/webassembly-examples/blob/master/understanding-text-format/shared-address-space.html\" class=\"external\" rel=\" noopener\">shared-address-space.html</a> (<a href=\"https://mdn.github.io/webassembly-examples/understanding-text-format/shared-address-space.html\" class=\"external\" rel=\" noopener\">動作例</a>) を参照してください。</p>\n</div>"}},{"type":"prose","value":{"id":"大規模メモリー操作","title":"大規模メモリー操作","isH3":false,"content":"<p>大規模メモリー操作は、言語へ新しく追加されたものです（例えば <a href=\"/ja/docs/Mozilla/Firefox/Releases/79\">Firefox 79</a>）。コピーや初期化などのバルクメモリ操作のために 7 つの新しい組み込み操作が提供されており、 WebAssembly が <code>memcpy</code> や <code>memmove</code> などのネイティブ関数を、より効率的でパフォーマンスの高い方法でモデル化できるようにします。</p>\n<p>新しい操作は次の通りです。</p>\n<ul>\n  <li><code>data.drop</code>: データセグメント内のデータを無効にします。</li>\n  <li><code>elem.drop</code>: 要素セグメント内のデータを無効にします。</li>\n  <li><code>memory.copy</code>: 線形メモリーの一範囲を他へコピーします。</li>\n  <li><code>memory.fill</code>: 線形メモリーの一範囲を指定した値で埋めます。</li>\n  <li><code>memory.init</code>: データセグメントから範囲をコピーします。</li>\n  <li><code>table.copy</code>: テーブルの一範囲から他へコピーします。</li>\n  <li><code>table.init</code>: 要素セグメントから範囲をコピーします。</li>\n</ul>\n<div class=\"notecard note\" id=\"sect12\">\n  <p><strong>Note:</strong> 詳しい情報は <a href=\"https://github.com/WebAssembly/bulk-memory-operations/blob/master/proposals/bulk-memory-operations/Overview.md\" class=\"external\" rel=\" noopener\">Bulk Memory Operations and Conditional Segment Initialization</a> の提案にあります。</p>\n</div>"}},{"type":"prose","value":{"id":"参照型","title":"参照型","isH3":false,"content":"<p><a href=\"https://github.com/WebAssembly/reference-types/blob/master/proposals/reference-types/Overview.md\" class=\"external\" rel=\" noopener\">参照型の提案</a> (<a href=\"/ja/docs/Mozilla/Firefox/Releases/79\">Firefox 79</a> で対応) では、主に 2 つのことを提供しています。</p>\n<ul>\n  <li>新しい型である <code>externref</code> は、文字列、DOM 参照、オブジェクトなど、あらゆる JavaScript の値を保持することができます。 WebAssembly の観点からは <code>externref</code> は不透明です。wasm モジュールはこれらの値にアクセスして操作することができず、代わりに値を受け取って送り返すことだけができます。しかし、これは wasm モジュールが JavaScript の関数や DOM API などを呼び出したり、ホスト環境との相互運用を容易にするために非常に有用です。<code>externref</code> は値型とテーブル要素に使用することができます。</li>\n  <li>JavaScript API 経由ではなく、wasm モジュールが直接 <a href=\"#webassembly_%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB\">WebAssembly テーブル</a>を操作できるようにするための新しい命令がいくつか追加されました。</li>\n</ul>\n<div class=\"notecard note\" id=\"sect13\">\n  <p><strong>Note:</strong> <a href=\"https://rustwasm.github.io/docs/wasm-bindgen/\" class=\"external\" rel=\" noopener\">wasm-bindgen</a> のドキュメントには、 <code>externref</code> を Rust で利用する方法について、いくつかの有用な情報が含まれています。</p>\n</div>"}},{"type":"prose","value":{"id":"webassembly_の複数値","title":"WebAssembly の複数値","isH3":false,"content":"<p>もっと最近になって (例えば <a href=\"/ja/docs/Mozilla/Firefox/Releases/78\">Firefox 78</a>) 言語に追加されたものが WebAssembly 複数値です。これは、WebAssembly 関数が複数の値を返すことができるようになり、一連の命令が複数のスタック値を消費して生成することができるようになったことを意味します。</p>\n<p>執筆時点 (2020 年 6 月) において、これは初期段階であり、利用可能な多値命令は、それ自体が複数の値を返す関数の呼び出しのみです。例を示します。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$get_two_numbers</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>const</span> <span class=\"token number\">2</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">export</span> <span class=\"token string\">\"add_two_numbers\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">call</span> <span class=\"token variable\">$get_two_numbers</span>\n    <span class=\"token keyword\">i32<span class=\"token punctuation\">.</span>add</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>しかし、これはより有用な命令タイプやその他のものへの道を開くことになるでしょう。これまでの進捗状況や、これがどのように動作するかについては、 Nick Fitzgerald の <a href=\"https://hacks.mozilla.org/2019/11/multi-value-all-the-wasm/\" class=\"external\" rel=\" noopener\">Multi-Value All The Wasm!</a> を参照してください。</p>"}},{"type":"prose","value":{"id":"webassembly_スレッド","title":"WebAssembly スレッド","isH3":false,"content":"<p>WebAssembly スレッド (<a href=\"/ja/docs/Mozilla/Firefox/Releases/79\">Firefox 79</a> 以降で対応) は、 WebAssembly Memory オブジェクトを別なウェブワーカー内で動作している複数の WebAssembly インスタンスで共有できるものであり、 JavaScript の <a href=\"/ja/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer\"><code>SharedArrayBuffer</code></a> と似たような形のものです。これにより、ワーカー間の非常に高速な通信が可能になり、ウェブアプリケーションのパフォーマンスが大幅に向上します。</p>\n<p>スレッドの提案は、共有メモリーと不可分メモリーアクセスの 2 つの部分からなります。</p>"}},{"type":"prose","value":{"id":"共有メモリー","title":"共有メモリー","isH3":true,"content":"<p>上記のように、共有の WebAssembly <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Memory\"><code>Memory</code></a> オブジェクトを作成することが可能です。これは、 <a href=\"/ja/docs/Web/API/Window/postMessage\"><code>postMessage()</code></a> を使用してウィンドウとワーカーのコンテキスト間で、 <a href=\"/ja/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer\"><code>SharedArrayBuffer</code></a> と同じ方法で転送されるものです。</p>\n<p>JavaScript API 側では、<a href=\"/ja/docs/WebAssembly/JavaScript_interface/Memory\"><code>WebAssembly.Memory()</code></a> コンストラクタの初期化オブジェクトに <code>shared</code> プロパティを追加し、 <code>true</code> に設定すると共有メモリを作成するようになりました。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code><span class=\"token keyword\">let</span> memory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAssembly<span class=\"token punctuation\">.</span>Memory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">initial</span><span class=\"token operator\">:</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">maximum</span><span class=\"token operator\">:</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">shared</span><span class=\"token operator\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>メモリーの <a href=\"/ja/docs/WebAssembly/JavaScript_interface/Memory/buffer\"><code>buffer</code></a> プロパティは <code>SharedArrayBuffer</code> を返すようになり、普通の <code>ArrayBuffer</code> ではなくなりました。</p>\n<div class=\"code-example\"><pre class=\"brush: js notranslate\"><code>memory<span class=\"token punctuation\">.</span>buffer <span class=\"token comment\">// returns SharedArrayBuffer</span>\n</code></pre></div>\n<p>テキスト形式の上では、 <code>shared</code> キーワードを使って、次のように共有メモリーを作成することができます。</p>\n<div class=\"code-example\"><pre class=\"brush: wasm notranslate\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">memory</span> <span class=\"token number\">1</span> <span class=\"token number\">2</span> shared<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>共有されていないメモリーと異なり、共有メモリーは JavaScript API のコンストラクターと wasm のテキスト形式の両方で「最大」サイズを指定する必要があります。</p>\n<div class=\"notecard note\" id=\"sect14\">\n  <p><strong>Note:</strong> 詳しくは、 <a href=\"https://github.com/WebAssembly/threads/blob/master/proposals/threads/Overview.md\" class=\"external\" rel=\" noopener\">WebAssembly のスレッド提案</a>にたくさん載っています。</p>\n</div>"}},{"type":"prose","value":{"id":"不可分メモリーアクセス","title":"不可分メモリーアクセス","isH3":true,"content":"<p>ミューテックスや条件変数など、より高度な機能を実装するために使用できる新しい wasm 命令が多数追加されました。<a href=\"https://github.com/WebAssembly/threads/blob/master/proposals/threads/Overview.md#atomic-memory-accesses\" class=\"external\" rel=\" noopener\">ここにリストアップされています</a>。これらの命令は、 Firefox 80 の時点で共有でないメモリー上で許可されています。</p>\n<div class=\"notecard note\" id=\"sect15\">\n  <p><strong>Note:</strong> <a href=\"https://emscripten.org/docs/porting/pthreads.html\" class=\"external\" rel=\" noopener\">Emscripten Pthreads support page</a> で、 Emscripten の新機能を利用する方法を紹介しています。</p>\n</div>"}},{"type":"prose","value":{"id":"まとめ","title":"まとめ","isH3":false,"content":"<p>これで、WebAssembly テキスト形式の主要コンポーネントとそれらが WebAssembly JS API にどのように反映されるのかの高レベルなツアーが完了しました。</p>"}},{"type":"prose","value":{"id":"関連情報","title":"関連情報","isH3":false,"content":"<ul>\n  <li>この記事に含まれなかった主なものは、関数本体で現れるすべての命令の包括的なリストです。各命令の処理は <a href=\"http://webassembly.org/docs/semantics\" class=\"external\" rel=\" noopener\">WebAssembly のセマンティックス</a> を参照してください。</li>\n  <li>スペックインタプリターによって実装された<a href=\"https://github.com/WebAssembly/spec/blob/master/interpreter/README.md#s-expression-syntax\" class=\"external\" rel=\" noopener\">テキスト形式の文法</a>も参照してください。</li>\n</ul>"}}],"toc":[{"text":"S 式","id":"s_式"},{"text":"シグネチャと引数","id":"シグネチャと引数"},{"text":"ローカル変数と引数を取得/設定する","id":"ローカル変数と引数を取得設定する"},{"text":"スタックマシン","id":"スタックマシン"},{"text":"はじめての関数本体","id":"はじめての関数本体"},{"text":"基礎を探る","id":"基礎を探る"},{"text":"大規模メモリー操作","id":"大規模メモリー操作"},{"text":"参照型","id":"参照型"},{"text":"WebAssembly の複数値","id":"webassembly_の複数値"},{"text":"WebAssembly スレッド","id":"webassembly_スレッド"},{"text":"まとめ","id":"まとめ"},{"text":"関連情報","id":"関連情報"}],"summary":"WebAssembly を人間が読んだり編集したりできるようにするため、 wasm バイナリー形式にはテキスト表現が存在します。これはテキストエディター、ブラウザーの開発者ツールなどで見せるために設計された中間表現です。この記事では、テキスト形式のしくみ、生の構文、および元のバイトコードの表現との関係 (と JavaScript で wasm を表現したラッパーオブジェクト) について説明します。","popularity":0.0002,"modified":"2022-10-01T03:41:16.000Z","other_translations":[{"title":"Understanding WebAssembly text format","locale":"en-US","native":"English (US)"},{"title":"Understanding WebAssembly text format","locale":"ko","native":"한국어"},{"title":"Entendendo o formato textual do WebAssembly","locale":"pt-BR","native":"Português (do Brasil)"},{"title":"Описание текстового формата WebAssembly","locale":"ru","native":"Русский"},{"title":"理解 WebAssembly 文本格式","locale":"zh-CN","native":"中文 (简体)"}],"source":{"folder":"ja/webassembly/understanding_the_text_format","github_url":"https://github.com/mdn/translated-content/blob/main/files/ja/webassembly/understanding_the_text_format/index.md","last_commit_url":"https://github.com/mdn/translated-content/commit/921c46a374ab0a9f4cc809af0370f8c412e54701","filename":"index.md"},"parents":[{"uri":"/ja/docs/WebAssembly","title":"WebAssembly"},{"uri":"/ja/docs/WebAssembly/Understanding_the_text_format","title":"WebAssembly テキスト形式の理解"}],"pageTitle":"WebAssembly テキスト形式の理解 - WebAssembly | MDN","noIndexing":false}}</script></body></html>